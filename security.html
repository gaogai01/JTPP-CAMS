<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›»å» è­¦è¡›ç›£æ§å„€è¡¨æ¿</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #1e1e2f; color: #fff; margin: 0; }
    
    /* é ‚éƒ¨æ•¸æ“šåˆ— */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444; }
    .title { font-size: 24px; font-weight: bold; color: #4facfe; }
    .clock { font-size: 20px; font-family: monospace; color: #ffeb3b; }
    
    .stats-bar { display: flex; gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #27293d; padding: 15px 25px; border-radius: 8px; flex: 1; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .stat-num { font-size: 32px; font-weight: bold; display: block; }
    .stat-label { font-size: 14px; color: #aaa; }
    .c-green { color: #00f2c3; }
    .c-red { color: #fd5d93; }
    .c-gray { color: #aab; }

    /* ç¶²æ ¼ä½ˆå±€ */
    .grid-container { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
    
    /* å·¦å´ï¼šå…¬å¸å¡ç‰‡å€ */
    .company-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    .company-card { background: #27293d; border-radius: 8px; overflow: hidden; border-top: 4px solid #1d8cf8; }
    .card-header { background: #32325d; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
    .card-count { background: #1d8cf8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
    
    .worker-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
    .worker-item { padding: 10px 15px; border-bottom: 1px solid #3b3b52; display: flex; justify-content: space-between; align-items: center; }
    .worker-item:last-child { border-bottom: none; }
    
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .dot-green { background: #00f2c3; box-shadow: 0 0 5px #00f2c3; }
    .dot-red { background: #fd5d93; box-shadow: 0 0 8px #fd5d93; animation: blink 1s infinite; }
    
    /* å³å´ï¼šæœªåˆ°äººå“¡ */
    .sidebar { background: #27293d; border-radius: 8px; padding: 15px; height: fit-content; }
    .sidebar h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; color: #aab; }
    .absent-list { font-size: 13px; color: #888; }
    .absent-item { padding: 5px 0; border-bottom: 1px solid #333; }

    @keyframes blink { 50% { opacity: 0.5; } }
    
    /* è­¦å‘Šæ¨£å¼ (è¶…éæ™‚é–“é‚„åœ¨å» å…§) */
    .warning-text { color: #fd5d93; font-weight: bold; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="header">
  <div class="title">ğŸ›¡ï¸ å» å€äººå“¡å³æ™‚ç›£æ§</div>
  <div class="clock" id="clock">Loading...</div>
</div>

<div class="stats-bar">
  <div class="stat-card">
    <span class="stat-num c-green" id="count-onsite">0</span>
    <span class="stat-label">ç›®å‰å» å…§äººæ•¸</span>
  </div>
  <div class="stat-card">
    <span class="stat-num c-red" id="count-warning">0</span>
    <span class="stat-label">æ»¯ç•™ / åŠ ç­ä¸­</span>
  </div>
  <div class="stat-card">
    <span class="stat-num c-gray" id="count-absent">0</span>
    <span class="stat-label">ä»Šæ—¥æœªé€²å» </span>
  </div>
</div>

<div class="grid-container">
  <div id="main-panel">
    <h3 style="color:#aaa; margin-top:0;">ğŸ¢ å„æ‰¿åŒ…å•†åœ¨å» ç‹€æ³</h3>
    <div id="company-container" class="company-grid">
      <p>è®€å–ä¸­...</p>
    </div>
  </div>

  <div class="sidebar">
    <h3>ğŸ˜´ ä»Šæ—¥æœªé€²å» äººå“¡</h3>
    <div id="absent-container" class="absent-list">
      </div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… è«‹å¡«å…¥ä½ çš„ Firebase Config â˜…â˜…â˜…
  const firebaseConfig = {
  apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
  authDomain: "tpc-monitor.firebaseapp.com",
  projectId: "tpc-monitor",
  storageBucket: "tpc-monitor.firebasestorage.app",
  messagingSenderId: "1066125366380",
  appId: "1:1066125366380:web:836d5898c051226669f449"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // è¨­å®šä¸‹ç­è­¦æˆ’æ™‚é–“ (24å°æ™‚åˆ¶)
  const WARNING_HOUR = 16;
  const WARNING_MINUTE = 30;

  // 1. å…¨åŸŸè®Šæ•¸
  let allUsers = {}; // { email: {name, company} }
  let todayRecords = []; // ä»Šæ—¥æ‰€æœ‰æ‰“å¡ç´€éŒ„

  // 2. åˆå§‹åŒ–
  async function init() {
    startClock();
    await loadAllUsers(); // å…ˆè¼‰å…¥æ‰€æœ‰äººåå–®
    startListening();     // é–‹å§‹ç›£è½æ‰“å¡ç´€éŒ„
  }

  // 3. è®€å–æ‰€æœ‰å“¡å·¥ (ç‚ºäº†è¨ˆç®—èª°æ²’ä¾†)
  async function loadAllUsers() {
    const snap = await db.collection('cams_users').get();
    snap.forEach(doc => {
        const d = doc.data();
        if(d.role === 'å¤–åŒ…å“¡å·¥' || d.role === 'å¤–åŒ…é ˜ç­' || d.role === 'å¤–åŒ…è€é—†') {
            allUsers[d.email] = { name: d.name, company: d.company || "æœªåˆ†é¡" };
        }
    });
  }

  // 4. å³æ™‚ç›£è½ä»Šæ—¥æ‰“å¡ç´€éŒ„ (Real-time)
  function startListening() {
    const todayStart = new Date();
    todayStart.setHours(0,0,0,0);

    db.collection('cams_records')
      .where('time', '>=', todayStart)
      .orderBy('time', 'asc')
      .onSnapshot(snapshot => {
          let userStatusMap = {}; // ç´€éŒ„æ¯å€‹äººæœ€å¾Œçš„ç‹€æ…‹

          snapshot.forEach(doc => {
              const d = doc.data();
              // ç”¨ Email ç•¶ Keyï¼Œè¨˜éŒ„æœ€å¾Œä¸€ç­†ç‹€æ…‹
              userStatusMap[d.email] = {
                  name: d.name,
                  company: d.company,
                  status: d.type, // "ä¸Šç­" æˆ– "ä¸‹ç­"
                  lastTime: d.time.toDate(),
                  gpsLink: `https://www.google.com/maps?q=${d.lat},${d.lng}`
              };
          });

          renderDashboard(userStatusMap);
      });
  }

  // 5. æ¸²æŸ“ç•«é¢æ ¸å¿ƒé‚è¼¯
  function renderDashboard(statusMap) {
    const companyGroups = {};
    const absentList = [];
    const now = new Date();
    const isLate = (now.getHours() > WARNING_HOUR) || (now.getHours() === WARNING_HOUR && now.getMinutes() >= WARNING_MINUTE);

    let totalOnSite = 0;
    let totalWarning = 0;

    // A. è™•ç†åœ¨å» èˆ‡ä¸åœ¨å» 
    // éæ­·æ‰€æœ‰è¨»å†Šå“¡å·¥
    Object.keys(allUsers).forEach(email => {
        const userRec = statusMap[email];
        
        if (userRec && userRec.status === "ä¸Šç­") {
            // ç›®å‰åœ¨å» å…§
            const comp = userRec.company;
            if (!companyGroups[comp]) companyGroups[comp] = [];
            
            // åˆ¤æ–·æ˜¯å¦æ»¯ç•™
            let isWarning = isLate; 
            if(isWarning) totalWarning++;
            
            companyGroups[comp].push({
                name: userRec.name,
                time: userRec.lastTime,
                isWarning: isWarning
            });
            totalOnSite++;
        } else {
            // ä»Šæ—¥æ²’ç´€éŒ„ æˆ– æœ€å¾Œæ˜¯ä¸‹ç­ -> è¦–ç‚ºä¸åœ¨å» 
            // ä½†æˆ‘å€‘è¦åˆ—å‡ºã€Œå®Œå…¨æ²’ä¾†ã€çš„ (æ²’æœ‰ä»»ä½•ç´€éŒ„)
            if (!userRec) {
                absentList.push(`${allUsers[email].name} <span style="color:#666">(${allUsers[email].company})</span>`);
            }
        }
    });

    // B. æ›´æ–°æ•¸å­—
    document.getElementById('count-onsite').innerText = totalOnSite;
    document.getElementById('count-warning').innerText = totalWarning;
    document.getElementById('count-absent').innerText = absentList.length;

    // C. ç¹ªè£½å…¬å¸å¡ç‰‡
    const container = document.getElementById('company-container');
    container.innerHTML = "";

    // ä¾å…¬å¸å»ºç«‹å¡ç‰‡
    Object.keys(companyGroups).forEach(comp => {
        const workers = companyGroups[comp];
        let workerHtml = "";
        
        workers.forEach(w => {
            const timeStr = w.time.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
            const dotClass = w.isWarning ? "dot-red" : "dot-green";
            const textClass = w.isWarning ? "warning-text" : "";
            const statusText = w.isWarning ? "æ»¯ç•™ä¸­" : "æ–½å·¥ä¸­";
            
            workerHtml += `
              <li class="worker-item">
                <div>
                    <span class="status-dot ${dotClass}"></span>
                    <span class="${textClass}">${w.name}</span>
                </div>
                <div style="text-align:right; font-size:12px; color:#aaa;">
                    ${statusText}<br>${timeStr} é€²å» 
                </div>
              </li>`;
        });

        const card = `
          <div class="company-card">
            <div class="card-header">
                <span>${comp}</span>
                <span class="card-count">${workers.length} äºº</span>
            </div>
            <ul class="worker-list">
                ${workerHtml}
            </ul>
          </div>`;
        container.innerHTML += card;
    });

    if(Object.keys(companyGroups).length === 0) {
        container.innerHTML = "<p style='color:#666; width:100%; text-align:center;'>ç›®å‰å» å…§ç„¡æ‰¿æ”¬å•†äººå“¡</p>";
    }

    // D. ç¹ªè£½æœªåˆ°åå–®
    const absentDiv = document.getElementById('absent-container');
    absentDiv.innerHTML = absentList.length > 0 ? 
        absentList.map(u => `<div class="absent-item">${u}</div>`).join('') : 
        "å…¨å“¡å·²é€²å» ";
  }

  // æ™‚é˜
  function startClock() {
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleString('zh-TW');
    }, 1000);
  }

  // å•Ÿå‹•
  init();

</script>
</body>
</html>
