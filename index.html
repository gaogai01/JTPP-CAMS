<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f4f7f6; margin: 0; color: #333; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
    .hidden { display: none !important; }
    
    /* --- è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• --- */
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fff; }
    label { font-weight: 600; display: block; margin-bottom: 6px; color: #555; font-size: 14px; }
    
    button { padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button:active { transform: scale(0.98); }

    /* æŒ‰éˆ•é¡è‰²ç³»çµ± */
    .btn-in { background: linear-gradient(135deg, #3b82f6, #2563eb); } 
    .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .btn-leave { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-search { background: #64748b; margin-top: 0; } 
    .btn-fix { background: #4b5563; }
    .btn-edit { background: #94a3b8; font-size: 12px; padding: 6px 12px; width: auto; margin-left: auto; border-radius: 20px; }
    
    /* --- ä½¿ç”¨è€…è³‡è¨Šå¡ --- */
    #user-info { display: flex; align-items: center; background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    #user-info img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: 800; font-size: 18px; color: #1e293b; }
    .user-meta { font-size: 13px; color: #64748b; margin-top: 2px; }

    /* --- é¸å–® Tabs --- */
    .tabs { 
        display: flex; margin-bottom: 20px; 
        background: white; border-radius: 12px; padding: 5px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
    }
    .tab { 
        flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #64748b; 
        font-weight: bold; font-size: 14px; border-radius: 8px; transition: 0.3s;
    }
    .tab.active { background: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(59,130,246,0.3); }

    /* --- GPS å¡ç‰‡ --- */
    .gps-box {
        text-align: center; padding: 20px; border-radius: 12px; background: #f8fafc;
        margin-bottom: 20px; border: 1px solid #e2e8f0; transition: all 0.3s ease;
    }
    .gps-icon { font-size: 40px; display: block; margin-bottom: 8px; }
    .gps-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 4px; }
    .gps-desc { font-size: 13px; color: #666; }
    .gps-status-ok { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    .gps-status-ok .gps-title { color: #15803d; }
    .gps-status-err { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
    .gps-status-err .gps-title { color: #b91c1c; }
    
    .pulse-container { height: 30px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .pulse-dot { width: 15px; height: 15px; background: #3b82f6; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse {
        0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }

    /* --- ç´€éŒ„æŸ¥è©¢ç¾åŒ– (Card Style) --- */
    .search-box { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .date-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .date-row input { margin-bottom: 0; }
    
    .history-card {
        background: white; border: 1px solid #f1f5f9; border-radius: 10px; padding: 15px; 
        margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s;
    }
    .h-left { display: flex; flex-direction: column; }
    .h-type { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 4px; }
    .h-time { font-size: 13px; color: #64748b; }
    .h-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .badge-normal { background: #f0fdf4; color: #166534; }
    .badge-warn { background: #fef2f2; color: #b91c1c; }
    .badge-info { background: #eff6ff; color: #1e40af; }

    /* --- é¤˜é¡é¡¯ç¤ºå€å¡Š --- */
    .balance-box {
        background: #fffbeb; color: #92400e; padding: 15px; border-radius: 10px; 
        margin-bottom: 15px; border: 1px solid #fcd34d; display: none; /* é è¨­éš±è— */
        justify-content: space-between; align-items: center;
    }
    .balance-val { font-weight: bold; font-size: 18px; }

    /* æ™‚é–“è¨ˆç®—æç¤º */
    .calc-hint { text-align: right; font-size: 14px; color: #2563eb; margin-bottom: 10px; font-weight: bold; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>
  
  <div id="login-section" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹è³‡æ–™</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #f8fafc; padding: 20px; margin-bottom: 20px; border-radius:12px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0; color:#333;">ğŸ‘¤ å€‹äººæª”æ¡ˆ</h4>
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        
        <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
        <p style="font-size:12px; color:red;">* ä»¥ä¸‹æ¬„ä½è«‹è¯ç¹«ç®¡ç†å“¡ä¿®æ”¹</p>
        
        <label>æ‰€å±¬ç¾¤çµ„ (å½±éŸ¿ä¸‹ç­æ™‚é–“)</label>
        <select id="workShift" disabled style="background:#eee;">
            <option value="">è«‹é¸æ“‡</option>
            <option value="maintenance">ç¶­è­·è¡Œæ”¿ç¾¤ (08:00~16:30, ä¼‘0.5h)</option>
            <option value="cleaning">æ¸…æ½”ç¾¤ (08:00~17:00, ä¼‘1.0h)</option>
        </select>

        <label>åˆ°è·æ—¥</label><input type="date" id="onboardDate" disabled style="background:#eee;">
        
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è®Šæ›´</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">å¾…è¾¦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div class="pulse-container" id="gps-loading"><div class="pulse-dot"></div></div>
            <div id="gps-icon" class="gps-icon hidden"></div>
            <div class="gps-title" id="gps-title">å®šä½ä¸­...</div>
            <div class="gps-desc" id="gps-desc">è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®æ¬Šé™</div>
        </div>

        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><small>08:00 (å½ˆæ€§15åˆ†)</small></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">å¤–å‡º/å…¬å‹™</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><small>è¦–ç¾¤çµ„è¨ˆç®—</small></button>
            <button class="btn-leave" onclick="doClock('è¿”å›')">è¿”å›/éŠ·å‡</button>
        </div>
        
        <button class="btn-fix" onclick="toggleFix()" style="margin-top:20px;">ğŸ› ï¸ ç”³è«‹è£œåˆ·å¡ (å¿˜è¨˜æ‰“å¡)</button>
        <div id="fix-form" class="hidden" style="margin-top:10px; background:#f1f5f9; padding:15px; border-radius:10px;">
            <label>é¡å‹</label><select id="fixType"><option>ä¸Šç­</option><option>ä¸‹ç­</option></select>
            <label>æ—¥æœŸ</label><input type="date" id="fixDate">
            <label>æ™‚é–“</label><input type="time" id="fixTime">
            <label>äº‹ç”±</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">é€å‡ºç”³è«‹</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <div class="balance-box" id="balance-display-box">
            <span id="balance-label">ç‰¹ä¼‘é¤˜é¡</span>
            <span>å‰©é¤˜ <span class="balance-val" id="balance-val">0</span> å¤©</span>
        </div>
        
        <label>å‡åˆ¥</label>
        <select id="leaveType" onchange="updateBalanceDisplay()">
            <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
            <option value="è£œä¼‘">è£œä¼‘</option>
            <option value="äº‹å‡">äº‹å‡</option>
            <option value="ç—…å‡">ç—…å‡</option>
        </select>
        
        <label>ä»£ç†äºº</label><select id="agentSelect"></select>
        
        <label>è«‹å‡æœŸé–“</label>
        <div style="display:flex; gap:5px; align-items:center;">
            <input type="datetime-local" id="l-start">
            <span>è‡³</span>
            <input type="datetime-local" id="l-end">
        </div>
        <div class="calc-hint" id="calc-result">åˆè¨ˆï¼š0 å°æ™‚</div>

        <button class="btn-leave" onclick="submitApp('leave')">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-history" class="hidden">
        <div class="search-box">
            <label>æŸ¥è©¢æœŸé–“</label>
            <div class="date-row">
                <input type="date" id="history-start">
                <span>~</span>
                <input type="date" id="history-end">
            </div>
            <button class="btn-search" onclick="loadHistory()">ğŸ” æŸ¥è©¢ç´€éŒ„</button>
        </div>
        
        <h4 style="margin:10px 0; color:#64748b; font-size:14px;">è¿‘æœŸæ‰“å¡èˆ‡ç”³è«‹</h4>
        <div id="history-list"></div>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%">ğŸ”„ åˆ·æ–°</button>
        <div id="ot-list-container"></div>
        <div id="review-list-container"></div>
    </div>
  </div>
</div>

<script>
  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // é›»å» åº§æ¨™
  const PLANT_LOCATION = { lat: 23.564675316036272, lng: 119.66034190357468 };
  const MAX_DIST = 500; // æ¸¬è©¦ç”¨å¯¬é¬†è·é›¢
  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;
  
  // å‡åˆ¥é¤˜é¡æš«å­˜
  let leaveBalances = { annual: 0, comp: 0 };

  // â˜… ç¾¤çµ„èˆ‡å·¥æ™‚å®šç¾© (ä¿®æ­£)
  const SHIFTS = {
      "maintenance": { 
          name: "ç¶­è­·è¡Œæ”¿ç¾¤", 
          totalHrs: 8.5, // 8å·¥æ™‚+0.5ä¼‘
          desc: "08:00~16:30 (ä¼‘0.5h)" 
      }, 
      "cleaning": { 
          name: "æ¸…æ½”ç¾¤", 
          totalHrs: 9.0, // 8å·¥æ™‚+1.0ä¼‘
          desc: "08:00~17:00 (ä¼‘1.0h)" 
      }
  };

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      
      initHistoryDates(); // ç´€éŒ„é æ—¥æœŸ
      initDefaultTimes(); // è«‹å‡èˆ‡è£œå¡æ—¥æœŸ
      
      await loadUserData(user);
      startGPS();
    }
  });

  // åˆå§‹åŒ–è¼¸å…¥æ¡†æ™‚é–“
  function initDefaultTimes() {
      const now = new Date();
      // æ ¼å¼åŒ– YYYY-MM-DD
      const ymd = now.toLocaleDateString('en-CA'); 
      
      // 1. è£œå¡é è¨­ï¼šä»Šå¤© 08:00
      document.getElementById('fixDate').value = ymd;
      document.getElementById('fixTime').value = "08:00";

      // 2. è«‹å‡é è¨­ï¼šä»Šå¤© 08:00 ~ 16:30
      document.getElementById('l-start').value = ymd + "T08:00";
      document.getElementById('l-end').value = ymd + "T16:30";
      calculateDuration(); // è§¸ç™¼ä¸€æ¬¡è¨ˆç®—
  }

  // è¨ˆç®—è«‹å‡æ™‚æ•¸
  function calculateDuration() {
      const sVal = document.getElementById('l-start').value;
      const eVal = document.getElementById('l-end').value;
      const resDiv = document.getElementById('calc-result');
      
      if(!sVal || !eVal) return;
      
      const start = new Date(sVal);
      const end = new Date(eVal);
      
      if(end <= start) {
          resDiv.innerText = "çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“";
          resDiv.style.color = "red";
          return;
      }

      // è¨ˆç®—æ¯«ç§’å·® -> è½‰å°æ™‚
      const diffMs = end - start;
      const diffHrs = (diffMs / (1000 * 60 * 60)).toFixed(1); // å°æ•¸é»1ä½
      
      // å‡è¨­ä¸€å¤©8å°æ™‚å·¥ä½œ
      const diffDays = (diffHrs / 8).toFixed(1); 
      
      resDiv.innerHTML = `åˆè¨ˆï¼š${diffHrs} å°æ™‚ (ç´„ ${diffDays} å¤©)`;
      resDiv.style.color = "#2563eb";
  }
  // ç¶å®šç›£è½
  document.getElementById('l-start').addEventListener('change', calculateDuration);
  document.getElementById('l-end').addEventListener('change', calculateDuration);

  function initHistoryDates() {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1); 
      const last = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
      const toYMD = d => {
          const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
          return z.toISOString().split('T')[0];
      };
      document.getElementById('history-start').value = toYMD(first);
      document.getElementById('history-end').value = toYMD(last);
  }

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        
        // é¤˜é¡è¨ˆç®—
        if(userData.onboardDate) {
            let totalAnnual = calculateAnnual(userData.onboardDate);
            leaveBalances.annual = totalAnnual - (userData.leaveUsed || 0);
            leaveBalances.comp = (userData.compTotal || 0) - (userData.compUsed || 0);
            updateBalanceDisplay(); // æ›´æ–°ä»‹é¢
        }
        loadColleagues();
        loadTasks();
    } else {
        // æ–°ç”¨æˆ¶é è¨­ (é è¨­ç¶­è­·ç¾¤)
        userData = { 
            name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", 
            workShift: "maintenance",
            createdAt: new Date().toISOString() 
        };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        toggleEditMode();
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    // é¡¯ç¤ºç¾¤çµ„åç¨±
    const shiftName = SHIFTS[data.workShift] ? SHIFTS[data.workShift].name : "æœªè¨­å®š";
    document.getElementById('u-company-display').innerText = (data.company||"æœªè¨­å®š") + ` / ${shiftName}`;
    
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
    document.getElementById('workShift').value = data.workShift || "maintenance";
  }

  // æ›´æ–°é¤˜é¡é¡¯ç¤º
  function updateBalanceDisplay() {
      const type = document.getElementById('leaveType').value;
      const box = document.getElementById('balance-display-box');
      const label = document.getElementById('balance-label');
      const val = document.getElementById('balance-val');
      
      if (type === 'ç‰¹ä¼‘') {
          box.style.display = 'flex';
          box.style.background = '#fffbeb';
          box.style.color = '#92400e';
          label.innerText = "ç‰¹ä¼‘é¤˜é¡";
          val.innerText = leaveBalances.annual;
      } else if (type === 'è£œä¼‘') {
          box.style.display = 'flex';
          box.style.background = '#eff6ff';
          box.style.color = '#1e40af';
          label.innerText = "è£œä¼‘é¤˜é¡";
          val.innerText = leaveBalances.comp;
      } else {
          box.style.display = 'none';
      }
  }

  // â˜… æ‰“å¡é‚è¼¯ (å«å½ˆæ€§å·¥æ™‚)
  async function doClock(type) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«å€‹äººè³‡æ–™"); return; }
    if (currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }

    const now = new Date();
    let status = "æ­£å¸¸";
    // é è¨­ç¶­è­·ç¾¤
    const shiftKey = userData.workShift || "maintenance";
    const shift = SHIFTS[shiftKey]; 
    
    if (type === 'ä¸Šç­') {
        const checkTime = new Date();
        checkTime.setHours(8, 15, 0); 
        if (now > checkTime) {
            status = "é²åˆ°";
            alert(`å·²è¶…é 08:15ï¼Œè¨˜ç‚ºã€Œé²åˆ°ã€ã€‚è«‹è¨˜å¾—è£œå–®ã€‚`);
        }
    } 
    else if (type === 'ä¸‹ç­') {
        try {
            // æ‰¾ä»Šå¤©æœ€æ—©çš„ä¸Šç­å¡
            const startOfDay = new Date(now); startOfDay.setHours(0,0,0,0);
            const endOfDay = new Date(now); endOfDay.setHours(23,59,59,999);
            
            const snap = await db.collection('cams_records')
                .where('userId', '==', currentUser.email)
                .where('type', '==', 'ä¸Šç­')
                .where('time', '>=', startOfDay)
                .where('time', '<=', endOfDay)
                .orderBy('time', 'asc').limit(1).get();

            if (snap.empty) {
                if(!confirm("âš ï¸ æ‰¾ä¸åˆ°ä»Šå¤©çš„ä¸Šç­å¡ã€‚ç¢ºå®šè¦æ‰“å¡å—ï¼Ÿ")) return;
                status = "ç•°å¸¸(ç¼ºä¸Šç­)";
            } else {
                const inTime = snap.docs[0].data().time.toDate();
                
                // è¨ˆç®—åŸºæº–ä¸Šç­æ™‚é–“ (æœ€æ—©08:00)
                let baseInTime = new Date(inTime);
                const limit0800 = new Date(inTime); limit0800.setHours(8,0,0,0);
                if (inTime < limit0800) baseInTime = limit0800;

                // åˆæ³•ä¸‹ç­ = ä¸Šç­ + ç¸½å·¥æ™‚ (å«ä¼‘)
                // ç¶­è­·ç¾¤+8.5h, æ¸…æ½”ç¾¤+9.0h
                const validOutTime = new Date(baseInTime.getTime() + shift.totalHrs * 60 * 60 * 1000);
                
                if (now < validOutTime) {
                    const diffMin = Math.ceil((validOutTime - now) / 60000);
                    if(!confirm(`âš ï¸ ä½ æ˜¯ ${shift.name}ï¼Œæ‡‰å·¥ä½œæ»¿ ${shift.totalHrs} å°æ™‚ã€‚\nåˆæ³•ä¸‹ç­æ™‚é–“ï¼š${validOutTime.getHours()}:${String(validOutTime.getMinutes()).padStart(2,'0')}\n\nç¾åœ¨æ‰“å¡å°‡è¨˜ç‚ºã€Œæ—©é€€ã€ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
                    status = "æ—©é€€";
                }
            }
        } catch(e) { console.error(e); }
    }

    try {
        await db.collection('cams_records').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, 
            company: userData.company, dept: userData.dept,
            type: type, time: now, lat: currentLat, lng: currentLng, status: status
        });
        alert(`æ‰“å¡æˆåŠŸï¼ç‹€æ…‹ï¼š${status}`); 
        loadHistory();
    } catch (e) { alert("å¤±æ•—: " + e.message); }
  }

  // â˜… æŸ¥è©¢ç¾åŒ–ç‰ˆ
  async function loadHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = "<p style='text-align:center; color:#888;'>è¼‰å…¥è³‡æ–™ä¸­...</p>";
    
    const sStr = document.getElementById('history-start').value;
    const eStr = document.getElementById('history-end').value;
    const startD = new Date(sStr + "T00:00:00");
    const endD = new Date(eStr + "T23:59:59");

    try {
        let html = "";
        const snap = await db.collection('cams_records')
            .where('userId', '==', currentUser.email)
            .where('time', '>=', startD).where('time', '<=', endD)
            .orderBy('time', 'desc').limit(30).get();

        if (snap.empty) {
            html = "<div style='text-align:center; padding:20px; color:#999;'>æŸ¥ç„¡ç´€éŒ„</div>";
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                const t = d.time.toDate();
                const dateStr = `${t.getMonth()+1}/${t.getDate()}`;
                const timeStr = t.toLocaleTimeString('zh-TW', {hour12: true, hour:'numeric', minute:'numeric'});
                
                let badgeClass = "badge-normal";
                if(d.status.includes("é²åˆ°") || d.status.includes("æ—©é€€") || d.status.includes("ç•°å¸¸")) badgeClass = "badge-warn";
                if(d.status.includes("è£œå¡")) badgeClass = "badge-info";

                html += `
                <div class="history-card">
                    <div class="h-left">
                        <span class="h-type">${d.type} <span style="font-weight:normal; font-size:14px; margin-left:5px;">${dateStr} ${timeStr}</span></span>
                    </div>
                    <span class="h-badge ${badgeClass}">${d.status}</span>
                </div>`;
            });
        }
        list.innerHTML = html;
    } catch (e) {
        if(e.message.includes("index")) list.innerHTML = `<p style='color:red;text-align:center'>ğŸ”¥ éœ€å»ºç«‹ç´¢å¼•æ‰å¯æŸ¥è©¢ <a href="${e.message.match(/https?:\/\/[^ ]+/)[0]}" target="_blank">é»æ­¤å»ºç«‹</a></p>`;
        else list.innerHTML = `<p style='color:red;text-align:center'>éŒ¯èª¤: ${e.message}</p>`;
    }
  }

  // GPS
  function startGPS() {
      const iconDiv = document.getElementById('gps-icon');
      const loadDiv = document.getElementById('gps-loading');
      if(navigator.geolocation) {
          navigator.geolocation.watchPosition(p => {
              loadDiv.classList.add('hidden'); iconDiv.classList.remove('hidden');
              currentLat = p.coords.latitude; currentLng = p.coords.longitude;
              currentDist = getDist(currentLat, currentLng, PLANT_LOCATION.lat, PLANT_LOCATION.lng);
              const box = document.getElementById('gps-box');
              if(currentDist <= MAX_DIST) {
                  box.className = "gps-box gps-status-ok"; iconDiv.innerHTML = "âœ…";
                  document.getElementById('gps-title').innerText = "å·²é€²å…¥æ‰“å¡ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)}m (OK)`;
              } else {
                  box.className = "gps-box gps-status-err"; iconDiv.innerHTML = "ğŸš«";
                  document.getElementById('gps-title').innerText = "å°šæœªé€²å…¥ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)}m`;
              }
          }, e => {
              loadDiv.classList.add('hidden'); iconDiv.classList.remove('hidden'); iconDiv.innerHTML = "âš ï¸";
              document.getElementById('gps-title').innerText = "å®šä½å¤±æ•—";
              document.getElementById('gps-desc').innerText = "è«‹æª¢æŸ¥æ‰‹æ©Ÿå®šä½æ¬Šé™";
          }, {enableHighAccuracy:true});
      }
  }
  function getDist(lat1, lon1, lat2, lon2) {
      const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // å„²å­˜è³‡æ–™
  async function saveToFirebase() {
      try {
          const newData = {
              name: document.getElementById('dbName').value,
              jobTitle: document.getElementById('jobTitle').value,
              company: document.getElementById('company').value,
              dept: document.getElementById('dept').value,
              onboardDate: document.getElementById('onboardDate').value,
              workShift: document.getElementById('workShift').value
          };
          await db.collection('cams_users').doc(currentUser.email).set(newData, {merge:true});
          alert("è³‡æ–™æ›´æ–°æˆåŠŸï¼"); location.reload();
      } catch(e) { alert("å„²å­˜å¤±æ•—: "+e.message); }
  }

  // è£œå¡ç”³è«‹
  async function submitApp(cat) {
    if(cat === 'leave') {
        const s = document.getElementById('l-start').value;
        const e = document.getElementById('l-end').value;
        const agent = document.getElementById('agentSelect').value;
        if(!agent || !s || !e) { alert("è«‹å®Œæ•´å¡«å¯«"); return; }
        
        await db.collection('cams_applications').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            category: 'leave', type: document.getElementById('leaveType').value,
            startDate: s, endDate: e, agentName: agent, createdAt: new Date(),
            status: { agent: "å¾…å¯©æ ¸", leader: "å¾…å¯©æ ¸", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" }
        });
        alert("å‡å–®å·²é€å‡º"); loadHistory();
    }
    if(cat === 'correction') {
        const d = document.getElementById('fixDate').value;
        const t = document.getElementById('fixTime').value;
        const r = document.getElementById('fixReason').value;
        if(!d || !t || !r) { alert("è«‹å®Œæ•´å¡«å¯«"); return; }

        await db.collection('cams_applications').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            category: 'correction', type: "è£œå¡-"+document.getElementById('fixType').value,
            startDate: d+"T"+t, reason: r, createdAt: new Date(),
            status: { boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" }
        });
        alert("è£œå¡ç”³è«‹å·²é€å‡º"); toggleFix(); loadHistory();
    }
  }

  function toggleEditMode() { 
      document.getElementById('meta-form').classList.toggle('hidden'); 
      const shiftSelect = document.getElementById('workShift');
      const dateInput = document.getElementById('onboardDate');
      if(!shiftSelect.value) shiftSelect.disabled = false;
      if(!dateInput.value) dateInput.disabled = false;
  }
  function toggleFix() { document.getElementById('fix-form').classList.toggle('hidden'); }
  
  function switchTab(t) {
    ['clock','leave','history','task'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
        document.getElementById('tab-btn-'+id).classList.remove('active');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.getElementById('tab-btn-'+t).classList.add('active');
    if(t==='history') loadHistory();
    if(t==='task') loadTasks();
  }

  // è¼”åŠ©å‡½å¼ (ç°¡åŒ–ç‰ˆ)
  function calculateAnnual(d) { return 7; } // ç¯„ä¾‹å€¼
  async function loadColleagues() { /* åŒäº‹é¸å–®é‚è¼¯ï¼Œç¶­æŒåŸæ¨£ */ 
      if(!userData.company) return;
      const sel = document.getElementById('agentSelect');
      const snap = await db.collection('cams_users').where('company', '==', userData.company).get();
      sel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>";
      snap.forEach(doc => {
          let u = doc.data();
          if(u.email !== currentUser.email) sel.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      });
  }
  async function loadTasks() { /* å¾…è¾¦é‚è¼¯ï¼Œç¶­æŒåŸæ¨£ */ }
</script>
</body>
</html>
