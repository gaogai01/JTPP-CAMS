// 修改 index.html 中的 submitApp 函式
async function submitApp(cat) {
    if (!userData.company) { alert("請先填寫基本資料"); return; }
    
    // ★★★ 新增：代理人檢查邏輯 ★★★
    let agentName = "";
    if (cat === 'leave') {
        agentName = document.getElementById('agentName').value.trim();
        if (!agentName) { alert("請輸入代理人姓名"); return; }
        
        // 檢查代理人是否存在且為同一家公司
        const agentSnap = await db.collection('cams_users')
            .where('name', '==', agentName)
            .where('company', '==', userData.company) // 關鍵：限制同一公司
            .get();

        if (agentSnap.empty) {
            alert(`找不到「${agentName}」，或該員非本公司員工，無法設為代理人。`);
            return;
        }
    }
    // ★★★ 結束檢查 ★★★

    try {
        let payload = {
            userId: currentUser.email,
            name: userData.name,
            email: currentUser.email,
            company: userData.company,
            dept: userData.dept,
            category: cat,
            startDate: document.getElementById(cat==='leave'?'l-start':'ot-start').value,
            endDate: document.getElementById(cat==='leave'?'l-end':'ot-end').value,
            createdAt: new Date()
        };

        if(cat === 'leave') {
            payload.type = document.getElementById('leaveType').value;
            payload.agentName = agentName;
            payload.status = { agent: "待審核", leader: "待審核", boss: "待審核", client: "待審核" };
        } else {
            payload.type = document.getElementById('otType').value;
            payload.status = { boss: "待審核", client: "待審核" };
        }

        await db.collection('cams_applications').add(payload);
        alert("申請已送出！");
        loadHistory();
    } catch (e) { alert("失敗: " + e.message); }
}
