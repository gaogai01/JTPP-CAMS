<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>尖山電廠系統 (員工端)</title>
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <div id="loading-screen">系統載入中...</div>
  <h2>⚡ 尖山電廠系統</h2>
  
  <div id="login-section" class="hidden" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">🔵 Google 登入</button>
  </div>

  <div id="main-section" class="hidden">
    <div style="display:flex; align-items:center; background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:20px;">
      <img id="u-photo" src="" alt="" style="width:50px;height:50px;border-radius:50%;margin-right:15px;">
      <div style="flex-grow:1;">
        <div id="u-name" style="font-weight:800;font-size:18px;">...</div>
        <div id="u-company-display" style="font-size:13px;color:#64748b;">讀取中...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">修改資料</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #f8fafc; padding: 20px; margin-bottom: 20px; border-radius:12px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0;">👤 個人檔案</h4>
        <label>真實姓名</label><input type="text" id="dbName">
        <label>手機號碼</label><input type="text" id="dbPhone" placeholder="09xx-xxx-xxx">
        <label>職稱</label><input type="text" id="jobTitle">
        <label>承攬商公司</label><input type="text" id="company">
        <label>甲方部門</label><input type="text" id="dept">
        
        <label>所屬群組 (影響下班時間)</label>
        <select id="workShift" disabled style="background:#eee;">
            <option value="normal">正常班 (08:00~16:30)</option>
            <option value="cleaning">清潔班 (08:00~17:00)</option>
        </select>
        
        <label>底薪</label><input type="number" id="baseSalary" disabled style="background:#eee;" placeholder="未設定">
        <label>到職日</label><input type="date" id="onboardDate" disabled style="background:#eee;">
        
        <button class="btn-in" onclick="saveToFirebase()">儲存變更</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">打卡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">請假</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">待辦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">紀錄</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div id="gps-loading" class="pulse-container"><div class="pulse-dot"></div></div>
            <div id="gps-icon" class="hidden" style="font-size:40px;">📡</div>
            <div id="gps-title" style="font-weight:bold; margin-top:10px;">定位中...</div>
            <div id="gps-desc">請稍候，正在獲取您的位置</div>
            <button onclick="startGPS()" style="margin-top:10px; font-size:12px; padding:5px 10px; width:auto; background:#64748b;">🔄 重新定位</button>
        </div>

        <div class="btn-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn-in" onclick="doClock('上班')">上班打卡<br><small>08:00</small></button>
            <button class="btn-leave" onclick="doClock('外出')">外出/公務</button>
            <button class="btn-out" onclick="doClock('下班')">下班打卡<br><small>自動判斷</small></button>
            <button class="btn-leave" onclick="doClock('返回')">返回/銷假</button>
        </div>
        
        <button class="btn-fix" onclick="toggleFix()" style="margin-top:20px;">🛠️ 申請補刷卡 (忘記打卡)</button>
        <div id="fix-form" class="hidden" style="margin-top:10px; background:#f1f5f9; padding:15px; border-radius:10px;">
            <label>類型</label><select id="fixType" onchange="updateFixTimeDefaults()"><option value="上班">上班</option><option value="下班">下班</option></select>
            <label>日期</label><input type="date" id="fixDate">
            <label>時間</label><input type="time" id="fixTime">
            <label>事由</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">送出申請</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <label>假別</label>
        <select id="leaveType" onchange="updateBalanceDisplay()">
            <option value="特休">特休</option><option value="補休">補休</option><option value="事假">事假</option><option value="病假">病假</option>
        </select>

        <div id="balance-panel" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-num" id="bal-total">-</span><span class="stat-label">今年應休</span></div>
                <div class="stat-card"><span class="stat-num" id="bal-used">-</span><span class="stat-label">已休天數</span></div>
                <div class="stat-card" style="border-color:#f59e0b; background:#fffbeb;"><span class="stat-num" id="bal-left" style="color:#d97706">-</span><span class="stat-label">剩餘天數</span></div>
            </div>
        </div>

        <label>代理人 (請選擇同公司員工)</label>
        <select id="agentSelect"><option value="">載入中...</option></select>
        
        <div style="display:flex;gap:10px;align-items:center; margin-top:10px;">
            <div style="flex:1"><label>開始</label><input type="datetime-local" id="l-start"></div>
            <div style="flex:1"><label>結束</label><input type="datetime-local" id="l-end"></div>
        </div>
        <div id="calc-result" style="text-align:right; font-weight:bold; color:#2563eb; margin-bottom:10px;">合計：0 天 0 小時</div>
        <button class="btn-leave" onclick="submitApp('leave')">送出假單</button>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%; margin-bottom:15px;">🔄 刷新待辦</button>
        <div id="task-list"><p style="text-align:center; color:#999;">暫無待辦事項</p></div>
    </div>

    <div id="tab-history" class="hidden">
        <div class="sub-tabs">
            <div id="sub-clock" class="sub-tab active" onclick="switchHistorySub('clock')">🕒 刷卡查詢</div>
            <div id="sub-leave" class="sub-tab" onclick="switchHistorySub('leave')">📄 請假查詢</div>
            <div id="sub-overtime" class="sub-tab" onclick="switchHistorySub('overtime')">💪 加班查詢</div>
        </div>
        <div class="search-box">
            <label>查詢期間</label>
            <div class="date-row"><input type="date" id="history-start"><span>~</span><input type="date" id="history-end"></div>
            <button class="btn-search" onclick="loadCurrentHistory()">🔍 查詢</button>
        </div>
        <div id="history-list"></div>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script src="app.js"></script>
<script src="auth.js"></script>

</body>
</html>
