<script>
  // ★★★ 請確認這裡是你最新的 Apps Script 網址 (結尾是 /exec) ★★★
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";

  const TARGET_LAT = 23.564675316036272;
  const TARGET_LNG = 119.66034190357468;
  const MAX_DIST = 100; // 公尺
  let currentUserToken = null;
  let currentLat = 0, currentLng = 0, currentDist = 9999;

  // 1. Google 登入成功回呼 (修復版)
  function handleCredentialResponse(response) {
    try {
      // 使用更穩定的解析方式
      const payload = parseJwt(response.credential);
      
      currentUserToken = response.credential;
      
      // 切換畫面
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      
      // 填入資料
      document.getElementById('u-name').innerText = payload.name;
      document.getElementById('u-email').innerText = payload.email;
      document.getElementById('u-photo').src = payload.picture;
      
      // 啟動 GPS
      startGPS();
    } catch (e) {
      alert("登入解析失敗，請重新整理頁面試試：" + e);
    }
  }

  // 2. 專門解析 JWT Token 的函數 (解決亂碼報錯問題)
  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  // 3. GPS 啟動
  function startGPS() {
    if(navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            currentDist = getDist(currentLat, currentLng, TARGET_LAT, TARGET_LNG);
            document.getElementById('dist-display').innerText = Math.round(currentDist);
        }, (err) => { document.getElementById('dist-display').innerText = "定位失敗"; }, { enableHighAccuracy: true });
    } else {
        document.getElementById('dist-display').innerText = "不支援 GPS";
    }
  }

  // 4. 打卡動作
  function doClock(type) {
    const company = document.getElementById('company').value;
    const dept = document.getElementById('dept').value;
    if(!company || !dept) { alert("請先填寫公司與部門"); return; }
    
    // GPS 檢查 (若要測試可暫時註解掉下面這行)
    if(currentDist > MAX_DIST) { alert(`距離電廠 ${Math.round(currentDist)}m，無法打卡！`); return; }

    updateStatus("資料傳送中...", "");
    const data = { action: "clockIn", credential: currentUserToken, type: type, company: company, dept: dept, lat: currentLat, lng: currentLng };
    sendToGAS(data);
  }

  // 5. 送出請假
  function submitLeave() {
    const company = document.getElementById('company').value;
    const dept = document.getElementById('dept').value;
    if(!company || !dept) { alert("請先填寫公司與部門"); return; }
    
    updateStatus("傳送中...", "");
    const data = { action: "requestLeave", credential: currentUserToken, company: company, dept: dept, type: document.getElementById('leaveType').value, startDate: document.getElementById('l-start').value, endDate: document.getElementById('l-end').value };
    sendToGAS(data);
  }

  // 6. 特休試算
  function calcLeave() {
     const d = document.getElementById('onboardDate').value;
     if(!d) return;
     fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "calculateLeave", startDate: d }) })
     .then(r => r.json()).then(d => document.getElementById('leaveRes').innerText = d.days);
  }

  // 共用傳送功能
  function sendToGAS(data) {
    fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
    .then(r => r.json())
    .then(res => updateStatus(res.message, res.success ? "success" : "error"))
    .catch(e => updateStatus("連線失敗，請檢查網路", "error"));
  }

  function updateStatus(msg, type) {
    const box = document.getElementById('status-box');
    box.innerText = msg;
    box.className = type;
  }

  function switchTab(t) {
    document.getElementById('status-box').innerText = "";
    if(t==='clock'){
        document.getElementById('tab-clock').classList.remove('hidden');
        document.getElementById('tab-leave').classList.add('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.querySelectorAll('.tab')[1].classList.remove('active');
    } else {
        document.getElementById('tab-clock').classList.add('hidden');
        document.getElementById('tab-leave').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.remove('active');
        document.querySelectorAll('.tab')[1].classList.add('active');
    }
  }

  // 距離計算公式
  function getDist(lat1, lon1, lat2, lon2) {
    var R = 6371000, dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
</script>
