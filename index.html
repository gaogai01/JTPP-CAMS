<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» æ‰“å¡ç³»çµ±</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    
    /* æŒ‰éˆ• */
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; }
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-leave { background-color: #f9ab00; color: black; }
    .btn-back { background-color: #188038; }
    
    /* ç‹€æ…‹èˆ‡ç™»å…¥ */
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
    #user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    #status-box { text-align: center; padding: 10px; margin-top: 15px; border-radius: 5px; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; }
    .tab.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; font-weight: bold; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» æ‰¿åŒ…å•†ç³»çµ±</h2>

  <div id="login-section">
    <p style="text-align:center; color:#666;">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ (é˜²ä»£æ‰“å¡)</p>
<div id="g_id_onload"
     data-client_id="1066125366380-tarq5fktrgap3cp3karp2ednbl6vk6n0.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
</div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div>
        <div id="u-name" style="font-weight:bold;"></div>
        <div id="u-email" style="font-size:12px; color:#666;"></div>
      </div>
    </div>

    <div id="meta-form">
        <label>æ‰¿æ”¬å•†å…¬å¸</label>
        <input type="text" id="company" placeholder="ä¾‹å¦‚ï¼šç‘æ…¶ä¼æ¥­è¡Œ">
        <label>ç”²æ–¹éƒ¨é–€</label>
        <input type="text" id="dept" placeholder="ä¾‹å¦‚ï¼šç’°åŒ–èª²">
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('clock')">æ‰“å¡ä½œæ¥­</div>
      <div class="tab" onclick="switchTab('leave')">è«‹å‡ç”³è«‹</div>
    </div>

    <div id="tab-clock">
        <p style="text-align:center; font-size:13px; color:#555; margin:0;">
           ğŸ“ GPS è·é›¢é›»å» ï¼š<span id="dist-display">åµæ¸¬ä¸­...</span> å…¬å°º
        </p>
        
        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><span style="font-size:12px; font-weight:normal;">(08:00å‰)</span></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º<br><span style="font-size:12px; font-weight:normal;">(é–‹å§‹è«‹å‡)</span></button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›<br><span style="font-size:12px; font-weight:normal;">(çµæŸè«‹å‡)</span></button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><span style="font-size:12px; font-weight:normal;">(16:30å¾Œ)</span></button>
        </div>
        <p style="font-size:12px; color:#d93025; margin-top:5px; text-align:center;">* 12:00~12:30 ä¼‘æ¯æ™‚é–“ç³»çµ±è‡ªå‹•æ‰£é™¤</p>
    </div>

    <div id="tab-leave" class="hidden">
        <label>åˆ°è·æ—¥ (ç‰¹ä¼‘è©¦ç®—)</label>
        <input type="date" id="onboardDate" onchange="calcLeave()">
        <p>ç‰¹ä¼‘å¤©æ•¸ï¼š<span id="leaveRes" style="color:blue;">0</span> å¤©</p>
        <hr>
        <label>å‡åˆ¥</label>
        <select id="leaveType"><option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option></select>
        <label>é–‹å§‹æ™‚é–“</label><input type="datetime-local" id="l-start">
        <label>çµæŸæ™‚é–“</label><input type="datetime-local" id="l-end">
        <button class="btn-in" onclick="submitLeave()">é€å‡ºå‡å–®</button>
    </div>

    <div id="status-box"></div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Apps Script ç¶²å€ (çµå°¾æ˜¯ /exec) â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";

  const TARGET_LAT = 23.564675316036272;
  const TARGET_LNG = 119.66034190357468;
  const MAX_DIST = 100; // å…¬å°º
  let currentUserToken = null;
  let currentLat = 0, currentLng = 0, currentDist = 9999;

  function handleCredentialResponse(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    currentUserToken = response.credential;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    document.getElementById('u-name').innerText = payload.name;
    document.getElementById('u-email').innerText = payload.email;
    document.getElementById('u-photo').src = payload.picture;
    startGPS();
  }

  function startGPS() {
    if(navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            currentDist = getDist(currentLat, currentLng, TARGET_LAT, TARGET_LNG);
            document.getElementById('dist-display').innerText = Math.round(currentDist);
        }, (err) => { document.getElementById('dist-display').innerText = "å¤±æ•—"; }, { enableHighAccuracy: true });
    }
  }

  function doClock(type) {
    const company = document.getElementById('company').value;
    const dept = document.getElementById('dept').value;
    if(!company || !dept) { alert("è«‹å…ˆå¡«å¯«å…¬å¸èˆ‡éƒ¨é–€"); return; }
    if(currentDist > MAX_DIST) { alert(`è·é›¢é›»å»  ${Math.round(currentDist)}mï¼Œç„¡æ³•æ‰“å¡ï¼`); return; }

    updateStatus("è³‡æ–™å‚³é€ä¸­...", "");
    const data = { action: "clockIn", credential: currentUserToken, type: type, company: company, dept: dept, lat: currentLat, lng: currentLng };
    sendToGAS(data);
  }

  function submitLeave() {
    const company = document.getElementById('company').value;
    const dept = document.getElementById('dept').value;
    updateStatus("å‚³é€ä¸­...", "");
    const data = { action: "requestLeave", credential: currentUserToken, company: company, dept: dept, type: document.getElementById('leaveType').value, startDate: document.getElementById('l-start').value, endDate: document.getElementById('l-end').value };
    sendToGAS(data);
  }

  function calcLeave() {
     const d = document.getElementById('onboardDate').value;
     if(!d) return;
     fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "calculateLeave", startDate: d }) })
     .then(r => r.json()).then(d => document.getElementById('leaveRes').innerText = d.days);
  }

  function sendToGAS(data) {
    fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
    .then(r => r.json())
    .then(res => updateStatus(res.message, res.success ? "success" : "error"))
    .catch(e => updateStatus("é€£ç·šå¤±æ•—", "error"));
  }

  function updateStatus(msg, type) {
    const box = document.getElementById('status-box');
    box.innerText = msg;
    box.className = type;
  }

  function switchTab(t) {
    document.getElementById('status-box').innerText = "";
    if(t==='clock'){
        document.getElementById('tab-clock').classList.remove('hidden');
        document.getElementById('tab-leave').classList.add('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.querySelectorAll('.tab')[1].classList.remove('active');
    } else {
        document.getElementById('tab-clock').classList.add('hidden');
        document.getElementById('tab-leave').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.remove('active');
        document.querySelectorAll('.tab')[1].classList.add('active');
    }
  }

  function getDist(lat1, lon1, lat2, lon2) {
    var R = 6371000, dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
</script>
</body>
</html>
