<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (Firebaseç‰ˆ)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none !important; }
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-ot { background-color: #6f42c1; }
    .btn-edit { background-color: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-left: 10px; }
    
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    #user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 2px solid white; }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: bold; font-size: 16px; color: #1f1f1f; }
    .user-role { font-size: 12px; background: #007bff; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    
    #status-box { text-align: center; padding: 10px; margin-top: 15px; border-radius: 5px; font-weight: bold; }
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; overflow-x: auto; }
    .tab { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; color: #666; font-weight: bold; white-space: nowrap; font-size: 14px; }
    .tab.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>

  <div id="login-section" style="text-align:center;">
    <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name"><span id="u-name">...</span> <span id="u-role" class="user-role">...</span></div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #fafafa; padding: 15px; margin-bottom: 15px; border-radius:8px;">
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è³‡æ–™</button>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div class="tab" onclick="switchTab('overtime')">åŠ ç­</div>
    </div>

    <div id="tab-clock">
        <p style="text-align:center; color:#555; margin-bottom:10px;">ğŸ“ GPS: <span id="dist-display">åµæ¸¬ä¸­...</span></p>
        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º</button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <label>å‡åˆ¥</label><select id="leaveType"><option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option></select>
        <label>ä»£ç†äºº</label><input type="text" id="agentName" placeholder="ä»£ç†äººå§“å">
        <label>é–‹å§‹</label><input type="datetime-local" id="l-start">
        <label>çµæŸ</label><input type="datetime-local" id="l-end">
        <button class="btn-out" onclick="submitLeave()">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-overtime" class="hidden">
        <label>æ–¹å¼</label><select id="otType"><option>ç”³è«‹åŠ ç­è²»</option><option>ç”³è«‹è£œä¼‘</option></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="ot-start">
        <label>çµæŸ</label><input type="datetime-local" id="ot-end">
        <button class="btn-ot" onclick="submitOvertime()">é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <div id="status-box"></div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";
  
  // ä½ çš„ Firebase è¨­å®š (è«‹ç›´æ¥è¤‡è£½ä½ ä¹‹å‰æä¾›çš„é‚£å€‹)
  const firebaseConfig = {
    apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
    authDomain: "tpc-monitor.firebaseapp.com",
    projectId: "tpc-monitor",
    storageBucket: "tpc-monitor.firebasestorage.app",
    messagingSenderId: "1066125366380",
    appId: "1:1066125366380:web:836d5898c051226669f449"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null;
  let userData = {}; // å­˜ Firestore è³‡æ–™
  
  // 1. ç™»å…¥é‚è¼¯
  function loginGoogle() {
    auth.signInWithPopup(provider).catch(e => alert(e.message));
  }

  // ç›£è½ç™»å…¥ç‹€æ…‹
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      
      await loadUserData(user); // å¾ Firebase è®€å–è³‡æ–™
      startGPS();
    }
  });

  // 2. è®€å–/å»ºç«‹ ä½¿ç”¨è€…è³‡æ–™ (Firestore)
  async function loadUserData(user) {
    const userRef = db.collection('users').doc(user.email); // ç”¨ Email ç•¶ ID
    const doc = await userRef.get();

    if (doc.exists) {
        // è€é³¥ï¼šè®€å–è³‡æ–™
        userData = doc.data();
        updateUI(userData);
    } else {
        // æ–°äººï¼šå»ºç«‹é è¨­è³‡æ–™
        userData = {
            name: user.displayName,
            email: user.email,
            role: "å¤–åŒ…å“¡å·¥", // é è¨­èº«åˆ†
            company: "",
            dept: "",
            jobTitle: "",
            createdAt: new Date().toISOString()
        };
        await userRef.set(userData);
        updateUI(userData);
        alert("æ­¡è¿æ–°ç”¨æˆ¶ï¼Œè«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™ï¼");
        document.getElementById('meta-form').classList.remove('hidden');
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    document.getElementById('u-role').innerText = data.role;
    document.getElementById('u-company-display').innerText = (data.company || "æœªè¨­å®š") + " / " + (data.dept || "æœªè¨­å®š");
    
    // å¡«å…¥è¡¨å–®
    document.getElementById('dbName').value = data.name;
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('jobTitle').value = data.jobTitle || "";
  }

  // 3. ä¿®æ”¹ä¸¦å„²å­˜è³‡æ–™ (å¯«å…¥ Firebase)
  async function saveToFirebase() {
    const newData = {
        name: document.getElementById('dbName').value,
        company: document.getElementById('company').value,
        dept: document.getElementById('dept').value,
        jobTitle: document.getElementById('jobTitle').value
    };
    
    try {
        await db.collection('users').doc(currentUser.email).update(newData);
        userData = { ...userData, ...newData }; // æ›´æ–°æœ¬åœ°è®Šæ•¸
        updateUI(userData);
        document.getElementById('meta-form').classList.add('hidden');
        alert("è³‡æ–™å·²æ›´æ–°ï¼");
    } catch (e) {
        alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
    }
  }

  // 4. å‚³é€è³‡æ–™çµ¦ GAS (æ‰“å¡/è«‹å‡)
  // æ³¨æ„ï¼šç¾åœ¨æˆ‘å€‘ç›´æ¥æŠŠ Firebase çš„è³‡æ–™å‚³çµ¦ GASï¼ŒGAS ä¸ç”¨å†å»æŸ¥è¡¨äº†ï¼
  function sendToGAS(action, extraData = {}) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«å…¬å¸è³‡æ–™"); return; }
    
    document.getElementById('status-box').innerText = "å‚³é€ä¸­...";
    
    const payload = {
        action: action,
        name: userData.name,        // å¾ Firebase æ‹¿çš„çœŸå¯¦å§“å
        email: currentUser.email,
        company: userData.company,
        dept: userData.dept,
        role: userData.role,        // æŠŠèº«åˆ†ä¹Ÿå‚³éå»
        ...extraData
    };

    fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
        document.getElementById('status-box').innerText = res.message;
        if(res.success) alert(res.message);
    })
    .catch(e => {
        document.getElementById('status-box').innerText = "é€£ç·šéŒ¯èª¤";
    });
  }

  // 5. å„ç¨®æŒ‰éˆ•å‹•ä½œ
  function doClock(type) {
    if(!currentLat) { alert("å®šä½ä¸­..."); return; }
    sendToGAS("clockIn", { type: type, lat: currentLat, lng: currentLng });
  }

  function submitLeave() {
    sendToGAS("requestLeave", {
        type: document.getElementById('leaveType').value,
        startDate: document.getElementById('l-start').value,
        endDate: document.getElementById('l-end').value,
        agentName: document.getElementById('agentName').value
    });
  }

  function submitOvertime() {
    sendToGAS("requestOvertime", {
        overtimeType: document.getElementById('otType').value,
        startDate: document.getElementById('ot-start').value,
        endDate: document.getElementById('ot-end').value
    });
  }

  // UI åˆ‡æ›
  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  function switchTab(t) {
    ['clock','leave','overtime'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
  }

  // GPS (ç°¡åŒ–ç‰ˆ)
  let currentLat=0, currentLng=0;
  function startGPS() {
    navigator.geolocation.watchPosition(p => {
        currentLat = p.coords.latitude;
        currentLng = p.coords.longitude;
        document.getElementById('dist-display').innerText = "OK";
    });
  }
</script>
</body>
</html>
