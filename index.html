<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none !important; }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; margin-top: 10px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; }
    
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-leave { background-color: #f9ab00; color: black; }
    .btn-ot { background-color: #6f42c1; color: white; }
    .btn-fix { background-color: #007bff; color: white; }
    .btn-edit { background-color: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-left: 10px; }
    
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    #user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 2px solid white; }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: bold; font-size: 16px; color: #1f1f1f; }
    
    .tabs { 
        display: flex; 
        margin-bottom: 15px; 
        background: linear-gradient(135deg, #1a73e8 0%, #6f42c1 100%);
        border-radius: 10px;
        padding: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .tab { 
        flex: 1; padding: 10px; text-align: center; cursor: pointer; color: white; 
        font-weight: bold; font-size: 14px; border-radius: 8px; transition: 0.2s;
    }
    .tab.active { background: white; color: #1a73e8; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; background: #eee; }

    /* â˜…â˜…â˜… æ–°å¢ï¼šGPS ç‹€æ…‹å¡ç‰‡æ¨£å¼ â˜…â˜…â˜… */
    .gps-box {
        text-align: center;
        padding: 30px 20px;
        border-radius: 16px;
        background: #f8f9fa;
        margin-bottom: 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    .gps-icon { font-size: 48px; display: block; margin-bottom: 10px; line-height: 1; }
    .gps-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .gps-desc { font-size: 14px; color: #666; }
    
    /* ç‹€æ…‹é¡è‰²è®Šæ› */
    .gps-status-ok { background: #d4edda; border-color: #c3e6cb; color: #155724; }
    .gps-status-ok .gps-title { color: #155724; }
    .gps-status-ok .gps-desc { color: #155724; }

    .gps-status-err { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .gps-status-err .gps-title { color: #721c24; }
    .gps-status-err .gps-desc { color: #721c24; }

    /* å®šä½ä¸­çš„å‘¼å¸ç‡ˆå‹•ç•« */
    .pulse-container { height: 50px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .pulse-dot {
        width: 20px; height: 20px; background: #1a73e8; border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(26, 115, 232, 0); }
        100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  </head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>
  <div id="login-section" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #fafafa; padding: 15px; margin-bottom: 15px; border-radius:8px;">
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        <label>åˆ°è·æ—¥</label><input type="date" id="onboardDate">
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è³‡æ–™</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">å¾…è¾¦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div class="pulse-container" id="gps-loading">
                <div class="pulse-dot"></div>
            </div>
            <div id="gps-icon" class="gps-icon hidden"></div>
            
            <div class="gps-title" id="gps-title">æ­£åœ¨å®šä½ä¸­...</div>
            <div class="gps-desc" id="gps-desc">è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®æ¬Šé™</div>
        </div>

        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º</button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
        </div>
        <button class="btn-fix" onclick="toggleFix()" style="background:#444; margin-top:20px;">ğŸ› ï¸ ç”³è«‹è£œåˆ·å¡</button>
        
        <div id="fix-form" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <label>è£œå¡é¡å‹</label><select id="fixType"><option>ä¸Šç­</option><option>ä¸‹ç­</option></select>
            <label>æ—¥æœŸ</label><input type="date" id="fixDate">
            <label>æ™‚é–“</label><input type="time" id="fixTime">
            <label>äº‹ç”±</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">é€å‡ºè£œå¡</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <label>å‡åˆ¥</label><select id="leaveType"><option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option></select>
        <label>ä»£ç†äºº</label><select id="agentSelect"></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="l-start">
        <label>çµæŸ</label><input type="datetime-local" id="l-end">
        <button class="btn-leave" onclick="submitApp('leave')">é€å‡º</button>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%">ğŸ”„ åˆ·æ–°</button>
        <div id="ot-list-container"></div>
        <div id="review-list-container"></div>
    </div>

    <div id="tab-history" class="hidden">
        <button class="btn-edit" onclick="loadHistory()" style="width:100%">ğŸ”„ åˆ·æ–°</button>
        <div id="history-list"></div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7",
    measurementId: "G-LDV2MZFY26"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // â˜… ç§»é™¤ Google Maps ç›¸é—œè®Šæ•¸ï¼Œä¿ç•™åº§æ¨™èˆ‡è·é›¢è¨ˆç®—é‚è¼¯
  const PLANT_LOCATION = { lat: 23.564675316036272, lng: 119.66034190357468 };
  const MAX_DIST = 100;
  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      await loadUserData(user);
      startGPS(); // å•Ÿå‹•å®šä½
    }
  });

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        loadColleagues();
        loadTasks();
    } else {
        userData = { name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", company: "", dept: "", createdAt: new Date().toISOString() };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        document.getElementById('meta-form').classList.remove('hidden');
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    document.getElementById('u-company-display').innerText = (data.company||"") + (data.role ? ` (${data.role})` : "");
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
  }

  // â˜… ä¿®æ”¹è™•ï¼šä½¿ç”¨åŸç”Ÿ GPS API + è¦–è¦ºåŒ–å¡ç‰‡æ›´æ–°
  function startGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;
                
                // ä½¿ç”¨æ•¸å­¸å…¬å¼è¨ˆç®—è·é›¢ (å› ç‚ºæ²’æœ‰ Google API äº†)
                currentDist = getDist(currentLat, currentLng, PLANT_LOCATION.lat, PLANT_LOCATION.lng);
                
                // æ›´æ–°ä»‹é¢ UI
                updateGpsUI(currentDist);
            },
            (err) => { 
                console.log(err); 
                document.getElementById('gps-title').innerText = "å®šä½å¤±æ•—";
                document.getElementById('gps-desc').innerText = "è«‹ç¢ºèªå·²é–‹å•Ÿæ‰‹æ©Ÿå®šä½åŠŸèƒ½";
            },
            { enableHighAccuracy: true }
        );
    } else {
        alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
    }
  }

  // æ›´æ–°å¡ç‰‡å¤–è§€çš„æ ¸å¿ƒå‡½å¼
  function updateGpsUI(dist) {
      const box = document.getElementById('gps-box');
      const iconDiv = document.getElementById('gps-icon');
      const loadDiv = document.getElementById('gps-loading');
      const title = document.getElementById('gps-title');
      const desc = document.getElementById('gps-desc');

      loadDiv.classList.add('hidden'); // éš±è—è®€å–å‹•ç•«
      iconDiv.classList.remove('hidden'); // é¡¯ç¤ºåœ–ç¤º
      
      const distInt = Math.round(dist);

      if (dist <= MAX_DIST) {
          // ç¯„åœå…§ï¼šç¶ è‰²æ¨£å¼
          box.className = "gps-box gps-status-ok";
          iconDiv.innerHTML = "âœ…"; // æˆ–ä½¿ç”¨ <svg>...</svg>
          title.innerText = "å·²é€²å…¥æ‰“å¡ç¯„åœ";
          desc.innerText = `è·é›¢é›»å» ä¸­å¿ƒ ${distInt} å…¬å°º (OK)`;
      } else {
          // ç¯„åœå¤–ï¼šç´…è‰²æ¨£å¼
          box.className = "gps-box gps-status-err";
          iconDiv.innerHTML = "ğŸš«";
          title.innerText = "å°šæœªé€²å…¥ç¯„åœ";
          desc.innerText = `ç›®å‰è·é›¢ ${distInt} å…¬å°º (é™åˆ¶ ${MAX_DIST}m)`;
      }
  }

  // Haversine å…¬å¼ (è¨ˆç®—åœ°çƒå…©é»è·é›¢)
  function getDist(lat1, lon1, lat2, lon2) { 
      var R = 6371000; // åœ°çƒåŠå¾‘ (å…¬å°º)
      var dLat = (lat2-lat1)*(Math.PI/180);
      var dLon = (lon2-lon1)*(Math.PI/180); 
      var a = Math.sin(dLat/2)*Math.sin(dLat/2) + 
              Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      return R * c; 
  }

  async function doClock(type) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
    // é›™é‡æª¢æŸ¥
    if (currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)ï¼Œç„¡æ³•æ‰“å¡ï¼`); return; }
    
    try {
        await db.collection('cams_records').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            type: type, time: new Date(), lat: currentLat, lng: currentLng, status: "æ­£å¸¸"
        });
        alert(`æ‰“å¡æˆåŠŸï¼`); loadHistory();
    } catch (e) { alert("å¤±æ•—: " + e.message); }
  }

  // å…¶ä»–é é¢åˆ‡æ›èˆ‡åŠŸèƒ½ç¶­æŒåŸæ¨£
  function switchTab(t) {
    ['clock','leave','history','task'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
        document.getElementById('tab-btn-'+id).classList.remove('active');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.getElementById('tab-btn-'+t).classList.add('active');
    
    if(t==='history') loadHistory();
    if(t==='task') loadTasks();
  }

  async function loadColleagues() { /* ... */ }
  async function submitApp(cat) { /* ... */ }
  async function loadTasks() { /* ... */ }
  async function loadHistory() { /* ... */ }
  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  function toggleFix() { document.getElementById('fix-form').classList.toggle('hidden'); }
  async function saveToFirebase() { /* ... */ }
</script>
</body>
</html>
