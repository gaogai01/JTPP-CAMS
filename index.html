<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ±</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none !important; }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; margin-top: 10px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; }
    
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-leave { background-color: #f9ab00; color: black; }
    .btn-back { background-color: #188038; }
    .btn-ot { background-color: #6f42c1; color: white; }
    .btn-edit { background-color: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-left: 10px; }
    
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    #user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 2px solid white; }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: bold; font-size: 16px; color: #1f1f1f; }
    
    #status-box { text-align: center; padding: 10px; margin-top: 15px; border-radius: 5px; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { background: #cce5ff; color: #004085; }

    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; overflow-x: auto; }
    .tab { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; color: #666; font-weight: bold; white-space: nowrap; font-size: 14px; }
    .tab.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
    
    /* æ­·å²ç´€éŒ„æ¨£å¼ */
    .history-group { margin-bottom: 15px; }
    .history-title { font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px; border-left: 3px solid #1a73e8; padding-left: 5px; }
    .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .status-badge { font-size: 12px; padding: 3px 8px; border-radius: 12px; background: #eee; color: #555; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-wait { background: #fff3cd; color: #856404; }
    .status-no { background: #f8d7da; color: #721c24; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>

  <div id="login-section">
    <p style="text-align:center; color:#666;">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
    <div id="g_id_onload"
         data-client_id="1066125366380-tarq5fktrgap3cp3karp2ednbl6vk6n0.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with"></div>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">è¼‰å…¥ä¸­...</div>
        <div class="user-meta" id="u-company-display">è®€å–è³‡æ–™ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹è³‡æ–™</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #fafafa; padding: 15px; margin-bottom: 15px; border:1px solid #eee; border-radius:8px;">
        <label>å“¡å·¥å§“å (è³‡æ–™åº«åŒæ­¥)</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        <button class="btn-in" onclick="saveProfile()">å„²å­˜ä¸¦åŒæ­¥</button>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div class="tab" onclick="switchTab('overtime')">åŠ ç­</div>
      <div class="tab" onclick="switchTab('history')">é€²åº¦æŸ¥è©¢</div>
    </div>

    <div id="tab-clock">
        <p style="text-align:center; color:#555; margin-bottom:10px;">
           ğŸ“ GPS è·é›¢ï¼š<span id="dist-display" style="color:blue;">åµæ¸¬ä¸­...</span>
        </p>
        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><small>(08:00å‰)</small></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º<br><small>(ç´€éŒ„æ™‚é–“)</small></button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›<br><small>(ç´€éŒ„æ™‚é–“)</small></button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><small>(16:30å¾Œ)</small></button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <label>åˆ°è·æ—¥</label>
        <input type="date" id="onboardDate" disabled style="background:#e9ecef;">
        <p>ç‰¹ä¼‘å¤©æ•¸ï¼š<span id="leaveRes" style="color:blue; font-weight:bold;">0</span> å¤©</p>
        <hr>
        <label>å‡åˆ¥</label><select id="leaveType"><option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="l-start" step="1800">
        <label>çµæŸ</label><input type="datetime-local" id="l-end" step="1800">
        <button class="btn-back" onclick="submitLeave()">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-overtime" class="hidden">
        <label>æ–¹å¼</label><select id="otType"><option value="ç”³è«‹åŠ ç­è²»">ç”³è«‹åŠ ç­è²»</option><option value="ç”³è«‹è£œä¼‘">ç”³è«‹è£œä¼‘</option></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="ot-start" step="1800">
        <label>çµæŸ</label><input type="datetime-local" id="ot-end" step="1800">
        <button class="btn-ot" onclick="submitOvertime()">é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <div id="tab-history" class="hidden">
        <button class="btn-edit" onclick="loadHistory()" style="width:100%; margin:0 0 10px 0;">ğŸ”„ é‡æ–°æ•´ç†é€²åº¦</button>
        <div id="history-list" style="background:#fff;"></div>
    </div>

    <div id="status-box"></div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… å‹™å¿…æ›æˆä½ çš„ /exec ç¶²å€ â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";
  const TARGET_LAT = 23.564675316036272;
  const TARGET_LNG = 119.66034190357468;
  const MAX_DIST = 100;
  
  let currentUserToken = null;
  let currentLat = 0, currentLng = 0, currentDist = 9999;

  function setDefaultTimes() {
    const now = new Date();
    const ymd = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0');
    document.getElementById('l-start').value = ymd + "T08:00";
    document.getElementById('l-end').value = ymd + "T16:30";
    document.getElementById('ot-start').value = ymd + "T08:00";
    document.getElementById('ot-end').value = ymd + "T16:30";
  }

  function handleCredentialResponse(response) {
    try {
      const payload = parseJwt(response.credential);
      currentUserToken = response.credential;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = payload.picture;
      setDefaultTimes();
      fetchProfile();
      startGPS();
    } catch (e) { alert("ç™»å…¥éŒ¯èª¤ï¼š" + e); }
  }

  function fetchProfile() {
    updateStatus("è®€å–è³‡æ–™ä¸­...", "loading");
    fetch(GAS_URL, { 
      method: "POST", 
      body: JSON.stringify({ action: "getProfile", credential: currentUserToken }) 
    })
    .then(r => r.json())
    .then(data => {
      updateStatus("", "");
      if(data.found) {
        document.getElementById('u-name').innerText = data.name || "æœªè¨­å®šå§“å";
        document.getElementById('u-company-display').innerText = data.company + " / " + data.dept;
        
        document.getElementById('dbName').value = data.name;
        document.getElementById('jobTitle').value = data.jobTitle;
        document.getElementById('company').value = data.company;
        document.getElementById('dept').value = data.dept;
        
        if(data.onboardDate) {
           document.getElementById('onboardDate').value = data.onboardDate;
           calcLeave(data.onboardDate);
        }
      } else {
        document.getElementById('u-name').innerText = "æ–°å“¡å·¥";
        document.getElementById('u-company-display').innerText = "è«‹ä¿®æ”¹è³‡æ–™";
        document.getElementById('meta-form').classList.remove('hidden');
      }
    });
  }

  function saveProfile() {
    const name = document.getElementById('dbName').value;
    if(!name) { alert("è«‹è¼¸å…¥å“¡å·¥å§“å"); return; }
    updateStatus("å„²å­˜ä¸­...", "loading");
    fetch(GAS_URL, { 
      method: "POST", 
      body: JSON.stringify({ 
        action: "updateProfile", credential: currentUserToken, 
        name: name, jobTitle: document.getElementById('jobTitle').value,
        company: document.getElementById('company').value, dept: document.getElementById('dept').value 
      }) 
    })
    .then(r => r.json())
    .then(res => {
      updateStatus(res.message, "success");
      document.getElementById('u-name').innerText = name;
      document.getElementById('u-company-display').innerText = document.getElementById('company').value + " / " + document.getElementById('dept').value;
      document.getElementById('meta-form').classList.add('hidden');
    });
  }

  function doClock(type) {
    if(!document.getElementById('company').value) { alert("è«‹å…ˆè¨­å®šè³‡æ–™"); return; }
    if(currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }
    updateStatus("æ‰“å¡ä¸­...", "loading");
    sendToGAS({ action: "clockIn", credential: currentUserToken, type: type, company: document.getElementById('company').value, dept: document.getElementById('dept').value, lat: currentLat, lng: currentLng });
  }

  function submitLeave() {
    updateStatus("å‚³é€å‡å–®...", "loading");
    sendToGAS({ action: "requestLeave", credential: currentUserToken, company: document.getElementById('company').value, dept: document.getElementById('dept').value, type: document.getElementById('leaveType').value, startDate: document.getElementById('l-start').value, endDate: document.getElementById('l-end').value });
  }
  
  function submitOvertime() {
    updateStatus("å‚³é€åŠ ç­...", "loading");
    sendToGAS({ action: "requestOvertime", credential: currentUserToken, overtimeType: document.getElementById('otType').value, startDate: document.getElementById('ot-start').value, endDate: document.getElementById('ot-end').value, company: document.getElementById('company').value, dept: document.getElementById('dept').value });
  }

  function loadHistory() {
    document.getElementById('history-list').innerHTML = "<p style='text-align:center'>è®€å–ä¸­...</p>";
    fetch(GAS_URL, { 
      method: "POST", 
      body: JSON.stringify({ action: "getHistory", credential: currentUserToken }) 
    })
    .then(r => r.json())
    .then(data => {
        let html = "";
        
        // è«‹å‡å€
        if(data.leave.length > 0) {
            html += `<div class="history-group"><div class="history-title">è«‹å‡ç”³è«‹</div>`;
            data.leave.forEach(item => {
               html += `<div class="history-item">
                          <span>${item.type} <br><small>${item.start.replace('T',' ')}</small></span>
                          <span class="status-badge status-wait">${item.status}</span>
                        </div>`; 
            });
            html += `</div>`;
        }

        // åŠ ç­å€
        if(data.overtime.length > 0) {
            html += `<div class="history-group"><div class="history-title">åŠ ç­ç”³è«‹</div>`;
            data.overtime.forEach(item => {
               html += `<div class="history-item">
                          <span>${item.type} <br><small>${item.start.replace('T',' ')}</small></span>
                          <span class="status-badge status-wait">${item.status}</span>
                        </div>`; 
            });
            html += `</div>`;
        }
        
        // æ‰“å¡å€
        html += `<div class="history-group"><div class="history-title">æœ€è¿‘æ‰“å¡</div>`;
        if(data.clock.length > 0) {
            data.clock.forEach(item => {
                let sClass = item.status === "æ­£å¸¸" ? "status-ok" : "status-no";
                html += `<div class="history-item"><span>${item.type} <small>${item.time}</small></span><span class="status-badge ${sClass}">${item.status}</span></div>`;
            });
        } else { html += "<p style='padding:5px;text-align:center;font-size:12px;'>ç„¡ç´€éŒ„</p>"; }
        html += `</div>`;

        document.getElementById('history-list').innerHTML = html;
    });
  }

  function calcLeave(dateStr) {
     if(!dateStr) return;
     fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "calculateLeave", startDate: dateStr }) })
     .then(r => r.json())
     .then(d => document.getElementById('leaveRes').innerText = d.days || 0);
  }

  function sendToGAS(data) {
    fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
    .then(r => r.json())
    .then(res => updateStatus(res.message, res.success ? "success" : "error"))
    .catch(e => updateStatus("é€£ç·šå¤±æ•—", "error"));
  }

  function updateStatus(msg, type) {
    const box = document.getElementById('status-box');
    box.innerText = msg;
    box.className = type;
  }
  
  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  function startGPS() {
    if(navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            currentDist = getDist(currentLat, currentLng, TARGET_LAT, TARGET_LNG);
            document.getElementById('dist-display').innerText = Math.round(currentDist);
        }, null, { enableHighAccuracy: true });
    }
  }

  function switchTab(t) {
    ['clock', 'leave', 'overtime', 'history'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
    if(t === 'history') loadHistory();
  }

  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  
  function getDist(lat1, lon1, lat2, lon2) {
    var R = 6371000, dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
</script>
</body>
</html>
