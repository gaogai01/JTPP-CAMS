<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none !important; }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; margin-top: 10px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; }
    
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-leave { background-color: #f9ab00; color: black; }
    .btn-ot { background-color: #6f42c1; color: white; }
    .btn-fix { background-color: #007bff; color: white; }
    .btn-edit { background-color: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-left: 10px; }
    
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    #user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 2px solid white; }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: bold; font-size: 16px; color: #1f1f1f; }
    
    .tabs { 
        display: flex; 
        margin-bottom: 15px; 
        background: linear-gradient(135deg, #1a73e8 0%, #6f42c1 100%);
        border-radius: 10px;
        padding: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .tab { 
        flex: 1; padding: 10px; text-align: center; cursor: pointer; color: white; 
        font-weight: bold; font-size: 14px; border-radius: 8px; transition: 0.2s;
    }
    .tab.active { background: white; color: #1a73e8; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; background: #eee; }

    /* GPS ç‹€æ…‹å¡ç‰‡æ¨£å¼ */
    .gps-box {
        text-align: center; padding: 30px 20px; border-radius: 16px; background: #f8f9fa;
        margin-bottom: 20px; border: 2px solid #e9ecef; transition: all 0.3s ease;
    }
    .gps-icon { font-size: 48px; display: block; margin-bottom: 10px; line-height: 1; }
    .gps-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .gps-desc { font-size: 14px; color: #666; }
    
    .gps-status-ok { background: #d4edda; border-color: #c3e6cb; color: #155724; }
    .gps-status-ok .gps-title { color: #155724; }
    .gps-status-ok .gps-desc { color: #155724; }

    .gps-status-err { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .gps-status-err .gps-title { color: #721c24; }
    .gps-status-err .gps-desc { color: #721c24; }

    .pulse-container { height: 50px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .pulse-dot { width: 20px; height: 20px; background: #1a73e8; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse {
        0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(26, 115, 232, 0); }
        100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
    }
    
    /* é¤˜é¡é¡¯ç¤ºå€å¡Š */
    .balance-box {
        background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; 
        margin-bottom: 10px; font-size: 14px; border: 1px solid #ffeeba;
        display: flex; justify-content: space-between; align-items: center;
    }
    .balance-val { font-weight: bold; font-size: 18px; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>
  <div id="login-section" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #fafafa; padding: 15px; margin-bottom: 15px; border-radius:8px;">
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        <label>åˆ°è·æ—¥</label><input type="date" id="onboardDate">
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è³‡æ–™</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">å¾…è¾¦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div class="pulse-container" id="gps-loading"><div class="pulse-dot"></div></div>
            <div id="gps-icon" class="gps-icon hidden"></div>
            <div class="gps-title" id="gps-title">æ­£åœ¨å®šä½ä¸­...</div>
            <div class="gps-desc" id="gps-desc">è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®æ¬Šé™</div>
        </div>

        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º</button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
        </div>
        <button class="btn-fix" onclick="toggleFix()" style="background:#444; margin-top:20px;">ğŸ› ï¸ ç”³è«‹è£œåˆ·å¡</button>
        
        <div id="fix-form" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <label>è£œå¡é¡å‹</label><select id="fixType"><option>ä¸Šç­</option><option>ä¸‹ç­</option></select>
            <label>æ—¥æœŸ</label><input type="date" id="fixDate">
            <label>æ™‚é–“</label><input type="time" id="fixTime">
            <label>äº‹ç”±</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">é€å‡ºè£œå¡</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <div class="balance-box" id="balance-display-box">
            <span id="balance-label">ç‰¹ä¼‘é¤˜é¡</span>
            <span>å‰©é¤˜ <span class="balance-val" id="balance-val">0</span> å¤©</span>
        </div>
        
        <label>å‡åˆ¥</label>
        <select id="leaveType" onchange="updateBalanceDisplay()">
            <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
            <option value="è£œä¼‘">è£œä¼‘</option>
            <option value="äº‹å‡">äº‹å‡</option>
            <option value="ç—…å‡">ç—…å‡</option>
        </select>
        
        <label>ä»£ç†äºº</label><select id="agentSelect"></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="l-start">
        <label>çµæŸ</label><input type="datetime-local" id="l-end">
        <button class="btn-leave" onclick="submitApp('leave')">é€å‡º</button>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%">ğŸ”„ åˆ·æ–°</button>
        <div id="ot-list-container"></div>
        <div id="review-list-container"></div>
    </div>

    <div id="tab-history" class="hidden">
        <div style="background:#fafafa; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #ddd;">
            <label style="margin-top:0">æŸ¥è©¢æœŸé–“</label>
            <div style="display:flex; gap:10px;">
                <input type="date" id="history-start" style="margin-bottom:0">
                <input type="date" id="history-end" style="margin-bottom:0">
            </div>
        </div>
        <button class="btn-edit" onclick="loadHistory()" style="width:100%">ğŸ”„ æŸ¥è©¢ç´€éŒ„</button>
        <div id="history-list" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7",
    measurementId: "G-LDV2MZFY26"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  const PLANT_LOCATION = { lat: 23.564675316036272, lng: 119.66034190357468 };
  const MAX_DIST = 100;
  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;
  
  // å‡åˆ¥é¤˜é¡æš«å­˜
  let leaveBalances = { annual: 0, comp: 0 }; 

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      
      // åˆå§‹åŒ–ç´€éŒ„æŸ¥è©¢æ—¥æœŸ (ç•¶æœˆ1è™Ÿ~æœˆåº•)
      initHistoryDates();
      
      await loadUserData(user);
      startGPS(); 
    }
  });

  // è¨­å®šæ—¥æœŸé è¨­å€¼
  function initHistoryDates() {
      const now = new Date();
      // ç•¶æœˆ 1 è™Ÿ
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      // ç•¶æœˆæœ€å¾Œä¸€å¤© (ä¸‹å€‹æœˆç¬¬0å¤©)
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      // è½‰æ›ç‚º YYYY-MM-DD æ ¼å¼
      const toISO = (d) => {
          const offset = d.getTimezoneOffset() * 60000;
          return new Date(d.getTime() - offset).toISOString().split('T')[0];
      };
      
      document.getElementById('history-start').value = toISO(firstDay);
      document.getElementById('history-end').value = toISO(lastDay);
  }

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        
        // è¨ˆç®—é¤˜é¡
        if(userData.onboardDate) {
            let totalAnnual = calculateLeave(userData.onboardDate);
            let usedAnnual = userData.leaveUsed || 0; // å·²ä¼‘ç‰¹ä¼‘
            let compTotal = userData.compLeaveTotal || 0; // è£œä¼‘ç¸½é¡ (éœ€è³‡æ–™åº«æœ‰æ¬„ä½)
            let compUsed = userData.compLeaveUsed || 0;   // å·²ä¼‘è£œä¼‘
            
            leaveBalances.annual = totalAnnual - usedAnnual;
            leaveBalances.comp = compTotal - compUsed;
            
            updateBalanceDisplay(); // æ›´æ–°ä»‹é¢é¡¯ç¤º
        }
        
        loadColleagues();
        loadTasks();
    } else {
        // æ–°ç”¨æˆ¶é è¨­å€¼
        userData = { 
            name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", 
            company: "", dept: "", createdAt: new Date().toISOString(),
            compLeaveTotal: 0, compLeaveUsed: 0, leaveUsed: 0
        };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        document.getElementById('meta-form').classList.remove('hidden');
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    document.getElementById('u-company-display').innerText = (data.company||"") + (data.role ? ` (${data.role})` : "");
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
  }
  
  // æ›´æ–°å‡åˆ¥é¤˜é¡é¡¯ç¤º
  function updateBalanceDisplay() {
      const type = document.getElementById('leaveType').value;
      const label = document.getElementById('balance-label');
      const val = document.getElementById('balance-val');
      const box = document.getElementById('balance-display-box');
      
      if (type === 'ç‰¹ä¼‘') {
          box.style.display = 'flex';
          box.style.background = '#fff3cd'; // é»ƒè‰²ç³»
          box.style.color = '#856404';
          label.innerText = "ç‰¹ä¼‘é¤˜é¡";
          val.innerText = leaveBalances.annual;
      } else if (type === 'è£œä¼‘') {
          box.style.display = 'flex';
          box.style.background = '#d1ecf1'; // è—è‰²ç³»
          box.style.color = '#0c5460';
          label.innerText = "è£œä¼‘é¤˜é¡";
          val.innerText = leaveBalances.comp;
      } else {
          // äº‹ç—…å‡ä¸é¡¯ç¤ºé¤˜é¡ï¼Œæˆ–æ˜¯é¡¯ç¤º N/A
          box.style.display = 'none';
      }
  }

  async function saveToFirebase() {
    const btn = document.querySelector('button[onclick="saveToFirebase()"]');
    btn.innerText = "å„²å­˜ä¸­..."; btn.disabled = true;
    try {
        const newData = {
            name: document.getElementById('dbName').value,
            jobTitle: document.getElementById('jobTitle').value,
            company: document.getElementById('company').value,
            dept: document.getElementById('dept').value,
            onboardDate: document.getElementById('onboardDate').value
        };
        if (!currentUser || !currentUser.email) throw new Error("å°šæœªç™»å…¥");
        await db.collection('cams_users').doc(currentUser.email).set(newData, { merge: true });
        alert("âœ… è³‡æ–™å„²å­˜æˆåŠŸï¼"); location.reload();
    } catch (error) {
        console.error(error); alert("âŒ å„²å­˜å¤±æ•—ï¼\n" + error.message);
    } finally { btn.innerText = "å„²å­˜è³‡æ–™"; btn.disabled = false; }
  }

  function startGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                currentLat = position.coords.latitude; currentLng = position.coords.longitude;
                currentDist = getDist(currentLat, currentLng, PLANT_LOCATION.lat, PLANT_LOCATION.lng);
                updateGpsUI(currentDist);
            },
            (err) => { 
                console.log(err); 
                document.getElementById('gps-title').innerText = "å®šä½å¤±æ•—";
                document.getElementById('gps-desc').innerText = "è«‹ç¢ºèªæ‰‹æ©Ÿå®šä½å·²é–‹å•Ÿ";
            },
            { enableHighAccuracy: true }
        );
    } else { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"); }
  }

  function updateGpsUI(dist) {
      const box = document.getElementById('gps-box');
      const iconDiv = document.getElementById('gps-icon');
      const loadDiv = document.getElementById('gps-loading');
      const title = document.getElementById('gps-title');
      const desc = document.getElementById('gps-desc');
      loadDiv.classList.add('hidden'); iconDiv.classList.remove('hidden');
      const distInt = Math.round(dist);
      if (dist <= MAX_DIST) {
          box.className = "gps-box gps-status-ok"; iconDiv.innerHTML = "âœ…";
          title.innerText = "å·²é€²å…¥æ‰“å¡ç¯„åœ"; desc.innerText = `è·é›¢ ${distInt}m (OK)`;
      } else {
          box.className = "gps-box gps-status-err"; iconDiv.innerHTML = "ğŸš«";
          title.innerText = "å°šæœªé€²å…¥ç¯„åœ"; desc.innerText = `è·é›¢ ${distInt}m (é™åˆ¶ ${MAX_DIST}m)`;
      }
  }

  function getDist(lat1, lon1, lat2, lon2) { 
      var R = 6371000; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180); 
      var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2); 
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  }

  async function doClock(type) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
    if (currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }
    try {
        await db.collection('cams_records').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            type: type, time: new Date(), lat: currentLat, lng: currentLng, status: "æ­£å¸¸"
        });
        alert(`æ‰“å¡æˆåŠŸï¼`); loadHistory();
    } catch (e) { alert("å¤±æ•—: " + e.message); }
  }

  // â˜… ä¿®æ”¹è™•ï¼šç´€éŒ„æŸ¥è©¢å¢åŠ æ—¥æœŸç¯©é¸
  async function loadHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = "<p style='text-align:center'>è¼‰å…¥ä¸­...</p>";
    
    // å–å¾—æ—¥æœŸç¯„åœ
    const sStr = document.getElementById('history-start').value;
    const eStr = document.getElementById('history-end').value;
    
    // è½‰æ›æˆ Date ç‰©ä»¶ (é–‹å§‹æ—¥çš„ 00:00:00 åˆ° çµæŸæ—¥çš„ 23:59:59)
    const startDate = new Date(sStr + "T00:00:00");
    const endDate = new Date(eStr + "T23:59:59");

    let html = "";
    try {
        // 1. è®€å–æ‰“å¡ç´€éŒ„ (å¢åŠ æ—¥æœŸç¯©é¸)
        // æ³¨æ„ï¼šé€™éœ€è¦è¤‡åˆç´¢å¼• (userId + time)
        const snap1 = await db.collection('cams_records')
            .where('userId', '==', currentUser.email)
            .where('time', '>=', startDate)
            .where('time', '<=', endDate)
            .orderBy('time', 'desc')
            .limit(20)
            .get();
        
        if(!snap1.empty) {
            html += `<p style="color:#666;border-bottom:1px solid #ddd">æ‰“å¡ç´€éŒ„ (${sStr}~${eStr})</p>`;
            snap1.forEach(doc => {
                let d = doc.data();
                let dateObj = d.time && d.time.toDate ? d.time.toDate() : new Date(d.time);
                let t = dateObj.toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
                html += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;">
                            <span>${d.type} <small style="color:#666">${t}</small></span>
                            <span class="badge">${d.status}</span>
                         </div>`;
            });
        } else {
            html += `<p style="color:#999; text-align:center;">æ­¤å€é–“ç„¡æ‰“å¡ç´€éŒ„</p>`;
        }

        // 2. è®€å–ç”³è«‹ç´€éŒ„ (å¢åŠ æ—¥æœŸç¯©é¸)
        const snap2 = await db.collection('cams_applications')
            .where('userId', '==', currentUser.email)
            .where('createdAt', '>=', startDate)
            .where('createdAt', '<=', endDate)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

        if(!snap2.empty) {
            html += `<p style="color:#666;border-bottom:1px solid #ddd;margin-top:15px;">ç”³è«‹ç´€éŒ„ (${sStr}~${eStr})</p>`;
            snap2.forEach(doc => {
                let d = doc.data();
                let s = d.status || {};
                let statusText = "è™•ç†ä¸­";
                if(s.client==='åŒæ„') statusText="âœ… æ ¸å‡†";
                else if(Object.values(s).includes('é€€å›')) statusText="âŒ é€€å›";
                
                html += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;">
                            <span>${d.type} <br><small>${d.startDate.replace('T',' ')}</small></span>
                            <span class="badge">${statusText}</span>
                         </div>`;
            });
        }
        
        list.innerHTML = html || "<p style='text-align:center'>ç„¡ç´€éŒ„</p>";

    } catch (e) {
        console.error("è®€å–ç´€éŒ„å¤±æ•—", e);
        if(e.message.includes("index")) {
            list.innerHTML = `<p style='color:red;text-align:center;font-size:13px;'>ç³»çµ±éœ€è¦å»ºç«‹ç´¢å¼•æ‰èƒ½ä¾æ—¥æœŸæŸ¥è©¢ã€‚<br><a href="${e.message.match(/https?:\/\/[^ ]+/)[0]}" target="_blank">é»æ­¤å»ºç«‹ç´¢å¼•(ç®¡ç†å“¡)</a></p>`;
        } else {
            list.innerHTML = `<p style='color:red;text-align:center'>éŒ¯èª¤: ${e.message}</p>`;
        }
    }
  }

  async function submitApp(cat) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
    
    let payload = {
        userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
        category: cat, createdAt: new Date(),
        status: { agent: "å¾…å¯©æ ¸", leader: "å¾…å¯©æ ¸", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" }
    };
    // é ˜ç­ä¸éœ€è¦é ˜ç­å¯©æ ¸
    if(userData.role === 'å¤–åŒ…é ˜ç­') payload.status.leader = "ä¸éœ€";

    if(cat === 'leave') {
        let agent = document.getElementById('agentSelect').value;
        if(!agent) { alert("è«‹é¸æ“‡ä»£ç†äºº"); return; }
        
        payload.type = document.getElementById('leaveType').value;
        payload.agentName = agent;
        payload.startDate = document.getElementById('l-start').value;
        payload.endDate = document.getElementById('l-end').value;
        
        // ç°¡æ˜“è¨ˆç®—å¤©æ•¸ (åƒ…ä¾›åƒè€ƒ)
        let s = new Date(payload.startDate), e = new Date(payload.endDate);
        let diff = (e - s) / (1000 * 3600 * 24);
        payload.duration = parseFloat(diff.toFixed(2));
    } 
    else if(cat === 'correction') {
        let date = document.getElementById('fixDate').value;
        let time = document.getElementById('fixTime').value;
        if(!date || !time) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
        payload.type = "è£œå¡-" + document.getElementById('fixType').value;
        payload.startDate = date + "T" + time;
        payload.reason = document.getElementById('fixReason').value;
        payload.status = { boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" }; // è£œå¡åªéœ€è€é—†å’Œç”²æ–¹
    }

    try {
        await db.collection('cams_applications').add(payload);
        alert("ç”³è«‹å·²é€å‡º"); 
        if(cat==='correction') toggleFix();
        loadHistory();
    } catch(e) { alert("å¤±æ•—:" + e.message); }
  }

  function switchTab(t) {
    ['clock','leave','history','task'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
        document.getElementById('tab-btn-'+id).classList.remove('active');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.getElementById('tab-btn-'+t).classList.add('active');
    if(t==='history') loadHistory();
    if(t==='task') loadTasks();
  }

  async function loadColleagues() {
      if(!userData.company) return;
      const sel = document.getElementById('agentSelect');
      const snap = await db.collection('cams_users').where('company', '==', userData.company).get();
      sel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>";
      snap.forEach(doc => {
          let u = doc.data();
          if(u.email !== currentUser.email) sel.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      });
  }
  
  async function loadTasks() { /* å¾…è¾¦é‚è¼¯ç¶­æŒåŸæ¨£ */ }
  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  function toggleFix() { document.getElementById('fix-form').classList.toggle('hidden'); }
  
  // ç‰¹ä¼‘è¨ˆç®—å…¬å¼
  function calculateLeave(dateStr) { 
      if(!dateStr) return 0; 
      let start=new Date(dateStr), now=new Date(), m=(now.getFullYear()-start.getFullYear())*12+(now.getMonth()-start.getMonth()); 
      if(m<6)return 0; if(m<12)return 3; if(m<24)return 7; if(m<36)return 10; if(m<60)return 14; if(m<120)return 15; 
      return Math.min(30, 16+Math.floor((m-120)/12)); 
  }
</script>
</body>
</html>
