<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f4f7f6; margin: 0; color: #333; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 80vh; position: relative; }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
    .hidden { display: none !important; }
    
    /* --- è¼‰å…¥é®ç½© --- */
    #loading-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 99;
        display: flex; justify-content: center; align-items: center; border-radius: 16px; font-weight: bold; color: #666;
    }

    /* --- è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• --- */
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fff; }
    label { font-weight: 600; display: block; margin-bottom: 6px; color: #555; font-size: 14px; }
    
    button { padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button:active { transform: scale(0.98); }

    .btn-in { background: linear-gradient(135deg, #3b82f6, #2563eb); } 
    .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .btn-leave { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-search { background: #64748b; margin-top: 0; font-size: 14px; padding: 10px; } 
    .btn-fix { background: #4b5563; }
    .btn-edit { background: #94a3b8; font-size: 12px; padding: 6px 12px; width: auto; margin-left: auto; border-radius: 20px; }
    .btn-approve { background: #10b981; margin-top:5px; padding: 10px; }
    .btn-reject { background: #ef4444; margin-top:5px; padding: 10px; }
    
    /* --- ä½¿ç”¨è€…è³‡è¨Šå¡ --- */
    #user-info { display: flex; align-items: center; background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    #user-info img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: 800; font-size: 18px; color: #1e293b; }
    .user-meta { font-size: 13px; color: #64748b; margin-top: 2px; }

    /* --- é¸å–® Tabs (ä¸»é¸å–®) --- */
    .tabs { display: flex; margin-bottom: 20px; background: white; border-radius: 12px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #64748b; font-weight: bold; font-size: 14px; border-radius: 8px; transition: 0.3s; }
    .tab.active { background: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(59,130,246,0.3); }

    /* --- å­é¸å–® Tabs (ç´€éŒ„é ç”¨) --- */
    .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
    .sub-tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; color: #666; background: #f1f5f9; font-size: 13px; border-radius: 6px; white-space: nowrap; }
    .sub-tab.active { background: #64748b; color: white; font-weight: bold; }

    /* --- GPS å¡ç‰‡ --- */
    .gps-box { text-align: center; padding: 20px; border-radius: 12px; background: #f8fafc; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .gps-icon { font-size: 40px; display: block; margin-bottom: 8px; }
    .gps-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 4px; }
    .gps-desc { font-size: 13px; color: #666; }
    .gps-status-ok { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    .gps-status-ok .gps-title { color: #15803d; }
    .gps-status-err { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
    .gps-status-err .gps-title { color: #b91c1c; }
    .pulse-container { height: 30px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .pulse-dot { width: 15px; height: 15px; background: #3b82f6; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 70% { transform: scale(1); opacity: 0; } 100% { transform: scale(0.9); opacity: 0; } }

    /* --- ç´€éŒ„æŸ¥è©¢ç¾åŒ– --- */
    .search-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .date-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .date-row input { margin-bottom: 0; flex: 1; }
    
    .history-card {
        background: white; border: 1px solid #f1f5f9; border-radius: 10px; padding: 15px; 
        margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .h-info { display: flex; flex-direction: column; }
    .h-main { font-weight: bold; font-size: 15px; color: #333; }
    .h-sub { font-size: 12px; color: #64748b; margin-top: 4px; }
    .h-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; text-align: center; }
    .badge-gray { background: #eee; color: #555; }
    .badge-green { background: #dcfce7; color: #166534; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-orange { background: #ffedd5; color: #9a3412; }

    /* --- é¤˜é¡èˆ‡è«‹å‡èª¿æ•´ --- */
    .balance-box { background: #fffbeb; color: #92400e; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #fcd34d; display: none; justify-content: space-between; align-items: center; }
    .balance-val { font-weight: bold; font-size: 18px; }
    
    /* ä¿®æ­£æ—¥æœŸè¼¸å…¥æ¡†è·‘ç‰ˆå•é¡Œ */
    .leave-time-group { display: flex; flex-direction: column; gap: 5px; }
    .leave-time-row { display: flex; align-items: center; gap: 10px; }
    .leave-time-row label { width: 40px; margin: 0; font-weight: normal; font-size: 13px; }
    
    .calc-hint { text-align: right; font-size: 14px; color: #2563eb; margin-bottom: 10px; font-weight: bold; border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 5px; }

    /* å¾…è¾¦å¡ç‰‡ */
    .task-card { border: 2px solid #3b82f6; background: #eff6ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
    .task-title { font-weight: bold; color: #1e40af; margin-bottom: 5px; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <div id="loading-screen">ç³»çµ±è¼‰å…¥ä¸­...</div>

  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>
  
  <div id="login-section" class="hidden" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹è³‡æ–™</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #f8fafc; padding: 20px; margin-bottom: 20px; border-radius:12px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0; color:#333;">ğŸ‘¤ å€‹äººæª”æ¡ˆ</h4>
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        
        <label>æ‰€å±¬ç¾¤çµ„ (å½±éŸ¿ä¸‹ç­èˆ‡ä¼‘æ¯æ™‚é–“)</label>
        <select id="workShift" disabled style="background:#eee;">
            <option value="">è«‹é¸æ“‡</option>
            <option value="normal">æ­£å¸¸ç­ (08:00~16:30, ä¼‘12:00~12:30)</option>
            <option value="cleaning">æ¸…æ½”ç­ (08:00~17:00, ä¼‘12:00~13:00)</option>
        </select>

        <label>åˆ°è·æ—¥</label><input type="date" id="onboardDate" disabled style="background:#eee;">
        
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è®Šæ›´</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">å¾…è¾¦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div class="pulse-container" id="gps-loading"><div class="pulse-dot"></div></div>
            <div id="gps-icon" class="gps-icon hidden"></div>
            <div class="gps-title" id="gps-title">å®šä½ä¸­...</div>
            <div class="gps-desc" id="gps-desc">è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®æ¬Šé™</div>
        </div>

        <div class="btn-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><small>08:00 (å½ˆæ€§15åˆ†)</small></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">å¤–å‡º/å…¬å‹™</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><small>è¦–ç¾¤çµ„è¨ˆç®—</small></button>
            <button class="btn-leave" onclick="doClock('è¿”å›')">è¿”å›/éŠ·å‡</button>
        </div>
        
        <button class="btn-fix" onclick="toggleFix()" style="margin-top:20px;">ğŸ› ï¸ ç”³è«‹è£œåˆ·å¡ (å¿˜è¨˜æ‰“å¡)</button>
        <div id="fix-form" class="hidden" style="margin-top:10px; background:#f1f5f9; padding:15px; border-radius:10px;">
            <label>é¡å‹</label><select id="fixType"><option>ä¸Šç­</option><option>ä¸‹ç­</option></select>
            <label>æ—¥æœŸ</label><input type="date" id="fixDate">
            <label>æ™‚é–“</label><input type="time" id="fixTime">
            <label>äº‹ç”±</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">é€å‡ºç”³è«‹</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <div class="balance-box" id="balance-display-box">
            <span id="balance-label">ç‰¹ä¼‘é¤˜é¡</span>
            <span>å‰©é¤˜ <span class="balance-val" id="balance-val">0</span> å¤©</span>
        </div>
        
        <label>å‡åˆ¥</label>
        <select id="leaveType" onchange="updateBalanceDisplay()">
            <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
            <option value="è£œä¼‘">è£œä¼‘</option>
            <option value="äº‹å‡">äº‹å‡</option>
            <option value="ç—…å‡">ç—…å‡</option>
        </select>
        
        <label>ä»£ç†äºº</label><select id="agentSelect"></select>
        
        <label>è«‹å‡æœŸé–“</label>
        <div class="leave-time-group">
            <div class="leave-time-row">
                <label>é–‹å§‹</label>
                <input type="datetime-local" id="l-start">
            </div>
            <div class="leave-time-row">
                <label>çµæŸ</label>
                <input type="datetime-local" id="l-end">
            </div>
        </div>
        
        <div class="calc-hint" id="calc-result">åˆè¨ˆï¼š0 å°æ™‚ (æœªæ‰£é™¤ä¼‘æ¯)</div>

        <button class="btn-leave" onclick="submitApp('leave')">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%; margin-bottom:15px;">ğŸ”„ åˆ·æ–°å¾…è¾¦</button>
        <div id="task-list">
            <p style="text-align:center; color:#999;">æš«ç„¡å¾…è¾¦äº‹é …</p>
        </div>
    </div>

    <div id="tab-history" class="hidden">
        <div class="sub-tabs">
            <div id="sub-clock" class="sub-tab active" onclick="switchHistorySub('clock')">ğŸ•’ åˆ·å¡æŸ¥è©¢</div>
            <div id="sub-leave" class="sub-tab" onclick="switchHistorySub('leave')">ğŸ“„ è«‹å‡æŸ¥è©¢</div>
            <div id="sub-overtime" class="sub-tab" onclick="switchHistorySub('overtime')">ğŸ’ª åŠ ç­æŸ¥è©¢</div>
        </div>

        <div class="search-box">
            <label>æŸ¥è©¢æœŸé–“</label>
            <div class="date-row">
                <input type="date" id="history-start">
                <span>~</span>
                <input type="date" id="history-end">
            </div>
            <button class="btn-search" onclick="loadCurrentHistory()">ğŸ” æŸ¥è©¢</button>
        </div>
        
        <div id="history-list"></div>
    </div>

  </div> </div>

<script>
  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // é›»å» åº§æ¨™
  const PLANT_LOCATION = { lat: 23.564675316036272, lng: 119.66034190357468 };
  const MAX_DIST = 500; // æ¸¬è©¦ç”¨å¯¬é¬†è·é›¢
  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;
  let leaveBalances = { annual: 0, comp: 0 };
  let currentHistoryType = 'clock'; // ç•¶å‰ç´€éŒ„æŸ¥è©¢é¡å‹

  // â˜… ç¾¤çµ„èˆ‡å·¥æ™‚å®šç¾© (æ›´æ–°)
  const SHIFTS = {
      "normal": { 
          name: "æ­£å¸¸ç­", 
          workHrs: 8.0, 
          breakStart: "12:00", breakEnd: "12:30", breakDur: 0.5,
          desc: "08:00~16:30 (ä¼‘0.5h)" 
      }, 
      "cleaning": { 
          name: "æ¸…æ½”ç­", 
          workHrs: 8.0, 
          breakStart: "12:00", breakEnd: "13:00", breakDur: 1.0,
          desc: "08:00~17:00 (ä¼‘1.0h)" 
      }
  };

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  // â˜… Auth ç›£è½ (ç™»å…¥ç‹€æ…‹ä¿æŒ)
  auth.onAuthStateChanged(async (user) => {
    document.getElementById('loading-screen').classList.add('hidden'); // éš±è—é®ç½©
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      
      initHistoryDates(); // åˆå§‹åŒ–æŸ¥è©¢æ—¥æœŸ
      initDefaultTimes(); // åˆå§‹åŒ–è«‹å‡/è£œå¡æ—¥æœŸ
      
      await loadUserData(user);
      startGPS();
    } else {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('main-section').classList.add('hidden');
    }
  });

  // åˆå§‹åŒ–æ™‚é–“é è¨­å€¼
  function initDefaultTimes() {
      const now = new Date();
      // è½‰æ›ç‚ºç•¶åœ°æ™‚é–“å­—ä¸² (è§£æ±ºæ™‚å€å•é¡Œ)
      const toLocalYMD = (d) => {
          const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
          return z.toISOString().split('T')[0];
      };
      
      const ymd = toLocalYMD(now);
      
      // è£œå¡
      document.getElementById('fixDate').value = ymd;
      document.getElementById('fixTime').value = "08:00";

      // è«‹å‡ (é è¨­ä»Šå¤© 08:00 ~ 16:30)
      document.getElementById('l-start').value = ymd + "T08:00";
      document.getElementById('l-end').value = ymd + "T16:30";
      
      // è§¸ç™¼ä¸€æ¬¡è¨ˆç®—
      setTimeout(calculateDuration, 500); 
  }

  // â˜… è«‹å‡æ™‚æ•¸è¨ˆç®— (å«æ‰£é™¤ä¼‘æ¯æ™‚é–“)
  function calculateDuration() {
      const sVal = document.getElementById('l-start').value;
      const eVal = document.getElementById('l-end').value;
      const resDiv = document.getElementById('calc-result');
      
      if(!sVal || !eVal) return;
      
      let start = new Date(sVal);
      let end = new Date(eVal);
      
      if(end <= start) {
          resDiv.innerText = "çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“";
          resDiv.style.color = "red";
          return;
      }

      // å–å¾—ç­åˆ¥è¨­å®š (é è¨­æ­£å¸¸ç­)
      const shiftKey = userData.workShift || "normal";
      const shift = SHIFTS[shiftKey];
      
      // è¨ˆç®—ç¸½æ™‚æ•¸ (å°æ•¸)
      let diffMs = end - start;
      let diffHrs = diffMs / (1000 * 60 * 60);

      // æª¢æŸ¥æ˜¯å¦è·¨è¶Šä¼‘æ¯æ™‚é–“
      // å»ºç«‹ä¼‘æ¯é–‹å§‹èˆ‡çµæŸçš„ Date ç‰©ä»¶ (ä»¥é–‹å§‹æ—¥æœŸçš„å¹´æœˆæ—¥ç‚ºæº–ï¼Œå‡è¨­è«‹å‡é€šå¸¸ä¸è·¨æ—¥æˆ–è·¨æ—¥é‚è¼¯ç°¡åŒ–)
      // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šå¦‚æœè«‹å‡å€é–“åŒ…å¤¾äº†ä¼‘æ¯å€é–“ï¼Œå°±æ‰£æ‰ä¼‘æ¯æ™‚é–“ã€‚
      // ç‚ºäº†æ”¯æ´è·¨æ—¥ï¼Œæˆ‘å€‘é‡å°æ¯ä¸€å¤©è¿´åœˆè¨ˆç®—æ¯”è¼ƒæº–ç¢ºï¼Œä½†é€™è£¡å…ˆåšã€Œå–®æ—¥ã€æˆ–ã€Œè·¨åˆä¼‘ã€çš„ç°¡å–®åˆ¤æ–·
      
      let breakStart = new Date(start); 
      let [bh, bm] = shift.breakStart.split(':');
      breakStart.setHours(bh, bm, 0, 0);

      let breakEnd = new Date(start);
      let [eh, em] = shift.breakEnd.split(':');
      breakEnd.setHours(eh, em, 0, 0);

      // åˆ¤æ–·é‡ç–Šï¼šè«‹å‡é–‹å§‹ < ä¼‘æ¯çµæŸ ä¸” è«‹å‡çµæŸ > ä¼‘æ¯é–‹å§‹
      if (start < breakEnd && end > breakStart) {
          // ç¢ºå¯¦æœ‰é‡ç–Šï¼Œæ‰£é™¤ä¼‘æ¯æ™‚æ•¸
          diffHrs -= shift.breakDur;
          resDiv.innerHTML = `åˆè¨ˆï¼š${diffHrs.toFixed(1)} å°æ™‚ (å·²æ‰£é™¤ ${shift.breakDur}h ä¼‘æ¯)`;
      } else {
          resDiv.innerHTML = `åˆè¨ˆï¼š${diffHrs.toFixed(1)} å°æ™‚`;
      }
      
      // å¤©æ•¸æ›ç®— (é™¤ä»¥ 8)
      const days = (diffHrs / 8).toFixed(1);
      resDiv.innerHTML += ` (ç´„ ${days} å¤©)`;
      resDiv.style.color = "#2563eb";
  }
  document.getElementById('l-start').addEventListener('change', calculateDuration);
  document.getElementById('l-end').addEventListener('change', calculateDuration);

  function initHistoryDates() {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1); 
      const last = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
      const toYMD = d => {
          const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
          return z.toISOString().split('T')[0];
      };
      document.getElementById('history-start').value = toYMD(first);
      document.getElementById('history-end').value = toYMD(last);
  }

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        if(userData.onboardDate) {
            leaveBalances.annual = 7; // ç¯„ä¾‹å€¼ï¼Œéœ€å¯¦ä½œ calculateAnnual
            leaveBalances.comp = (userData.compTotal || 0) - (userData.compUsed || 0);
            updateBalanceDisplay();
        }
        loadColleagues();
        loadTasks(); // è¼‰å…¥å¾…è¾¦
    } else {
        userData = { 
            name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", 
            workShift: "normal", createdAt: new Date().toISOString() 
        };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        toggleEditMode();
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    const shiftName = SHIFTS[data.workShift] ? SHIFTS[data.workShift].name : "æœªè¨­å®š";
    document.getElementById('u-company-display').innerText = (data.company||"æœªè¨­å®š") + ` / ${shiftName}`;
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
    document.getElementById('workShift').value = data.workShift || "normal";
  }

  function updateBalanceDisplay() {
      const type = document.getElementById('leaveType').value;
      const box = document.getElementById('balance-display-box');
      if (type === 'ç‰¹ä¼‘' || type === 'è£œä¼‘') {
          box.style.display = 'flex';
          document.getElementById('balance-label').innerText = type + "é¤˜é¡";
          document.getElementById('balance-val').innerText = type==='ç‰¹ä¼‘'? leaveBalances.annual : leaveBalances.comp;
      } else {
          box.style.display = 'none';
      }
  }

  // â˜… å¾…è¾¦äº‹é … (Tasks) æŸ¥è©¢é‚è¼¯
  async function loadTasks() {
      const list = document.getElementById('task-list');
      list.innerHTML = "æŸ¥è©¢ä¸­...";
      
      let html = "";
      
      try {
          // 1. æŸ¥è©¢å¾…ç¢ºèªçš„åŠ ç­å–® (category='overtime', email=me, status.employee='å¾…ç¢ºèª')
          const q1 = await db.collection('cams_applications')
              .where('email', '==', currentUser.email)
              .where('category', '==', 'overtime')
              .where('status.employee', '==', 'å¾…ç¢ºèª')
              .get();
              
          q1.forEach(doc => {
              const d = doc.data();
              html += `
              <div class="task-card">
                  <div class="task-title">âš ï¸ åŠ ç­æŒ‡æ´¾ç¢ºèª</div>
                  <div>æ—¥æœŸï¼š${d.startDate.replace('T',' ')} ~ ${d.endDate.split('T')[1]}</div>
                  <div>äº‹ç”±ï¼š${d.reason}</div>
                  <div style="text-align:right;">
                      <button class="btn-approve" onclick="replyTask('${doc.id}','overtime','åŒæ„')">æ¥å—</button>
                      <button class="btn-reject" onclick="replyTask('${doc.id}','overtime','é€€å›')">æ‹’çµ•</button>
                  </div>
              </div>`;
          });

          // 2. æŸ¥è©¢å¾…å¯©æ ¸çš„è«‹å‡ä»£ç† (category='leave', agentName=æˆ‘çš„åå­—, status.agent='å¾…å¯©æ ¸')
          // æ³¨æ„ï¼šé€™è£¡ç”¨ name æŸ¥è©¢å¯èƒ½ä¸æº–ï¼Œæœ€å¥½ç”¨ emailã€‚å¦‚æœè³‡æ–™åº«å­˜çš„æ˜¯ nameï¼Œå°±ç”¨ nameã€‚
          const q2 = await db.collection('cams_applications')
              .where('category', '==', 'leave')
              .where('agentName', '==', userData.name) 
              .where('status.agent', '==', 'å¾…å¯©æ ¸')
              .get();
              
          q2.forEach(doc => {
              const d = doc.data();
              html += `
              <div class="task-card" style="border-color:#f59e0b; background:#fffbeb;">
                  <div class="task-title" style="color:#92400e;">âš ï¸ è«‹å‡ä»£ç†ç¢ºèª</div>
                  <div>ç”³è«‹äººï¼š${d.name}</div>
                  <div>æ™‚é–“ï¼š${d.startDate.replace('T',' ')}</div>
                  <div style="text-align:right;">
                      <button class="btn-approve" onclick="replyTask('${doc.id}','leave','åŒæ„')">åŒæ„ä»£ç†</button>
                      <button class="btn-reject" onclick="replyTask('${doc.id}','leave','é€€å›')">æ‹’çµ•</button>
                  </div>
              </div>`;
          });

          if(html === "") html = "<p style='text-align:center;color:#999;padding:20px;'>ğŸ‰ ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …</p>";
          list.innerHTML = html;

      } catch(e) {
          list.innerHTML = `<p style="color:red">æŸ¥è©¢å¤±æ•—: ${e.message}</p>`;
      }
  }

  async function replyTask(id, type, decision) {
      if(!confirm(`ç¢ºå®šè¦ ${decision} å—ï¼Ÿ`)) return;
      let update = {};
      if(type === 'overtime') update = { 'status.employee': decision };
      if(type === 'leave') update = { 'status.agent': decision };
      
      await db.collection('cams_applications').doc(id).update(update);
      alert("å·²æ›´æ–°ç‹€æ…‹");
      loadTasks();
  }

  // â˜… ç´€éŒ„æŸ¥è©¢ (ä¸‰åˆä¸€)
  function switchHistorySub(type) {
      currentHistoryType = type;
      // UI åˆ‡æ›
      document.querySelectorAll('.sub-tab').forEach(el => el.classList.remove('active'));
      document.getElementById('sub-'+type).classList.add('active');
      loadCurrentHistory();
  }

  async function loadCurrentHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = "<p style='text-align:center;color:#999;'>è¼‰å…¥ä¸­...</p>";
      
      const sStr = document.getElementById('history-start').value;
      const eStr = document.getElementById('history-end').value;
      const startD = new Date(sStr + "T00:00:00");
      const endD = new Date(eStr + "T23:59:59");

      try {
          let html = "";
          
          // 1. åˆ·å¡æŸ¥è©¢ (Query cams_records)
          if(currentHistoryType === 'clock') {
              const q = await db.collection('cams_records')
                  .where('userId', '==', currentUser.email)
                  .where('time', '>=', startD).where('time', '<=', endD)
                  .orderBy('time', 'desc').limit(50).get();
              
              if(q.empty) html = "<p style='text-align:center'>æŸ¥ç„¡åˆ·å¡ç´€éŒ„</p>";
              else {
                  q.forEach(doc => {
                      const d = doc.data();
                      const t = d.time.toDate();
                      const timeStr = `${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
                      let badgeColor = d.status.includes('ç•°å¸¸') ? 'badge-red' : (d.status.includes('è£œå¡') ? 'badge-blue' : 'badge-green');
                      html += `
                      <div class="history-card">
                          <div class="h-info">
                              <span class="h-main">${d.type}</span>
                              <span class="h-sub">${timeStr}</span>
                          </div>
                          <span class="h-badge ${badgeColor}">${d.status}</span>
                      </div>`;
                  });
              }
          }
          // 2. è«‹å‡èˆ‡åŠ ç­ (Query cams_applications)
          else {
              let cat = currentHistoryType === 'leave' ? 'leave' : 'overtime';
              let q = await db.collection('cams_applications')
                  .where('userId', '==', currentUser.email)
                  .where('category', '==', cat)
                  .where('createdAt', '>=', startD).where('createdAt', '<=', endD)
                  .orderBy('createdAt', 'desc').get();

              if(q.empty) html = "<p style='text-align:center'>æŸ¥ç„¡ç´€éŒ„</p>";
              else {
                  q.forEach(doc => {
                      const d = doc.data();
                      const s = d.status;
                      // è§£æç‹€æ…‹ï¼Œæ‰¾å‡ºã€Œé‚„æ²’é»çš„äººã€
                      let statusText = "å·²æ ¸å‡†";
                      let badgeColor = "badge-green";
                      
                      // æª¢æŸ¥é †åº Agent -> Leader -> Boss -> Client
                      if(s.agent === 'å¾…å¯©æ ¸') { statusText = "ç­‰å¾… ä»£ç†äºº"; badgeColor = "badge-orange"; }
                      else if(s.agent === 'é€€å›') { statusText = "ä»£ç†äºº é€€å›"; badgeColor = "badge-red"; }
                      else if(s.leader === 'å¾…å¯©æ ¸') { statusText = "ç­‰å¾… é ˜ç­"; badgeColor = "badge-orange"; }
                      else if(s.leader === 'é€€å›') { statusText = "é ˜ç­ é€€å›"; badgeColor = "badge-red"; }
                      else if(s.boss === 'å¾…å¯©æ ¸') { statusText = "ç­‰å¾… è€é—†"; badgeColor = "badge-orange"; }
                      else if(s.boss === 'é€€å›') { statusText = "è€é—† é€€å›"; badgeColor = "badge-red"; }
                      else if(s.client === 'å¾…å¯©æ ¸') { statusText = "ç­‰å¾… ç”²æ–¹"; badgeColor = "badge-orange"; }
                      else if(s.client === 'é€€å›') { statusText = "ç”²æ–¹ é€€å›"; badgeColor = "badge-red"; }
                      
                      // å“¡å·¥è‡ªå·±æœªç¢ºèªåŠ ç­
                      if(cat === 'overtime' && s.employee === 'å¾…ç¢ºèª') { statusText = "ç­‰å¾… æ‚¨ç¢ºèª"; badgeColor = "badge-blue"; }

                      html += `
                      <div class="history-card">
                          <div class="h-info">
                              <span class="h-main">${d.type || d.reason}</span>
                              <span class="h-sub">${d.startDate.replace('T',' ')}</span>
                          </div>
                          <span class="h-badge ${badgeColor}">${statusText}</span>
                      </div>`;
                  });
              }
          }
          list.innerHTML = html;
      } catch(e) {
          list.innerHTML = `<p style="color:red; text-align:center">æŸ¥è©¢éŒ¯èª¤ (å¯èƒ½éœ€å»ºç«‹ç´¢å¼•)</p><p style="font-size:12px;color:#999;">${e.message}</p>`;
      }
  }

  // â˜… å…¶ä»–æ ¸å¿ƒå‡½å¼
  async function doClock(type) {
      if(!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
      if(currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }
      const now = new Date();
      // ä¸Šä¸‹ç­é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥å¾®ç°¡åŒ–é¡¯ç¤º)
      try {
          await db.collection('cams_records').add({
              userId: currentUser.email, name: userData.name, email: currentUser.email, 
              company: userData.company, dept: userData.dept,
              type: type, time: now, lat: currentLat, lng: currentLng, status: "æ­£å¸¸"
          });
          alert("æ‰“å¡æˆåŠŸ");
          switchTab('history');
      } catch(e) { alert(e.message); }
  }

  async function submitApp(cat) {
    if(cat === 'leave') {
        const s = document.getElementById('l-start').value;
        const e = document.getElementById('l-end').value;
        const agent = document.getElementById('agentSelect').value;
        if(!agent) { alert("è«‹é¸æ“‡ä»£ç†äºº"); return; }
        
        await db.collection('cams_applications').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, 
            company: userData.company, dept: userData.dept,
            category: 'leave', type: document.getElementById('leaveType').value,
            startDate: s, endDate: e, agentName: agent, createdAt: new Date(),
            status: { agent: "å¾…å¯©æ ¸", leader: "å¾…å¯©æ ¸", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" }
        });
        alert("å‡å–®å·²é€å‡º"); switchTab('history');
    }
    // ...correction logic...
  }

  // GPS & å…¶ä»–
  function startGPS() {
      if(navigator.geolocation) {
          navigator.geolocation.watchPosition(p => {
              document.getElementById('gps-loading').classList.add('hidden');
              document.getElementById('gps-icon').classList.remove('hidden');
              currentLat = p.coords.latitude; currentLng = p.coords.longitude;
              currentDist = getDist(currentLat, currentLng, PLANT_LOCATION.lat, PLANT_LOCATION.lng);
              const box = document.getElementById('gps-box');
              if(currentDist <= MAX_DIST) {
                  box.className = "gps-box gps-status-ok"; 
                  document.getElementById('gps-icon').innerHTML = "âœ…";
                  document.getElementById('gps-title').innerText = "å·²é€²å…¥æ‰“å¡ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)}m (OK)`;
              } else {
                  box.className = "gps-box gps-status-err"; 
                  document.getElementById('gps-icon').innerHTML = "ğŸš«";
                  document.getElementById('gps-title').innerText = "å°šæœªé€²å…¥ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)}m`;
              }
          }, e => console.log(e), {enableHighAccuracy:true});
      }
  }
  function getDist(lat1, lon1, lat2, lon2) {
      const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function switchTab(t) {
    ['clock','leave','history','task'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
        document.getElementById('tab-btn-'+id).classList.remove('active');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.getElementById('tab-btn-'+t).classList.add('active');
    if(t==='history') loadCurrentHistory();
    if(t==='task') loadTasks();
  }
  
  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  function toggleFix() { document.getElementById('fix-form').classList.toggle('hidden'); }
  
  async function loadColleagues() {
      if(!userData.company) return;
      const sel = document.getElementById('agentSelect');
      const snap = await db.collection('cams_users').where('company', '==', userData.company).get();
      sel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>";
      snap.forEach(doc => {
          let u = doc.data();
          if(u.email !== currentUser.email) sel.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      });
  }
  async function saveToFirebase() { /* ... */ }
</script>
</body>
</html>
