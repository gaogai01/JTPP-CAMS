<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
    .hidden { display: none !important; }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; margin-top: 10px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; }
    
    .btn-in { background-color: #1a73e8; } 
    .btn-out { background-color: #d93025; }
    .btn-leave { background-color: #f9ab00; color: black; }
    .btn-ot { background-color: #6f42c1; }
    .btn-edit { background-color: #6c757d; font-size: 12px; padding: 5px 10px; width: auto; margin-left: 10px; }
    
    #user-info { display: flex; align-items: center; background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    #user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 2px solid white; }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: bold; font-size: 16px; color: #1f1f1f; }
    .user-meta { font-size: 13px; color: #666; margin-top: 2px; }
    
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; overflow-x: auto; }
    .tab { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; color: #666; font-weight: bold; white-space: nowrap; font-size: 14px; }
    .tab.active { border-bottom: 3px solid #1a73e8; color: #1a73e8; }
    
    .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; background: #eee; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>

  <div id="login-section" style="text-align:center; padding: 40px 0;">
    <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–è³‡æ–™ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #fafafa; padding: 15px; margin-bottom: 15px; border-radius:8px;">
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        <label>åˆ°è·æ—¥ (ç‰¹ä¼‘è¨ˆç®—ç”¨)</label><input type="date" id="onboardDate">
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è³‡æ–™</button>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div class="tab" onclick="switchTab('overtime')">åŠ ç­</div>
      <div class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <p style="text-align:center; color:#555; margin-bottom:10px;">ğŸ“ GPS: <span id="dist-display" style="color:blue">å®šä½ä¸­...</span></p>
        <div class="btn-grid">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><small>(08:00å‰)</small></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">è«‹å‡/å¤–å‡º<br><small>(ç´€éŒ„)</small></button>
            <button class="btn-back" onclick="doClock('è¿”å›')">éŠ·å‡/è¿”å›<br><small>(ç´€éŒ„)</small></button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><small>(16:30å¾Œ)</small></button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <div style="background:#fff3cd; padding:10px; border-radius:5px; margin-bottom:10px; font-size:13px;">
            ç‰¹ä¼‘è©¦ç®—ï¼š<b id="leave-days" style="color:blue">0</b> å¤©
        </div>
        <label>å‡åˆ¥</label><select id="leaveType"><option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option></select>
        <label>è·å‹™ä»£ç†äºº</label><input type="text" id="agentName" placeholder="è«‹è¼¸å…¥åŒå…¬å¸ä»£ç†äººå§“å">
        <label>é–‹å§‹</label><input type="datetime-local" id="l-start" step="1800">
        <label>çµæŸ</label><input type="datetime-local" id="l-end" step="1800">
        <button class="btn-leave" onclick="submitApp('leave')">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-overtime" class="hidden">
        <label>æ–¹å¼</label><select id="otType"><option>ç”³è«‹åŠ ç­è²»</option><option>ç”³è«‹è£œä¼‘</option></select>
        <label>é–‹å§‹</label><input type="datetime-local" id="ot-start" step="1800">
        <label>çµæŸ</label><input type="datetime-local" id="ot-end" step="1800">
        <button class="btn-ot" onclick="submitApp('overtime')">é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <div id="tab-history" class="hidden">
        <button class="btn-edit" onclick="loadHistory()" style="width:100%; margin-bottom:10px;">ğŸ”„ é‡æ–°æ•´ç†</button>
        <div id="history-list"></div>
    </div>
    
    <div id="status-box"></div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ Firebase Config â˜…â˜…â˜…
  const firebaseConfig = {
  apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
  authDomain: "tpc-monitor.firebaseapp.com",
  projectId: "tpc-monitor",
  storageBucket: "tpc-monitor.firebasestorage.app",
  messagingSenderId: "1066125366380",
  appId: "1:1066125366380:web:836d5898c051226669f449"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // è¨­å®šï¼šé›»å» åº§æ¨™
  const TARGET_LAT = 23.564675316036272;
  const TARGET_LNG = 119.66034190357468;
  const MAX_DIST = 100;

  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      setDefaultTimes();
      await loadUserData(user);
      startGPS();
    }
  });

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        loadHistory();
    } else {
        userData = { name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", company: "", dept: "", jobTitle: "", onboardDate: "", createdAt: new Date().toISOString() };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        document.getElementById('meta-form').classList.remove('hidden');
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    document.getElementById('u-company-display').innerText = (data.company || "æœªè¨­å®š") + " / " + (data.dept || "æœªè¨­å®š");
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
    if(data.onboardDate) document.getElementById('leave-days').innerText = calculateLeave(data.onboardDate);
  }

  async function saveToFirebase() {
    const newData = {
        name: document.getElementById('dbName').value,
        jobTitle: document.getElementById('jobTitle').value,
        company: document.getElementById('company').value,
        dept: document.getElementById('dept').value,
        onboardDate: document.getElementById('onboardDate').value
    };
    if(!newData.name || !newData.company) { alert("è«‹å¡«å¯«å§“åèˆ‡å…¬å¸"); return; }
    await db.collection('cams_users').doc(currentUser.email).update(newData);
    userData = { ...userData, ...newData };
    updateUI(userData);
    document.getElementById('meta-form').classList.add('hidden');
    alert("è³‡æ–™å·²æ›´æ–°");
  }

  async function doClock(type) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
    if (currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }
    try {
        const now = new Date();
        let status = "æ­£å¸¸";
        let h = now.getHours(), m = now.getMinutes();
        if(type==="ä¸Šç­" && (h>8 || (h===8 && m>0))) status="é²åˆ°";
        if(type==="ä¸‹ç­" && (h<16 || (h===16 && m<30))) status="æ—©é€€";

        await db.collection('cams_records').add({
            userId: currentUser.email,
            name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            type: type, time: now, lat: currentLat, lng: currentLng, status: status
        });
        alert(`æ‰“å¡æˆåŠŸï¼(${status})`);
        loadHistory();
    } catch (e) { alert("æ‰“å¡å¤±æ•—: " + e.message); }
  }

  async function submitApp(cat) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«è³‡æ–™"); return; }
    
    // ä»£ç†äººæª¢æŸ¥
    let agentName = "";
    if (cat === 'leave') {
        agentName = document.getElementById('agentName').value.trim();
        if (!agentName) { alert("è«‹è¼¸å…¥ä»£ç†äººå§“å"); return; }
        const agentSnap = await db.collection('cams_users').where('name', '==', agentName).where('company', '==', userData.company).get();
        if (agentSnap.empty) { alert(`æ‰¾ä¸åˆ°ã€Œ${agentName}ã€æˆ–éæœ¬å…¬å¸å“¡å·¥ï¼Œç„¡æ³•è¨­ç‚ºä»£ç†äººã€‚`); return; }
    }

    try {
        let payload = {
            userId: currentUser.email, name: userData.name, email: currentUser.email, company: userData.company, dept: userData.dept,
            category: cat,
            startDate: document.getElementById(cat==='leave'?'l-start':'ot-start').value,
            endDate: document.getElementById(cat==='leave'?'l-end':'ot-end').value,
            createdAt: new Date()
        };

        if(cat === 'leave') {
            payload.type = document.getElementById('leaveType').value;
            payload.agentName = agentName;
            // è«‹å‡ï¼šå››å±¤ç°½æ ¸
            payload.status = { agent: "å¾…å¯©æ ¸", leader: "å¾…å¯©æ ¸", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" };
        } else {
            payload.type = document.getElementById('otType').value;
            // åŠ ç­ï¼šå…©å±¤ç°½æ ¸ (ç„¡ä»£ç†ã€ç„¡é ˜ç­)
            payload.status = { boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" };
        }

        await db.collection('cams_applications').add(payload);
        alert("ç”³è«‹å·²é€å‡ºï¼");
        loadHistory();
    } catch (e) { alert("å¤±æ•—: " + e.message); }
  }

  async function loadHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = "<p style='text-align:center'>è¼‰å…¥ä¸­...</p>";
    let html = "";

    const snap1 = await db.collection('cams_records').where('userId', '==', currentUser.email).orderBy('time', 'desc').limit(5).get();
    if(!snap1.empty) {
        html += `<p style="color:#666;border-bottom:1px solid #ddd">æœ€è¿‘æ‰“å¡</p>`;
        snap1.forEach(doc => {
            let d = doc.data();
            let t = d.time.toDate().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            html += `<div class="history-item"><span>${d.type} <small>${t}</small></span><span class="badge">${d.status}</span></div>`;
        });
    }

    const snap2 = await db.collection('cams_applications').where('userId', '==', currentUser.email).orderBy('createdAt', 'desc').limit(5).get();
    if(!snap2.empty) {
        html += `<p style="color:#666;border-bottom:1px solid #ddd;margin-top:15px;">ç”³è«‹ç´€éŒ„</p>`;
        snap2.forEach(doc => {
            let d = doc.data();
            let s = d.status;
            let statusText = "è™•ç†ä¸­";
            
            if(d.category === 'leave') {
                if(s.client==='åŒæ„') statusText="âœ… ç”²æ–¹å·²æ ¸å‡†";
                else if(s.boss==='å¾…å¯©æ ¸') statusText="â³ ç­‰è€é—†";
                else if(s.leader==='å¾…å¯©æ ¸') statusText="â³ ç­‰é ˜ç­";
                else if(s.agent==='å¾…å¯©æ ¸') statusText="â³ ç­‰ä»£ç†äºº";
            } else {
                if(s.client==='åŒæ„') statusText="âœ… ç”²æ–¹å·²æ ¸å‡†";
                else if(s.boss==='å¾…å¯©æ ¸') statusText="â³ ç­‰è€é—†";
            }
            if(Object.values(s).includes('é€€å›')) statusText="âŒ è¢«é€€å›";

            html += `<div class="history-item"><span>${d.type} <br><small>${d.startDate.replace('T',' ')}</small></span><span class="badge">${statusText}</span></div>`;
        });
    }
    list.innerHTML = html || "<p style='text-align:center'>ç„¡ç´€éŒ„</p>";
  }

  function setDefaultTimes() {
    const now = new Date();
    const ymd = now.toISOString().split('T')[0];
    document.getElementById('l-start').value = ymd + "T08:00"; document.getElementById('l-end').value = ymd + "T16:30";
    document.getElementById('ot-start').value = ymd + "T08:00"; document.getElementById('ot-end').value = ymd + "T16:30";
  }
  function toggleEditMode() { document.getElementById('meta-form').classList.toggle('hidden'); }
  function switchTab(t) {
    ['clock','leave','overtime','history'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); event.target.classList.add('active');
    if(t==='history') loadHistory();
  }
  function startGPS() {
    navigator.geolocation.watchPosition(p => {
        currentLat = p.coords.latitude; currentLng = p.coords.longitude;
        currentDist = getDist(currentLat, currentLng, TARGET_LAT, TARGET_LNG);
        document.getElementById('dist-display').innerText = Math.round(currentDist);
    });
  }
  function getDist(lat1, lon1, lat2, lon2) {
    var R = 6371000, dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function calculateLeave(dateStr) {
      if(!dateStr) return 0;
      let start = new Date(dateStr); let now = new Date();
      let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
      if(months < 6) return 0; if(months < 12) return 3; if(months < 24) return 7; if(months < 36) return 10;
      if(months < 60) return 14; if(months < 120) return 15;
      let days = 16 + Math.floor((months - 120) / 12); return days > 30 ? 30 : days;
  }
</script>
</body>
</html>
