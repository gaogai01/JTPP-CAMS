<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°–å±±é›»å» ç³»çµ± (å“¡å·¥ç«¯)</title>
  <style>
    /* å…¨åŸŸè¨­å®š */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background: #f4f7f6; margin: 0; color: #333; }
    .container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
    .hidden { display: none !important; }
    
    /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fff; }
    label { font-weight: 600; display: block; margin-bottom: 6px; color: #555; font-size: 14px; }
    
    button { padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; width: 100%; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button:active { transform: scale(0.98); }

    /* æŒ‰éˆ•é¡è‰² */
    .btn-in { background: linear-gradient(135deg, #3b82f6, #2563eb); } 
    .btn-out { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .btn-leave { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-search { background: #64748b; margin-top: 0; } /* æŸ¥è©¢æŒ‰éˆ•ç°è‰²ç³» */
    .btn-fix { background: #4b5563; }
    .btn-edit { background: #94a3b8; font-size: 12px; padding: 6px 12px; width: auto; margin-left: auto; border-radius: 20px; }
    
    /* ä½¿ç”¨è€…è³‡è¨Šå¡ */
    #user-info { display: flex; align-items: center; background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    #user-info img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-details { flex-grow: 1; }
    .user-name { font-weight: 800; font-size: 18px; color: #1e293b; }
    .user-meta { font-size: 13px; color: #64748b; margin-top: 2px; }

    /* é¸å–® Tabs (æ¼¸å±¤é¢¨æ ¼) */
    .tabs { 
        display: flex; margin-bottom: 20px; 
        background: white; border-radius: 12px; padding: 5px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
    }
    .tab { 
        flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #64748b; 
        font-weight: bold; font-size: 14px; border-radius: 8px; transition: 0.3s;
    }
    .tab.active { background: #3b82f6; color: white; shadow: 0 2px 5px rgba(59,130,246,0.3); }

    /* GPS å¡ç‰‡ */
    .gps-box {
        text-align: center; padding: 20px; border-radius: 12px; background: #f8fafc;
        margin-bottom: 20px; border: 1px solid #e2e8f0; transition: all 0.3s ease;
    }
    .gps-icon { font-size: 40px; display: block; margin-bottom: 8px; }
    .gps-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 4px; }
    .gps-desc { font-size: 13px; color: #666; }
    .gps-status-ok { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
    .gps-status-ok .gps-title { color: #15803d; }
    .gps-status-err { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
    .gps-status-err .gps-title { color: #b91c1c; }

    /* â˜…â˜…â˜… ç´€éŒ„æŸ¥è©¢ç¾åŒ– (åƒè€ƒæˆªåœ–) â˜…â˜…â˜… */
    .search-box {
        background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;
    }
    .date-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .date-row input { margin-bottom: 0; }
    
    .history-card {
        background: white; border: 1px solid #f1f5f9; border-radius: 10px; padding: 15px; 
        margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s;
    }
    .history-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .h-left { display: flex; flex-direction: column; }
    .h-type { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 4px; }
    .h-time { font-size: 13px; color: #64748b; }
    .h-badge { 
        padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; 
    }
    .badge-normal { background: #f0fdf4; color: #166534; } /* æ­£å¸¸-ç¶  */
    .badge-warn { background: #fef2f2; color: #b91c1c; }   /* ç•°å¸¸-ç´… */
    .badge-info { background: #eff6ff; color: #1e40af; }   /* è£œå¡-è— */

    /* é¤˜é¡é¡¯ç¤º */
    .balance-box {
        background: #fffbeb; color: #92400e; padding: 15px; border-radius: 10px; 
        margin-bottom: 15px; border: 1px solid #fcd34d; display: flex; justify-content: space-between;
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>âš¡ å°–å±±é›»å» ç³»çµ±</h2>
  
  <div id="login-section" style="text-align:center; padding: 40px 0;">
    <button class="btn-in" onclick="loginGoogle()">ğŸ”µ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div id="user-info">
      <img id="u-photo" src="" alt="">
      <div class="user-details">
        <div class="user-name" id="u-name">...</div>
        <div class="user-meta" id="u-company-display">è®€å–ä¸­...</div>
      </div>
      <button class="btn-edit" onclick="toggleEditMode()">ä¿®æ”¹è³‡æ–™</button>
    </div>

    <div id="meta-form" class="hidden" style="background: #f8fafc; padding: 20px; margin-bottom: 20px; border-radius:12px; border:1px solid #e2e8f0;">
        <h4 style="margin-top:0; color:#333;">ğŸ‘¤ å€‹äººæª”æ¡ˆ</h4>
        <label>çœŸå¯¦å§“å</label><input type="text" id="dbName">
        <label>è·ç¨±</label><input type="text" id="jobTitle">
        <label>æ‰¿æ”¬å•†å…¬å¸</label><input type="text" id="company">
        <label>ç”²æ–¹éƒ¨é–€</label><input type="text" id="dept">
        
        <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
        <p style="font-size:12px; color:red;">* ä»¥ä¸‹æ¬„ä½è«‹è¯ç¹«ç®¡ç†å“¡ä¿®æ”¹</p>
        
        <label>ç­åˆ¥ (å·¥æ™‚è¨­å®š)</label>
        <select id="workShift" disabled style="background:#eee;">
            <option value="">è«‹é¸æ“‡</option>
            <option value="A">Aç­ (08:00~16:30, ä¼‘0.5hr)</option>
            <option value="B">Bç­ (08:00~17:00, ä¼‘1.0hr)</option>
        </select>

        <label>åˆ°è·æ—¥</label><input type="date" id="onboardDate" disabled style="background:#eee;">
        
        <button class="btn-in" onclick="saveToFirebase()">å„²å­˜è®Šæ›´</button>
    </div>

    <div class="tabs">
      <div id="tab-btn-clock" class="tab active" onclick="switchTab('clock')">æ‰“å¡</div>
      <div id="tab-btn-leave" class="tab" onclick="switchTab('leave')">è«‹å‡</div>
      <div id="tab-btn-task" class="tab" onclick="switchTab('task')">å¾…è¾¦</div>
      <div id="tab-btn-history" class="tab" onclick="switchTab('history')">ç´€éŒ„</div>
    </div>

    <div id="tab-clock">
        <div id="gps-box" class="gps-box">
            <div id="gps-icon">ğŸ“¡</div>
            <div class="gps-title" id="gps-title">å®šä½ä¸­...</div>
            <div class="gps-desc" id="gps-desc">è«‹ç¨å€™</div>
        </div>

        <div class="btn-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <button class="btn-in" onclick="doClock('ä¸Šç­')">ä¸Šç­æ‰“å¡<br><small>08:00 (å½ˆæ€§15åˆ†)</small></button>
            <button class="btn-leave" onclick="doClock('å¤–å‡º')">å¤–å‡º/å…¬å‹™</button>
            <button class="btn-out" onclick="doClock('ä¸‹ç­')">ä¸‹ç­æ‰“å¡<br><small>è¦–ç­åˆ¥è¨ˆç®—</small></button>
            <button class="btn-leave" onclick="doClock('è¿”å›')">è¿”å›/éŠ·å‡</button>
        </div>
        
        <button class="btn-fix" onclick="toggleFix()" style="margin-top:20px;">ğŸ› ï¸ ç”³è«‹è£œåˆ·å¡ (å¿˜è¨˜æ‰“å¡)</button>
        <div id="fix-form" class="hidden" style="margin-top:10px; background:#f1f5f9; padding:15px; border-radius:10px;">
            <label>é¡å‹</label><select id="fixType"><option>ä¸Šç­</option><option>ä¸‹ç­</option></select>
            <label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="fixDateTime">
            <label>äº‹ç”±</label><input type="text" id="fixReason">
            <button class="btn-fix" onclick="submitApp('correction')">é€å‡ºç”³è«‹</button>
        </div>
    </div>

    <div id="tab-leave" class="hidden">
        <div class="balance-box" id="balance-box" style="display:none;">
            <span>å‰©é¤˜é¡åº¦</span>
            <span style="font-weight:bold; font-size:18px;" id="balance-val">0</span>
        </div>
        <label>å‡åˆ¥</label>
        <select id="leaveType" onchange="updateBalanceDisplay()">
            <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option><option value="è£œä¼‘">è£œä¼‘</option>
            <option value="äº‹å‡">äº‹å‡</option><option value="ç—…å‡">ç—…å‡</option>
        </select>
        <label>ä»£ç†äºº</label><select id="agentSelect"></select>
        <label>æ™‚é–“</label>
        <div style="display:flex; gap:5px;">
            <input type="datetime-local" id="l-start"><span>~</span><input type="datetime-local" id="l-end">
        </div>
        <button class="btn-leave" onclick="submitApp('leave')">é€å‡ºå‡å–®</button>
    </div>

    <div id="tab-history" class="hidden">
        <div class="search-box">
            <label>æŸ¥è©¢æœŸé–“</label>
            <div class="date-row">
                <input type="date" id="history-start">
                <span>~</span>
                <input type="date" id="history-end">
            </div>
            <button class="btn-search" onclick="loadHistory()">ğŸ” æŸ¥è©¢ç´€éŒ„</button>
        </div>
        
        <h4 style="margin:10px 0; color:#64748b; font-size:14px;">æ‰“å¡èˆ‡ç”³è«‹ç´€éŒ„</h4>
        <div id="history-list"></div>
    </div>

    <div id="tab-task" class="hidden">
        <button class="btn-edit" onclick="loadTasks()" style="width:100%">ğŸ”„ åˆ·æ–°</button>
        <div id="ot-list-container"></div>
        <div id="review-list-container"></div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // é›»å» åº§æ¨™ (ç¯„ä¾‹)
  const PLANT_LOCATION = { lat: 23.564675316036272, lng: 119.66034190357468 };
  const MAX_DIST = 500; // æ¸¬è©¦ç”¨ï¼Œå¯æ”¹å› 100
  let currentUser = null, userData = {}, currentLat = 0, currentLng = 0, currentDist = 9999;
  let leaveBalances = { annual: 0, comp: 0 };

  // å®šç¾©ç­åˆ¥è¦å‰‡
  const SHIFTS = {
      "A": { start: "08:00", totalHrs: 8.5, label: "Aç­ (08:00-16:30)" }, // 8hrå·¥æ™‚ + 0.5hrä¼‘
      "B": { start: "08:00", totalHrs: 9.0, label: "Bç­ (08:00-17:00)" }  // 8hrå·¥æ™‚ + 1.0hrä¼‘
  };

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('u-photo').src = user.photoURL;
      initHistoryDates();
      await loadUserData(user);
      startGPS();
    }
  });

  function initHistoryDates() {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1); // ç•¶æœˆ1è™Ÿ
      const last = new Date(now.getFullYear(), now.getMonth() + 1, 0); // ç•¶æœˆæœ€å¾Œä¸€å¤©
      const toYMD = d => d.toISOString().split('T')[0]; // å› ç‚ºæ™‚å€å•é¡Œï¼Œå»ºè­°æ‰‹å‹•æ ¼å¼åŒ–ï¼Œé€™è£¡ç°¡åŒ–
      // ä¿®æ­£æ™‚å€åç§»å°è‡´çš„æ—¥æœŸéŒ¯èª¤
      const localYMD = (d) => {
          const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
          return z.toISOString().split('T')[0];
      };
      document.getElementById('history-start').value = localYMD(first);
      document.getElementById('history-end').value = localYMD(last);
  }

  async function loadUserData(user) {
    const doc = await db.collection('cams_users').doc(user.email).get();
    if (doc.exists) {
        userData = doc.data();
        updateUI(userData);
        
        // é¤˜é¡è¨ˆç®— (ç•¥ç‚ºç°¡åŒ–ï¼Œéœ€é…åˆå¾Œå°å¯¦éš›é‚è¼¯)
        if(userData.onboardDate) {
            let total = calculateAnnual(userData.onboardDate);
            leaveBalances.annual = total - (userData.leaveUsed || 0);
            leaveBalances.comp = (userData.compTotal || 0) - (userData.compUsed || 0);
        }
        loadColleagues();
        loadTasks();
    } else {
        // æ–°ç”¨æˆ¶é è¨­
        userData = { 
            name: user.displayName, email: user.email, role: "å¤–åŒ…å“¡å·¥", 
            workShift: "A", // é è¨­ A ç­
            createdAt: new Date().toISOString() 
        };
        await db.collection('cams_users').doc(user.email).set(userData);
        updateUI(userData);
        toggleEditMode(); // æ–°äººè‡ªå‹•æ‰“é–‹ç·¨è¼¯
    }
  }

  function updateUI(data) {
    document.getElementById('u-name').innerText = data.name;
    document.getElementById('u-company-display').innerText = (data.company||"æœªè¨­å®š") + (data.workShift ? ` / ${data.workShift}ç­` : "");
    
    // å¡«å…¥è¡¨å–®
    document.getElementById('dbName').value = data.name;
    document.getElementById('jobTitle').value = data.jobTitle || "";
    document.getElementById('company').value = data.company || "";
    document.getElementById('dept').value = data.dept || "";
    document.getElementById('onboardDate').value = data.onboardDate || "";
    document.getElementById('workShift').value = data.workShift || "A";
  }

  // â˜…â˜…â˜… æ ¸å¿ƒé‚è¼¯ï¼šæ‰“å¡åˆ¤æ–· â˜…â˜…â˜…
  async function doClock(type) {
    if (!userData.company) { alert("è«‹å…ˆå¡«å¯«å€‹äººè³‡æ–™"); return; }
    if (currentDist > MAX_DIST) { alert(`è·é›¢éé  (${Math.round(currentDist)}m)`); return; }

    const now = new Date();
    let status = "æ­£å¸¸";
    const shift = SHIFTS[userData.workShift || "A"]; // å–å¾—ç­åˆ¥è¨­å®š
    
    // 1. ä¸Šç­æ‰“å¡é‚è¼¯
    if (type === 'ä¸Šç­') {
        // è¨­å®šåŸºæº–æ™‚é–“ 08:15 (é€™è£¡ç°¡å–®ç”¨å­—ä¸²æ¯”è¼ƒï¼Œæˆ–ç”¨ Date ç‰©ä»¶æ¯”è¼ƒ)
        const checkTime = new Date();
        checkTime.setHours(8, 15, 0); // ä»Šå¤© 08:15:00

        if (now > checkTime) {
            status = "é²åˆ°";
            alert(`ç¾åœ¨æ™‚é–“ ${now.getHours()}:${now.getMinutes()} å·²è¶…é 08:15ï¼Œè¨˜ç‚ºã€Œé²åˆ°ã€ã€‚\nè«‹è¨˜å¾—è£œè«‹å‡å–®ã€‚`);
        }
    } 
    // 2. ä¸‹ç­æ‰“å¡é‚è¼¯ (è¨ˆç®—å½ˆæ€§å·¥æ™‚)
    else if (type === 'ä¸‹ç­') {
        try {
            // æ‰¾å‡ºã€Œä»Šå¤©ã€æœ€æ—©çš„ä¸€ç­†ã€Œä¸Šç­ã€ç´€éŒ„
            const startOfDay = new Date(now); startOfDay.setHours(0,0,0,0);
            const endOfDay = new Date(now); endOfDay.setHours(23,59,59,999);
            
            const snap = await db.collection('cams_records')
                .where('userId', '==', currentUser.email)
                .where('type', '==', 'ä¸Šç­')
                .where('time', '>=', startOfDay)
                .where('time', '<=', endOfDay)
                .orderBy('time', 'asc') // æœ€æ—©çš„ä¸€ç­†
                .limit(1)
                .get();

            if (snap.empty) {
                if(!confirm("âš ï¸ è­¦å‘Šï¼šç³»çµ±æ‰¾ä¸åˆ°ä½ ä»Šå¤©çš„ã€Œä¸Šç­ã€æ‰“å¡ç´€éŒ„ã€‚\nç„¡æ³•è¨ˆç®—å½ˆæ€§ä¸‹ç­æ™‚é–“ï¼Œç¢ºå®šè¦æ‰“å¡å—ï¼Ÿ")) return;
                status = "ç•°å¸¸(ç¼ºä¸Šç­)";
            } else {
                const workRecord = snap.docs[0].data();
                const inTime = workRecord.time.toDate(); // å¯¦éš›ä¸Šè½çš„æ™‚é–“
                
                // è¨ˆç®—ã€ŒåŸºæº–ä¸Šç­æ™‚é–“ã€ (å– 08:00 èˆ‡ å¯¦éš›ä¸Šç­æ™‚é–“ çš„è¼ƒæ™šè€…ï¼Œä½†ä¸å¾—æ™šæ–¼ 08:15)
                // è¦å‰‡ï¼š08:15 å‰åˆ·å¡ï¼Œéƒ½æœ‰å½ˆæ€§ã€‚è¶…é 08:15 é›–ç„¶ç®—é²åˆ°ï¼Œä½†å·¥æ™‚ä»éœ€åšæ»¿ã€‚
                
                // ç‚ºäº†è¨ˆç®—åˆæ³•ä¸‹ç­æ™‚é–“ï¼š
                // å¦‚æœ 07:50 åˆ· -> è¦–ç‚º 08:00 ä¸Šç­ -> 16:30/17:00 ä¸‹ç­
                // å¦‚æœ 08:10 åˆ· -> è¦–ç‚º 08:10 ä¸Šç­ -> 16:40/17:10 ä¸‹ç­
                // å¦‚æœ 08:20 åˆ· -> è¦–ç‚º 08:20 ä¸Šç­ -> 16:50/17:20 ä¸‹ç­ (é›–é²åˆ°ä½†è¦åšæ»¿æ™‚æ•¸)
                
                let baseInTime = new Date(inTime);
                const limit0800 = new Date(inTime); limit0800.setHours(8,0,0,0);
                
                // å¦‚æœæ¯” 08:00 æ—©ï¼Œå°±ç®— 08:00
                if (inTime < limit0800) baseInTime = limit0800;

                // è¨ˆç®—åˆæ³•ä¸‹ç­æ™‚é–“ = ä¸Šç­æ™‚é–“ + ç¸½å·¥æ™‚ (å«ä¼‘)
                // Aç­ +8.5hr, Bç­ +9.0hr
                const validOutTime = new Date(baseInTime.getTime() + shift.totalHrs * 60 * 60 * 1000);
                
                if (now < validOutTime) {
                    const diffMin = Math.ceil((validOutTime - now) / 60000);
                    if(!confirm(`âš ï¸ æ³¨æ„ï¼æ ¹æ“šä½ çš„ä¸Šç­æ™‚é–“ (${inTime.getHours()}:${String(inTime.getMinutes()).padStart(2,'0')})ï¼Œ\nä½ æ˜¯ ${userData.workShift} ç­ï¼Œæ‡‰å·¥ä½œæ»¿ ${shift.totalHrs} å°æ™‚ã€‚\n\nåˆæ³•ä¸‹ç­æ™‚é–“ç‚ºï¼š${validOutTime.getHours()}:${String(validOutTime.getMinutes()).padStart(2,'0')}\n\nç¾åœ¨æ‰“å¡å°‡è¨˜ç‚ºã€Œæ—©é€€ã€(${diffMin}åˆ†é˜)ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
                    status = "æ—©é€€";
                }
            }
        } catch(e) {
            console.error(e);
            alert("è®€å–ä¸Šç­ç´€éŒ„å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–ç´¢å¼•è¨­å®šã€‚");
            return;
        }
    }

    try {
        await db.collection('cams_records').add({
            userId: currentUser.email, name: userData.name, email: currentUser.email, 
            company: userData.company, dept: userData.dept,
            type: type, time: now, lat: currentLat, lng: currentLng, status: status
        });
        alert(`æ‰“å¡æˆåŠŸï¼ç‹€æ…‹ï¼š${status}`); 
        loadHistory();
    } catch (e) { alert("å¤±æ•—: " + e.message); }
  }

  // â˜…â˜…â˜… æŸ¥è©¢ç¾åŒ–ç‰ˆ â˜…â˜…â˜…
  async function loadHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = "<p style='text-align:center; color:#888;'>è¼‰å…¥è³‡æ–™ä¸­...</p>";
    
    const sStr = document.getElementById('history-start').value;
    const eStr = document.getElementById('history-end').value;
    const startD = new Date(sStr + "T00:00:00");
    const endD = new Date(eStr + "T23:59:59");

    try {
        let html = "";
        
        // æŸ¥è©¢æ‰“å¡
        const snap = await db.collection('cams_records')
            .where('userId', '==', currentUser.email)
            .where('time', '>=', startD).where('time', '<=', endD)
            .orderBy('time', 'desc').limit(30).get();

        if (snap.empty) {
            html = "<div style='text-align:center; padding:20px; color:#999;'>æŸ¥ç„¡ç´€éŒ„</div>";
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                const t = d.time.toDate();
                const dateStr = `${t.getMonth()+1}/${t.getDate()}`; // 12/5
                const timeStr = t.toLocaleTimeString('zh-TW', {hour12: true, hour:'numeric', minute:'numeric'}); // ä¸‹åˆ 2:20
                
                // æ ¹æ“šç‹€æ…‹çµ¦é¡è‰²
                let badgeClass = "badge-normal";
                if(d.status.includes("é²åˆ°") || d.status.includes("æ—©é€€") || d.status.includes("ç•°å¸¸")) badgeClass = "badge-warn";
                if(d.status.includes("è£œå¡")) badgeClass = "badge-info";

                // ç”¢ç”Ÿå¡ç‰‡ HTML (åƒè€ƒä½ çš„æˆªåœ– Layout)
                html += `
                <div class="history-card">
                    <div class="h-left">
                        <span class="h-type">${d.type} <span style="font-weight:normal; font-size:14px; margin-left:5px;">${dateStr} ${timeStr}</span></span>
                    </div>
                    <span class="h-badge ${badgeClass}">${d.status}</span>
                </div>`;
            });
        }
        list.innerHTML = html;
    } catch (e) {
        console.error(e);
        if(e.message.includes("index")) list.innerHTML = `<p style='color:red;text-align:center'>ğŸ”¥ éœ€è¦å»ºç«‹ç´¢å¼• (Index) æ‰èƒ½æŸ¥è©¢ã€‚<br><a href="${e.message.match(/https?:\/\/[^ ]+/)[0]}" target="_blank">é»æ­¤å»ºç«‹</a></p>`;
        else list.innerHTML = `<p style='color:red;text-align:center'>æŸ¥è©¢éŒ¯èª¤: ${e.message}</p>`;
    }
  }

  // GPS é‚è¼¯
  function startGPS() {
      if(navigator.geolocation) {
          navigator.geolocation.watchPosition(p => {
              currentLat = p.coords.latitude; currentLng = p.coords.longitude;
              currentDist = getDist(currentLat, currentLng, PLANT_LOCATION.lat, PLANT_LOCATION.lng);
              const box = document.getElementById('gps-box');
              if(currentDist <= MAX_DIST) {
                  box.className = "gps-box gps-status-ok";
                  document.getElementById('gps-title').innerText = "å·²é€²å…¥æ‰“å¡ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)} å…¬å°º (OK)`;
              } else {
                  box.className = "gps-box gps-status-err";
                  document.getElementById('gps-title').innerText = "å°šæœªé€²å…¥ç¯„åœ";
                  document.getElementById('gps-desc').innerText = `è·é›¢ ${Math.round(currentDist)} å…¬å°º`;
              }
          }, e => console.log(e), {enableHighAccuracy:true});
      }
  }
  function getDist(lat1, lon1, lat2, lon2) {
      const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // å„²å­˜è³‡æ–™
  async function saveToFirebase() {
      try {
          // å› ç‚ºç­åˆ¥å’Œåˆ°è·æ—¥æ˜¯è¢« disabled çš„ï¼Œç›´æ¥å­˜å¯èƒ½æœƒæŠ“ä¸åˆ°å€¼ï¼Œæˆ–æ˜¯æˆ‘å€‘è¦å…è¨±ã€Œç¬¬ä¸€æ¬¡è¨­å®šã€
          // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯ Employee æ¬Šé™ï¼Œç†è«–ä¸Šä¸èƒ½æ”¹é€™å…©å€‹ã€‚
          // ä½†ç‚ºäº†è®“ä½ æ¸¬è©¦ï¼Œæˆ‘å€‘å‡è¨­é€™è£¡é‚„æ˜¯æœƒè®€å– input çš„å€¼ (å³ä½¿æ˜¯ disabledï¼Œé€é JS è®€å–æ²’å•é¡Œï¼Œåªè¦åŸæœ¬æœ‰å€¼)
          
          const newData = {
              name: document.getElementById('dbName').value,
              jobTitle: document.getElementById('jobTitle').value,
              company: document.getElementById('company').value,
              dept: document.getElementById('dept').value,
              // å¦‚æœæ˜¯ disabledï¼Œä½¿ç”¨è€…ç„¡æ³•æ”¹ï¼Œä½†å¦‚æœæ˜¯ç©ºçš„ (æ–°äºº)ï¼Œæˆ‘å€‘åœ¨ toggleEditMode å¯ä»¥æš«æ™‚é–‹å•Ÿ
              onboardDate: document.getElementById('onboardDate').value,
              workShift: document.getElementById('workShift').value
          };
          
          await db.collection('cams_users').doc(currentUser.email).set(newData, {merge:true});
          alert("è³‡æ–™æ›´æ–°æˆåŠŸï¼"); location.reload();
      } catch(e) { alert("å„²å­˜å¤±æ•—: "+e.message); }
  }

  function toggleEditMode() { 
      const form = document.getElementById('meta-form');
      form.classList.toggle('hidden'); 
      // é€™è£¡åšä¸€å€‹å°æŠ€å·§ï¼šå¦‚æœé‚„æ²’æœ‰è¨­å®šéç­åˆ¥(æ˜¯ç©ºçš„)ï¼Œå°±æš«æ™‚å…è¨±ç·¨è¼¯ï¼Œå¦å‰‡é–å®š
      const shiftSelect = document.getElementById('workShift');
      const dateInput = document.getElementById('onboardDate');
      
      if(!shiftSelect.value) shiftSelect.disabled = false;
      if(!dateInput.value) dateInput.disabled = false;
  }
  
  function switchTab(t) {
    ['clock','leave','history','task'].forEach(id => {
        document.getElementById('tab-'+id).classList.add('hidden');
        document.getElementById('tab-btn-'+id).classList.remove('active');
    });
    document.getElementById('tab-'+t).classList.remove('hidden');
    document.getElementById('tab-btn-'+t).classList.add('active');
    if(t==='history') loadHistory();
    if(t==='task') loadTasks();
  }

  // è¼”åŠ©å‡½å¼ (ç•¥)
  function calculateAnnual(d) { return 7; /* ç°¡åŒ– */ } 
  function updateBalanceDisplay() { /* ç•¥ */ }
  async function submitApp(t) { /* ç•¥ */ }
  async function loadColleagues() { /* ç•¥ */ }
  async function loadTasks() { /* ç•¥ */ }
  function toggleFix() { document.getElementById('fix-form').classList.toggle('hidden'); }
</script>
</body>
</html>
