<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é›»å» ç®¡ç†å¾Œå°</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; margin:0; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; min-height: 85vh; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #1a73e8; font-weight: 800; margin-bottom: 25px; } 
    .hidden { display: none !important; }
    
    /* --- è¡¨æ ¼æ¨£å¼ --- */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: center; } 
    th { background: #f8fafc; color: #475569; font-weight: bold; border-bottom: 2px solid #e2e8f0; }
    tr:hover { background-color: #f8fafc; }
    
    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    button { cursor: pointer; transition: 0.2s; border: none; font-family: inherit; font-weight: bold; }
    button:active { transform: scale(0.98); }
    button:disabled { background: #ccc !important; cursor: not-allowed; }

    .btn-approve { background: #10b981; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-reject { background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-update { background: #0ea5e9; color: white; padding: 6px 15px; border-radius: 6px; margin-right: 5px; }
    .btn-edit-info { background: #f59e0b; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-export { background: #f97316; color: white; padding: 8px 15px; border-radius: 6px; }
    .btn-close { background: #64748b; color: white; padding: 8px 20px; border-radius: 6px; }
    
    .btn-create { 
        background: linear-gradient(135deg, #6366f1, #4f46e5); 
        color: white; padding: 12px 24px; border-radius: 8px; font-size: 16px; 
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); width: 100%;
    }
    .btn-create:hover { box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3); }

    /* --- é¸å–® Tabs --- */
    .tabs { display: flex; margin-bottom: 25px; background-color: #1e293b; border-radius: 12px; overflow: hidden; padding: 4px; }
    .tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: bold; color: #cbd5e1; transition: 0.3s; border-radius: 8px; }
    .tab:hover { background-color: #334155; color: white; }
    .tab.active { background: white; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* --- æ´¾å·¥å€ --- */
    .assign-box { border: 1px solid #e2e8f0; padding: 25px; border-radius: 12px; margin-bottom: 20px; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .assign-header { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px; border-left: 5px solid #6366f1; padding-left: 10px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-full { grid-column: span 2; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 15px; }

    /* å“¡å·¥å¤šé¸æ¸…å–® */
    .employee-selector { border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px; background: #f8fafc; max-height: 200px; overflow-y: auto; }
    .employee-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .emp-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    .emp-checkbox:hover { border-color: #6366f1; background: #eef2ff; }
    .emp-checkbox input { width: auto; margin: 0; }
    .select-all-btn { font-size: 12px; color: #2563eb; cursor: pointer; margin-left: 10px; text-decoration: underline; }

    /* Radio é¸é … */
    .radio-group { display: flex; gap: 20px; align-items: center; margin-top: 5px; }
    .radio-group label { display: flex; align-items: center; gap: 5px; font-weight: normal; cursor: pointer; }
    .radio-group input { width: auto; }

    /* --- Modal --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .modal-box { background: white; padding: 30px; border-radius: 12px; width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-box h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .modal-row input, .modal-row select { width: 100%; padding: 8px; box-sizing: border-box; border:1px solid #ccc; border-radius:4px;}
    .modal-actions { text-align: right; margin-top: 20px; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ é›»å» ç®¡ç†å¾Œå°</h2>
  <div id="login-section" style="text-align:center; padding:50px;">
    <button onclick="loginGoogle()" class="btn-create" style="width:auto;">ğŸ”µ Google ç®¡ç†å“¡ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div style="text-align:right; margin-bottom:10px;">
        ç®¡ç†å“¡ï¼š<span id="my-name" style="font-weight:bold;"></span> 
        (<span id="my-role" style="color:#1a73e8;"></span>)
    </div>

    <div class="tabs">
      <div id="tab-btn-review" class="tab active" onclick="switchTab('review')">å¯©æ ¸ä½œæ¥­</div>
      <div id="tab-btn-assign" class="tab" onclick="switchTab('assign')">ç”²æ–¹æ´¾å·¥</div>
      <div id="tab-btn-report" class="tab" onclick="switchTab('report')">å ±è¡¨ä¸­å¿ƒ</div>
      <div id="tab-btn-users" class="tab" onclick="switchTab('users')">æ¬Šé™/è³‡æ–™ç®¡ç†</div>
    </div>

    <div id="tab-review">
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <span style="font-weight:bold;">ç•¶å‰å¯©æ ¸èº«åˆ†ï¼š</span>
                <select id="reviewRoleSelect" onchange="loadReviewData()" style="padding:6px; border-radius:4px; border:1px solid #ccc;"></select>
            </div>
            <button class="btn-update" onclick="loadReviewData()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        </div>
        
        <h3 style="border-left:4px solid #10b981; padding-left:10px;">è«‹å‡å¯©æ ¸</h3>
        <table id="leaveTable"><thead><tr><th>å§“å</th><th>ä»£ç†äºº</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        
        <h3 style="margin-top:30px; border-left:4px solid #6366f1; padding-left:10px;">åŠ ç­å¯©æ ¸</h3>
        <table id="otTable"><thead><tr><th>å§“å</th><th>è£œå„Ÿæ–¹å¼</th><th>äº‹ç”±</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        
        <h3 style="margin-top:30px; border-left:4px solid #f59e0b; padding-left:10px;">è£œåˆ·å¡å¯©æ ¸</h3>
        <table id="fixTable"><thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ—¥æœŸæ™‚é–“</th><th>äº‹ç”±</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-assign" class="hidden">
        <div class="assign-box">
            <div class="assign-header">ğŸ“ æ–°å¢åŠ ç­æ´¾å·¥å–®</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>é¸æ“‡å» å•†</label>
                    <select id="assignCompany" onchange="loadEmployees(this.value)"><option value="">è«‹å…ˆé¸æ“‡å…¬å¸...</option></select>
                </div>
                
                <div class="form-group">
                    <label>é¸æ“‡å“¡å·¥ (å¯å¤šé¸) <span class="select-all-btn" onclick="toggleSelectAll()">å…¨é¸/å–æ¶ˆ</span></label>
                    <div class="employee-selector">
                        <div id="assignEmployeeBox" class="employee-grid"><div style="color:#999; text-align:center; padding:20px;">è«‹å…ˆé¸æ“‡å…¬å¸</div></div>
                    </div>
                </div>

                <div class="form-group form-full">
                    <label>åŠ ç­è£œå„Ÿæ–¹å¼</label>
                    <div class="radio-group">
                        <label><input type="radio" name="compType" value="pay" checked> åŠ ç­è²» (ä¾å‹åŸºæ³•è¨ˆç®—)</label>
                        <label><input type="radio" name="compType" value="leave"> è£œä¼‘ (ç´¯è¨ˆè‡³è£œä¼‘å‡)</label>
                    </div>
                </div>

                <div class="form-group form-full">
                    <label>åŠ ç­äº‹ç”±</label>
                    <input type="text" id="assignReason" placeholder="ä¾‹å¦‚ï¼šæ©Ÿçµ„å¹´åº¦æ­²ä¿®å”åŠ©">
                </div>

                <div class="form-group"><label>é–‹å§‹æ™‚é–“</label><input type="datetime-local" id="assignStart"></div>
                <div class="form-group"><label>çµæŸæ™‚é–“</label><input type="datetime-local" id="assignEnd"></div>
            </div>
            
            <button class="btn-create" onclick="createAssignment()">ğŸš€ é€å‡ºæ´¾å·¥å–® (æ‰¹æ¬¡ç™¼é€)</button>
        </div>
    </div>

    <div id="tab-report" class="hidden">
       <div style="text-align:center; padding:20px; color:#666;">å ±è¡¨åŠŸèƒ½å€ (è«‹åƒè€ƒå‰ç‰ˆç¨‹å¼ç¢¼)</div>
    </div>

    <div id="tab-users" class="hidden">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <div style="color:#666;">å¯ä¿®æ”¹åŸºæœ¬è³‡æ–™ã€æ¬Šé™èˆ‡è–ªè³‡</div>
            <button class="btn-update" onclick="loadUsers()">ğŸ”„ åˆ·æ–°åå–®</button>
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>æ‰‹æ©Ÿ</th>
                    <th>å…¬å¸/éƒ¨é–€</th>
                    <th>ç¾¤çµ„</th>
                    <th>æ¬Šé™</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

  </div> <div id="editUserModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>âœï¸ ç·¨è¼¯å“¡å·¥è³‡æ–™</h3>
        <input type="hidden" id="editUserId">
        <div class="modal-row"><label>å§“å</label><input type="text" id="editName"></div>
        <div class="modal-row"><label>æ‰‹æ©Ÿè™Ÿç¢¼ (å“¡å·¥/é ˜ç­å¯å¡«)</label><input type="text" id="editPhone" placeholder="09xx-xxx-xxx"></div>
        
        <div class="modal-row"><label>åŸºæœ¬è–ªè³‡ (åƒ…ç®¡ç†è€…/ç”²æ–¹/è€é—†å¯è¦‹)</label>
            <input type="number" id="editBaseSalary" placeholder="è¼¸å…¥æœˆè–ª" style="background:#fffbeb; border-color:#f59e0b;">
            <small style="color:#d97706;">* ç”¨æ–¼è¨ˆç®—åŠ ç­è²» (å¹³æ—¥: å‰2h x1.34, å¾Œ2h x1.67)</small>
        </div>

        <div class="modal-row"><label>å…¬å¸</label><input type="text" id="editCompany"></div>
        <div class="modal-row"><label>éƒ¨é–€</label><input type="text" id="editDept"></div>
        <div class="modal-row">
            <label>ç¾¤çµ„</label>
            <select id="editShift">
                <option value="normal">æ­£å¸¸ç­ (08:00~16:30)</option>
                <option value="cleaning">æ¸…æ½”ç­ (08:00~17:00)</option>
            </select>
        </div>
        <div class="modal-row"><label>åˆ°è·æ—¥</label><input type="date" id="editOnboardDate"></div>
        <div class="modal-actions">
            <button class="btn-close" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-update" onclick="saveUserEdit()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>
  </div>

</div>

<script>
  const firebaseConfig = { apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA", authDomain: "jtpp-cams.firebaseapp.com", projectId: "jtpp-cams", storageBucket: "jtpp-cams.firebasestorage.app", messagingSenderId: "334286192470", appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null, myRole = "", myCompany = "";

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const doc = await db.collection('cams_users').doc(user.email).get();
      if(doc.exists) { 
          const d = doc.data();
          myRole = d.role; myCompany = d.company; 
          if(myRole === 'å¤–åŒ…å“¡å·¥') { alert("æ¬Šé™ä¸è¶³"); window.location.href = "index.html"; return; }
      } else { myRole = "è¨ªå®¢"; }
      
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('my-name').innerText = user.displayName;
      document.getElementById('my-role').innerText = myRole;
      
      setupRoleSelect(myRole);
      loadCompanyList();
      loadReviewData();
      
      const ymd = new Date().toLocaleDateString('en-CA');
      document.getElementById('assignStart').value = ymd + "T08:00";
      document.getElementById('assignEnd').value = ymd + "T16:30";
    }
  });

  async function loadCompanyList() {
      const snap = await db.collection('cams_users').get();
      let s = new Set(); snap.forEach(d => { if(d.data().company) s.add(d.data().company); });
      let html = "<option value=''>è«‹é¸æ“‡</option>";
      s.forEach(c => { html += `<option value="${c}">${c}</option>`; });
      document.getElementById('assignCompany').innerHTML = html;
  }

  async function loadEmployees(comp) {
      const container = document.getElementById('assignEmployeeBox');
      container.innerHTML = "è¼‰å…¥ä¸­...";
      if(!comp) { container.innerHTML = "<div style='color:#999;text-align:center;padding:10px'>è«‹å…ˆé¸æ“‡å» å•†</div>"; return; }
      const snap = await db.collection('cams_users').where('company', '==', comp).get();
      if(snap.empty) { container.innerHTML = "ç„¡å“¡å·¥è³‡æ–™"; return; }
      let html = "";
      snap.forEach(d => {
          const u = d.data();
          html += `<label class="emp-checkbox"><input type="checkbox" class="emp-select" value="${u.email}" data-name="${u.name}" data-salary="${u.baseSalary||0}"><span>${u.name}</span></label>`;
      });
      container.innerHTML = html;
  }
  function toggleSelectAll() {
      const all = document.querySelectorAll('.emp-select'); if(all.length===0) return;
      const st = !all[0].checked; all.forEach(cb => cb.checked = st);
  }

  async function createAssignment() {
      const reason = document.getElementById('assignReason').value;
      const start = document.getElementById('assignStart').value;
      const end = document.getElementById('assignEnd').value;
      const comp = document.getElementById('assignCompany').value;
      const compType = document.querySelector('input[name="compType"]:checked').value; // pay or leave
      
      const checkedBoxes = document.querySelectorAll('.emp-select:checked');
      if(checkedBoxes.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½å“¡å·¥"); return; }
      if(!reason || !start || !end) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }

      // è¨ˆç®—æ™‚æ•¸
      const sDate = new Date(start); const eDate = new Date(end);
      const diffHrs = (eDate - sDate) / 36e5;
      if(diffHrs <= 0) { alert("æ™‚é–“éŒ¯èª¤"); return; }

      const btn = document.querySelector('.btn-create');
      btn.innerText = `ç™¼é€ä¸­...`; btn.disabled = true;

      try {
          const promises = [];
          checkedBoxes.forEach(cb => {
              const email = cb.value;
              const name = cb.getAttribute('data-name');
              const salary = parseFloat(cb.getAttribute('data-salary') || 0);
              
              let estimatedPay = 0;
              // ç°¡æ˜“å‹åŸºæ³•åŠ ç­è²»è¨ˆç®— (å¹³æ—¥)
              if(compType === 'pay' && salary > 0) {
                  const hourlyRate = salary / 240; // æœˆè–ª/30å¤©/8å°æ™‚
                  // å‰2å°æ™‚ * 1.34, å¾Œé¢ * 1.67
                  let h1 = Math.min(diffHrs, 2);
                  let h2 = Math.max(0, diffHrs - 2);
                  estimatedPay = Math.round((h1 * 1.34 + h2 * 1.67) * hourlyRate);
              }

              const task = db.collection('cams_applications').add({ 
                  category: 'overtime', type: 'åŠ ç­æ´¾å·¥', reason: reason, 
                  company: comp, email: email, userId: email, name: name, 
                  startDate: start, endDate: end, createdAt: new Date(), 
                  compensationType: compType, // pay or leave
                  estimatedPay: estimatedPay,
                  duration: parseFloat(diffHrs.toFixed(1)),
                  status: { employee: "å¾…ç¢ºèª", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" } 
              });
              promises.push(task);
          });
          await Promise.all(promises);
          alert("âœ… æ´¾å·¥å·²ç™¼é€"); checkedBoxes.forEach(cb => cb.checked = false);
      } catch(e) { alert("å¤±æ•—: " + e.message); } 
      finally { btn.innerText = "ğŸš€ é€å‡ºæ´¾å·¥å–®"; btn.disabled = false; }
  }

  // --- ä½¿ç”¨è€…ç®¡ç† ---
  async function loadUsers() { 
      const tbody = document.querySelector("#userTable tbody"); 
      tbody.innerHTML = "<tr><td colspan='6'>è®€å–ä¸­...</td></tr>"; 
      let q = db.collection('cams_users'); 
      if(myRole==='å¤–åŒ…è€é—†') q = q.where('company','==',myCompany); 
      const s = await q.get(); 
      tbody.innerHTML=""; 
      
      const roleOpts = (myRole==='ç®¡ç†è€…'||myRole==='ç”²æ–¹') 
        ? `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option><option value="å¤–åŒ…è€é—†">è€é—†</option><option value="ç”²æ–¹">ç”²æ–¹</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option>`
        : `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option>`;

      s.forEach(doc => { 
          let u = doc.data();
          let shift = u.workShift === 'cleaning' ? 'æ¸…æ½”ç­' : 'æ­£å¸¸ç­';
          let btns = `<select id="r-${doc.id}" style="padding:2px">${roleOpts}</select> <button class="btn-update" onclick="upRole('${doc.id}')">è®Šæ›´</button>`;
          if(myRole==='ç®¡ç†è€…'||myRole==='ç”²æ–¹'||myRole==='å¤–åŒ…è€é—†') btns += `<button class="btn-edit-info" onclick="openEdit('${doc.id}')">ç·¨è¼¯</button>`;
          
          tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.phone||'-'}</td><td>${u.company}<br><small>${u.dept||''}</small></td><td>${shift}</td><td>${u.role}</td><td>${btns}</td></tr>`;
          setTimeout(()=>{ if(document.getElementById(`r-${doc.id}`)) document.getElementById(`r-${doc.id}`).value=u.role; },0);
      }); 
  }
  async function upRole(id) { await db.collection('cams_users').doc(id).update({role:document.getElementById(`r-${id}`).value}); alert("æ›´æ–°æˆåŠŸ"); loadUsers(); }

  // ç·¨è¼¯ Modal
  async function openEdit(id) {
      const d = await db.collection('cams_users').doc(id).get();
      if(!d.exists) return; const u = d.data();
      document.getElementById('editUserId').value = id;
      document.getElementById('editName').value = u.name||"";
      document.getElementById('editPhone').value = u.phone||"";
      document.getElementById('editCompany').value = u.company||"";
      document.getElementById('editDept').value = u.dept||"";
      document.getElementById('editOnboardDate').value = u.onboardDate||"";
      document.getElementById('editShift').value = u.workShift||"normal";
      
      const salInput = document.getElementById('editBaseSalary');
      // åªæœ‰ç‰¹å®šè§’è‰²èƒ½æ”¹è–ªè³‡
      if(myRole==='ç®¡ç†è€…'||myRole==='ç”²æ–¹'||myRole==='å¤–åŒ…è€é—†') {
          salInput.disabled = false; salInput.value = u.baseSalary||"";
      } else {
          salInput.disabled = true; salInput.value = "ç„¡æ¬Šé™";
      }
      document.getElementById('editUserModal').classList.remove('hidden');
  }
  function closeEditModal() { document.getElementById('editUserModal').classList.add('hidden'); }
  async function saveUserEdit() {
      const id = document.getElementById('editUserId').value;
      const data = {
          name: document.getElementById('editName').value,
          phone: document.getElementById('editPhone').value,
          company: document.getElementById('editCompany').value,
          dept: document.getElementById('editDept').value,
          onboardDate: document.getElementById('editOnboardDate').value,
          workShift: document.getElementById('editShift').value
      };
      // åªæœ‰æœ‰æ¬Šé™è€…æ‰æ›´æ–°è–ªè³‡
      if(!document.getElementById('editBaseSalary').disabled) {
          data.baseSalary = parseFloat(document.getElementById('editBaseSalary').value) || 0;
      }
      await db.collection('cams_users').doc(id).set(data, {merge:true});
      alert("å„²å­˜æˆåŠŸ"); closeEditModal(); loadUsers();
  }

  // å¯©æ ¸èˆ‡å…¶ä»–åŠŸèƒ½ (çœç•¥éƒ¨åˆ†é¡¯ç¤ºç´°ç¯€ï¼Œç¶­æŒé‚è¼¯)
  function setupRoleSelect(role) {
      const s = document.getElementById('reviewRoleSelect'); s.innerHTML = "";
      if(role === 'ç®¡ç†è€…') s.innerHTML += `<option value="client">ç”²æ–¹</option><option value="boss">è€é—†</option>`;
      else if(role === 'ç”²æ–¹') s.innerHTML += `<option value="client">ç”²æ–¹</option>`;
      else if(role === 'å¤–åŒ…è€é—†') s.innerHTML += `<option value="boss">è€é—†</option>`;
  }
  async function loadReviewData() {
      // (èˆ‡ä¹‹å‰é‚è¼¯ç›¸åŒï¼Œå¢åŠ åŠ ç­è£œå„Ÿé¡¯ç¤º)
      const role = document.getElementById('reviewRoleSelect').value;
      const tO = document.querySelector("#otTable tbody"); tO.innerHTML="";
      const snap = await db.collection('cams_applications').orderBy('createdAt','desc').limit(50).get();
      snap.forEach(doc=>{
          const d=doc.data(); const st=d.status;
          if(d.category==='overtime') {
              let compText = d.compensationType==='leave' ? 'è£œä¼‘' : `åŠ ç­è²» <br><small>($${d.estimatedPay||0})</small>`;
              let can = (myRole==='ç®¡ç†è€…' || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (role==='boss' && st.employee==='åŒæ„' && st.boss==='å¾…å¯©æ ¸'));
              const btns = can ? `<button class="btn-approve" onclick="review('${doc.id}','${role}','åŒæ„')">åŒæ„</button><button class="btn-reject" onclick="review('${doc.id}','${role}','é€€å›')">é€€å›</button>` : `<span>${st[role]}</span>`;
              tO.innerHTML += `<tr><td>${d.name}</td><td>${compText}</td><td>${d.reason}</td><td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td><td><small>è€:${st.boss} ç”²:${st.client}</small></td><td>${btns}</td></tr>`;
          }
          // (Leave èˆ‡ Correction åˆ—è¡¨çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯ä¸è®Š)
      });
  }
  async function review(id,role,dec) {
      if(!confirm(`ç¢ºå®š ${dec}ï¼Ÿ`)) return;
      const ref = db.collection('cams_applications').doc(id);
      
      // è‹¥æ˜¯åŠ ç­ä¸”é¸æ“‡è£œä¼‘ï¼Œä¸”ç”²æ–¹åŒæ„ï¼Œå‰‡å¢åŠ è©²å“¡å·¥è£œä¼‘æ™‚æ•¸
      if(role==='client' && dec==='åŒæ„') {
          const doc = await ref.get(); const d = doc.data();
          if(d.category==='overtime' && d.compensationType==='leave') {
              const uRef = db.collection('cams_users').doc(d.userId);
              const uSnap = await uRef.get();
              const currentTotal = uSnap.data().compLeaveTotal || 0;
              await uRef.update({ compLeaveTotal: currentTotal + (d.duration||0) });
          }
      }
      await ref.update({[`status.${role}`]: dec});
      alert("æ›´æ–°æˆåŠŸ"); loadReviewData();
  }
  function switchTab(t) { ['review','assign','report','users'].forEach(i => document.getElementById('tab-'+i).classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); if(t==='users')loadUsers(); }
</script>
</body>
</html>
