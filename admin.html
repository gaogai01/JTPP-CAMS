<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›»å» ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f4f6f8; color: #333; }
    .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; }
    
    .hidden { display: none !important; }
    
    /* ç™»å…¥å€ */
    #login-section { text-align: center; padding: 50px 0; }
    .btn-login { background-color: #4285F4; color: white; padding: 12px 24px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; display: inline-flex; align-items: center; }
    .btn-login:hover { background-color: #357ae8; }

    /* åˆ†é ç±¤ */
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #666; background: #f9f9f9; }
    .tab:hover { background: #eee; }
    .tab.active { background: #fff; color: #1a73e8; border-top: 3px solid #1a73e8; border-bottom: 2px solid #fff; }

    /* è¡¨æ ¼æ¨£å¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; }
    th { background-color: #f8f9fa; color: #555; }
    tr:hover { background-color: #f1f1f1; }

    /* æŒ‰éˆ• */
    button { cursor: pointer; border: none; padding: 6px 12px; border-radius: 4px; font-size: 13px; transition: 0.2s; }
    .btn-approve { background: #28a745; color: white; }
    .btn-reject { background: #dc3545; color: white; }
    .btn-update { background: #17a2b8; color: white; }
    .btn-refresh { background: #6c757d; color: white; margin-bottom: 10px; }
    
    /* æ¬Šé™ä¸‹æ‹‰é¸å–® */
    select.role-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    
    /* ä½¿ç”¨è€…è³‡è¨Š */
    .admin-info { text-align: right; margin-bottom: 10px; font-size: 13px; color: #666; }
    .badge { padding: 3px 8px; border-radius: 10px; background: #e2e6ea; font-size: 12px; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ æ‰¿åŒ…å•†ç®¡ç†æ§åˆ¶å°</h2>

  <div id="login-section">
    <p>è«‹ä½¿ç”¨ç®¡ç†å“¡æˆ–ä¸»ç®¡å¸³è™Ÿç™»å…¥</p>
    <button class="btn-login" onclick="loginGoogle()">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div class="admin-info">
        ç®¡ç†å“¡ï¼š<span id="my-name" style="font-weight:bold;"></span> 
        (<span id="my-role">è®€å–ä¸­...</span>)
        <button onclick="logout()" style="background:none; color:blue; text-decoration:underline; padding:0;">ç™»å‡º</button>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('review')">ğŸ“ å¯©æ ¸ä½œæ¥­ (è«‹å‡/åŠ ç­)</div>
      <div class="tab" onclick="switchTab('users')">ğŸ‘¥ äººå“¡æ¬Šé™ç®¡ç†</div>
    </div>

    <div id="tab-review">
        <div style="background:#e9ecef; padding:10px; border-radius:5px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <span>
                <strong>ç•¶å‰å¯©æ ¸èº«åˆ†ï¼š</strong>
                <select id="reviewRoleSelect" style="padding:5px;">
                    </select>
            </span>
            <button class="btn-refresh" onclick="loadReviewData()">ğŸ”„ è®€å–æœ€æ–°å‡å–®</button>
        </div>

        <h3 style="color:#007bff;">è«‹å‡å¯©æ ¸</h3>
        <div style="overflow-x:auto;">
            <table id="leaveTable">
                <thead><tr><th>å§“å</th><th>ä»£ç†äºº</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>ç›®å‰é€²åº¦</th><th>æ“ä½œ</th></tr></thead>
                <tbody><tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr></tbody>
            </table>
        </div>

        <h3 style="color:#6610f2; margin-top:30px;">åŠ ç­å¯©æ ¸</h3>
        <div style="overflow-x:auto;">
            <table id="otTable">
                <thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>ç›®å‰é€²åº¦</th><th>æ“ä½œ</th></tr></thead>
                <tbody><tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-users" class="hidden">
        <button class="btn-refresh" onclick="loadUsers()">ğŸ”„ è®€å–æ‰€æœ‰äººå“¡æ¸…å–®</button>
        <div style="overflow-x:auto;">
            <table id="userTable">
                <thead><tr><th>å§“å</th><th>å…¬å¸ / éƒ¨é–€</th><th>ç›®å‰æ¬Šé™</th><th>ä¿®æ”¹æ¬Šé™</th><th>å‹•ä½œ</th></tr></thead>
                <tbody><tr><td colspan="5">è«‹é»æ“Šè®€å–...</td></tr></tbody>
            </table>
        </div>
    </div>

  </div>
</div>

<script>
  // ================= è¨­å®šå€ =================
  // 1. ä½ çš„ Apps Script ç¶²å€ (/exec çµå°¾)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";
  
  // 2. ä½ çš„ Firebase è¨­å®š (è«‹å¡«å…¥æ­£ç¢ºè³‡è¨Š)
  const firebaseConfig = {
    apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
    authDomain: "tpc-monitor.firebaseapp.com",
    projectId: "tpc-monitor",
    storageBucket: "tpc-monitor.firebasestorage.app",
    messagingSenderId: "1066125366380",
    appId: "1:1066125366380:web:836d5898c051226669f449"
  };
  // =========================================

  // åˆå§‹åŒ– Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null;
  let myRole = ""; // æˆ‘çš„æ¬Šé™ (å¾ Firebase è®€å–)

  // 1. ç™»å…¥è™•ç†
  function loginGoogle() {
    auth.signInWithPopup(provider).catch(e => alert(e.message));
  }
  function logout() { auth.signOut().then(()=>location.reload()); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('my-name').innerText = user.displayName;
      
      // è®€å–æˆ‘çš„æ¬Šé™
      const doc = await db.collection('users').doc(user.email).get();
      if(doc.exists) {
          myRole = doc.data().role || "å¤–åŒ…å“¡å·¥";
      } else {
          myRole = "è¨ªå®¢"; // æœªè¨»å†Š
      }
      document.getElementById('my-role').innerText = myRole;
      
      // è¨­å®šä¸‹æ‹‰é¸å–® (æ ¹æ“šæ¬Šé™è‡ªå‹•åˆ‡æ›)
      setupRoleSelect(myRole);
      
      // é è¨­è¼‰å…¥å¯©æ ¸è³‡æ–™
      loadReviewData();
    }
  });

  function setupRoleSelect(role) {
      const select = document.getElementById('reviewRoleSelect');
      select.innerHTML = "";
      
      // æ ¹æ“šèº«åˆ†é¡¯ç¤ºå¯ç”¨çš„å¯©æ ¸è§’è‰²
      if(role === 'ç®¡ç†è€…') {
          select.innerHTML += `<option value="client">ç”²æ–¹</option><option value="boss">è€é—†</option><option value="leader">é ˜ç­</option><option value="agent">ä»£ç†äºº</option>`;
      } else if (role === 'ç”²æ–¹') {
          select.innerHTML += `<option value="client">ç”²æ–¹</option>`;
      } else if (role === 'å¤–åŒ…è€é—†') {
          select.innerHTML += `<option value="boss">è€é—†</option>`;
      } else if (role === 'å¤–åŒ…é ˜ç­') {
          select.innerHTML += `<option value="leader">é ˜ç­</option><option value="agent">ä»£ç†äºº</option>`;
      } else {
          select.innerHTML += `<option value="">ç„¡å¯©æ ¸æ¬Šé™</option>`;
      }
  }

  // =========================================
  // åŠŸèƒ½ A: å¯©æ ¸ä½œæ¥­ (è®€å– GAS)
  // =========================================
  function loadReviewData() {
    const currentReviewRole = document.getElementById('reviewRoleSelect').value;
    if(!currentReviewRole) {
        document.querySelector("#leaveTable tbody").innerHTML = "<tr><td colspan='6'>æ‚¨æ²’æœ‰å¯©æ ¸æ¬Šé™</td></tr>";
        document.querySelector("#otTable tbody").innerHTML = "<tr><td colspan='5'>æ‚¨æ²’æœ‰å¯©æ ¸æ¬Šé™</td></tr>";
        return;
    }

    document.querySelector("#leaveTable tbody").innerHTML = "<tr><td colspan='6'>è®€å–è³‡æ–™ä¸­...</td></tr>";
    
    // é€™è£¡æˆ‘å€‘éœ€è¦ä¸€å€‹ GAS æ¬Šé™è·³æ¿ (ä½¿ç”¨ Email é©—è­‰)
    // é›–ç„¶å‰ç«¯æ˜¯ç”¨ Firebase ç™»å…¥ï¼Œä½†å¾Œç«¯ GAS é‚„æ˜¯éœ€è¦ä¸€å€‹æ†‘è­‰ï¼Œé€™è£¡æˆ‘å€‘ç°¡å–®å‚³é€ Email è®“ GAS çŸ¥é“æ˜¯èª°
    // æ³¨æ„ï¼šæ­£å¼ç’°å¢ƒå»ºè­°ç”¨æ›´åš´è¬¹çš„ Token äº¤æ›ï¼Œé€™è£¡æ¼”ç¤ºå¯è¡Œåšæ³•
    
    fetch(GAS_URL, { 
        method: "POST", 
        body: JSON.stringify({ 
            action: "getAdminData", 
            credential: "dummy_token_for_now", // å› ç‚ºå¾Œç«¯æ”¹ç”¨ isAdmin(email) åˆ¤æ–·ï¼Œé€™è£¡éœ€è¦é…åˆä¿®æ”¹å¾Œç«¯é‚è¼¯
            // â˜… ä¿®æ”¹å»ºè­°ï¼šç‚ºäº†è®“é€™å€‹èƒ½é‹ä½œï¼Œä½ çš„ Code.gs getAdminData 
            // å¿…é ˆæ”¹æˆæ¥å—ç›´æ¥å‚³å…¥çš„ email åƒæ•¸ï¼Œæˆ–è€…å‰ç«¯ç”Ÿæˆä¸€å€‹æ¨¡æ“¬ token
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å‡å®š Code.gs çš„ isAdmin æª¢æŸ¥çš„æ˜¯ 'currentUser.email'
            // ä½†å› ç‚º verifyGoogleToken éœ€è¦çœŸå¯¦ Google Tokenï¼Œæˆ‘å€‘é€™è£¡å…¶å¯¦å‚³ä¸äº†ã€‚
            
            // â˜… è§£æ±ºæ–¹æ¡ˆï¼šæˆ‘å€‘ç”¨ä¸€å€‹ç‰¹æ®Šçš„ actionï¼Œä¸¦æŠŠ email æ˜ç¢¼å‚³éå» (åƒ…é™ä¿¡ä»»ç’°å¢ƒ)
            // æˆ–è€…ï¼Œå¦‚æœä½ çš„ GAS éƒ¨ç½²ç‚º "åŸ·è¡Œèº«åˆ†: æˆ‘"ï¼Œå‰ç«¯å°±ç„¡æ³•ç›´æ¥å–å¾— User Emailã€‚
            // æœ€å¥½çš„æ–¹å¼æ˜¯ï¼šå‰ç«¯æŠŠ Firebase User Token å‚³çµ¦ GASï¼ŒGAS é©—è­‰ Firebase Tokenã€‚
            // ä½†é€™å¤ªè¤‡é›œäº†ã€‚
            
            // â˜… æš«æ™‚è§£æ³•ï¼šè«‹åœ¨ Code.gs çš„ processData ä¸­ï¼Œå…è¨±æ¥æ”¶ explicitEmail åƒæ•¸
            explicitEmail: currentUser.email
        }) 
    })
    .then(r => r.json())
    .then(res => {
        if(res.success) {
            renderLeaveTable(res.data.leave);
            renderOtTable(res.data.overtime);
        } else {
            // å¦‚æœ GAS é©—è­‰å¤±æ•— (å› ç‚ºæˆ‘å€‘å‚³çš„æ˜¯ explicitEmail)
            // é€™è£¡é¡¯ç¤ºéŒ¯èª¤
            alert("è®€å–å¤±æ•—ï¼š" + res.message);
        }
    });
  }
  
  // â˜… é‡è¦ï¼šä¸Šé¢çš„ fetch å‘¼å«æœƒå¤±æ•—ï¼Œå› ç‚º Code.gs é æœŸçš„æ˜¯ Google ID Token
  // æˆ‘å€‘éœ€è¦ä¿®æ”¹ Code.gs ä¾†æ”¯æ´é€™ç¨®ã€Œç°¡æ˜“ã€å‘¼å«ï¼Œæˆ–è€…æˆ‘å€‘æ”¹ç”¨ Google Sign-In æŒ‰éˆ•ç”¢ç”Ÿçš„ Token
  // æ—¢ç„¶ä½ å·²ç¶“ç”¨äº† Firebase Authï¼Œæˆ‘å€‘å¯ä»¥å¿½ç•¥ Code.gs çš„ Google Token é©—è­‰ï¼Œæ”¹ç”¨æˆ‘å€‘å‚³å…¥çš„åƒæ•¸
  
  // ä¿®æ­£ fetch é‚è¼¯ (é…åˆä¿®æ”¹å¾Œçš„ Code.gs)
  function callGAS(payload) {
      // è£œä¸Šä½¿ç”¨è€… Email èˆ‡ è§’è‰²ï¼Œè®“ GAS çŸ¥é“æ˜¯èª°
      payload.userEmail = currentUser.email; 
      payload.userRole = myRole; // å‚³é€ Firebase çš„è§’è‰²çµ¦ GAS åƒè€ƒ
      
      return fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(payload)
      }).then(r => r.json());
  }

  // é‡æ–°å¯¦ä½œ loadReviewData (ä½¿ç”¨æ–°çš„ callGAS)
  function loadReviewData() {
      const tbodyL = document.querySelector("#leaveTable tbody");
      const tbodyO = document.querySelector("#otTable tbody");
      tbodyL.innerHTML = "<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>";
      tbodyO.innerHTML = "<tr><td colspan='5'>è¼‰å…¥ä¸­...</td></tr>";

      callGAS({ action: "getAdminData" }).then(res => {
          if(res.success) {
              renderLeaveTable(res.data.leave);
              renderOtTable(res.data.overtime);
          } else {
              tbodyL.innerHTML = `<tr><td colspan='6'>${res.message}</td></tr>`;
              tbodyO.innerHTML = `<tr><td colspan='5'>${res.message}</td></tr>`;
          }
      });
  }

  function renderLeaveTable(data) {
    const tbody = document.querySelector(`#leaveTable tbody`);
    tbody.innerHTML = "";
    if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='6'>ç„¡å¾…å¯©æ ¸è³‡æ–™</td></tr>"; return; }

    data.forEach(item => {
        let role = document.getElementById('reviewRoleSelect').value;
        // åˆ¤æ–·ç›®å‰èº«åˆ†æ˜¯å¦è©²å¯©æ ¸
        // é‚è¼¯ï¼šçœ‹è©²æ¬„ä½æ˜¯å¦ç‚º "å¾…å¯©æ ¸"
        let myStatus = "æœªçŸ¥";
        if(role === 'agent') myStatus = item.agentSign;
        if(role === 'leader') myStatus = item.leader;
        if(role === 'boss') myStatus = item.boss;
        if(role === 'client') myStatus = item.client;

        let btns = "";
        if(myStatus === 'å¾…å¯©æ ¸') {
            btns = `<button class="btn-approve" onclick="doReview('leave', ${item.id}, 'åŒæ„')">åŒæ„</button> 
                    <button class="btn-reject" onclick="doReview('leave', ${item.id}, 'é€€å›')">é€€å›</button>`;
        } else {
            btns = `<span style="color:gray">${myStatus}</span>`;
        }

        let statusText = `<small>ä»£:${item.agentSign} | é ˜:${item.leader} | è€:${item.boss} | ç”²:${item.client}</small>`;
        tbody.innerHTML += `<tr>
            <td>${item.name}</td><td>${item.agentName}</td><td>${item.type}</td>
            <td><small>${item.start.replace('T',' ')}<br>~${item.end.split('T')[1]}</small></td>
            <td>${statusText}</td><td>${btns}</td>
        </tr>`;
    });
  }

  function renderOtTable(data) {
    const tbody = document.querySelector(`#otTable tbody`);
    tbody.innerHTML = "";
    if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>ç„¡å¾…å¯©æ ¸è³‡æ–™</td></tr>"; return; }

    data.forEach(item => {
        let role = document.getElementById('reviewRoleSelect').value;
        if(role === 'agent' || role === 'leader') { // åŠ ç­åªæœ‰è€é—†è·Ÿç”²æ–¹
             // é€™è£¡å¯ä»¥é¸æ“‡ä¸é¡¯ç¤ºï¼Œæˆ–è€…é¡¯ç¤ºå”¯è®€
        }
        
        let myStatus = (role === 'boss') ? item.boss : (role === 'client' ? item.client : 'ç„¡æ¬Šé™');
        
        let btns = "";
        if(myStatus === 'å¾…å¯©æ ¸') {
            btns = `<button class="btn-approve" onclick="doReview('overtime', ${item.id}, 'åŒæ„')">åŒæ„</button> 
                    <button class="btn-reject" onclick="doReview('overtime', ${item.id}, 'é€€å›')">é€€å›</button>`;
        } else {
            btns = `<span style="color:gray">${myStatus}</span>`;
        }

        let statusText = `<small>è€:${item.boss} | ç”²:${item.client}</small>`;
        tbody.innerHTML += `<tr>
            <td>${item.name}</td><td>${item.type}</td>
            <td><small>${item.start.replace('T',' ')}<br>~${item.end.split('T')[1]}</small></td>
            <td>${statusText}</td><td>${btns}</td>
        </tr>`;
    });
  }

  function doReview(category, id, decision) {
      let role = document.getElementById('reviewRoleSelect').value;
      if(!confirm(`ç¢ºå®šè¦ä»¥ [${role}] èº«åˆ†åŸ·è¡Œ [${decision}] å—ï¼Ÿ`)) return;
      
      callGAS({
          action: "reviewRequest",
          category: category,
          id: id,
          role: role,
          decision: decision
      }).then(res => {
          alert(res.message);
          loadReviewData(); // é‡æ–°æ•´ç†
      });
  }

  // =========================================
  // åŠŸèƒ½ B: äººå“¡æ¬Šé™ç®¡ç† (è®€å– Firebase)
  // =========================================
  async function loadUsers() {
      if(myRole !== "ç®¡ç†è€…") {
          document.getElementById('userTable').innerHTML = "<p style='padding:20px;text-align:center;'>æ‚¨æ²’æœ‰æ¬Šé™ç®¡ç†äººå“¡</p>";
          return;
      }
      
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "<tr><td colspan='5'>è®€å–ä¸­...</td></tr>";
      
      const snapshot = await db.collection('users').get();
      tbody.innerHTML = "";
      
      snapshot.forEach(doc => {
          let u = doc.data();
          let row = `<tr>
            <td>${u.name || u.email}</td>
            <td>${u.company || "-"} / ${u.dept || "-"}</td>
            <td><span class="badge">${u.role || "æœªè¨­å®š"}</span></td>
            <td>
                <select id="role-${doc.id}" class="role-select">
                    <option value="å¤–åŒ…å“¡å·¥" ${u.role==='å¤–åŒ…å“¡å·¥'?'selected':''}>å¤–åŒ…å“¡å·¥</option>
                    <option value="å¤–åŒ…é ˜ç­" ${u.role==='å¤–åŒ…é ˜ç­'?'selected':''}>å¤–åŒ…é ˜ç­</option>
                    <option value="å¤–åŒ…è€é—†" ${u.role==='å¤–åŒ…è€é—†'?'selected':''}>å¤–åŒ…è€é—†</option>
                    <option value="ç”²æ–¹" ${u.role==='ç”²æ–¹'?'selected':''}>ç”²æ–¹</option>
                    <option value="ç®¡ç†è€…" ${u.role==='ç®¡ç†è€…'?'selected':''}>ç®¡ç†è€…</option>
                </select>
            </td>
            <td><button class="btn-update" onclick="updateRole('${doc.id}')">è®Šæ›´</button></td>
          </tr>`;
          tbody.innerHTML += row;
      });
  }

  async function updateRole(email) {
      let newRole = document.getElementById('role-' + email).value;
      if(!confirm(`ç¢ºå®šå°‡ ${email} çš„æ¬Šé™ä¿®æ”¹ç‚º ${newRole} å—ï¼Ÿ`)) return;
      
      try {
          await db.collection('users').doc(email).update({ role: newRole });
          alert("æ¬Šé™ä¿®æ”¹æˆåŠŸï¼");
          loadUsers();
      } catch(e) {
          alert("ä¿®æ”¹å¤±æ•—ï¼š" + e.message);
      }
  }

  // åˆ‡æ›åˆ†é 
  function switchTab(t) {
      ['review', 'users'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
      document.getElementById('tab-'+t).classList.remove('hidden');
      
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      
      if(t === 'users') loadUsers();
  }
</script>
</body>
</html>
