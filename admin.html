<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é›»å» ç®¡ç†å¾Œå° (Firebase)</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f4f6f8; }
    .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; }
    h2 { text-align: center; color: #333; } .hidden { display: none !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background: #f8f9fa; }
    .btn-approve { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .btn-reject { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .btn-update { background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .role-select { margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 5px; text-align: center; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; background: #f9f9f9; }
    .tab.active { background: #fff; border-top: 3px solid #1a73e8; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ ç®¡ç†æ§åˆ¶å°</h2>
  <div id="login-section" style="text-align:center; padding:50px;">
    <button onclick="loginGoogle()" style="padding:10px 20px;">Google ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div style="text-align:right; margin-bottom:10px;">
        ç®¡ç†å“¡ï¼š<span id="my-name" style="font-weight:bold;"></span> (<span id="my-role">...</span>)
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('review')">å¯©æ ¸ä½œæ¥­</div>
      <div class="tab" onclick="switchTab('users')">æ¬Šé™ç®¡ç†</div>
    </div>

    <div id="tab-review">
        <div class="role-select">
            ç•¶å‰èº«åˆ†ï¼š<select id="reviewRoleSelect" onchange="loadReviewData()"></select>
            <button onclick="loadReviewData()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <h3>è«‹å‡å¯©æ ¸</h3>
        <table id="leaveTable"><thead><tr><th>å§“å</th><th>ä»£ç†äºº</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <h3 style="margin-top:30px;">åŠ ç­å¯©æ ¸</h3>
        <table id="otTable"><thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-users" class="hidden">
        <button onclick="loadUsers()">ğŸ”„ åˆ·æ–°åå–®</button>
        <table id="userTable"><thead><tr><th>å§“å</th><th>Email</th><th>å…¬å¸</th><th>ç›®å‰æ¬Šé™</th><th>ä¿®æ”¹</th><th>å‹•ä½œ</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… ä½ çš„ Firebase Config â˜…â˜…â˜…
  const firebaseConfig = {
    apiKey: "AIzaSyA58DOYplXhmo7HDYN_2Hgu-wo4ceYmINA",
    authDomain: "tpc-monitor.firebaseapp.com",
    projectId: "tpc-monitor",
    storageBucket: "tpc-monitor.firebasestorage.app",
    messagingSenderId: "1066125366380",
    appId: "1:1066125366380:web:836d5898c051226669f449"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null, myRole = "";

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('my-name').innerText = user.displayName;
      
      const doc = await db.collection('cams_users').doc(user.email).get();
      myRole = doc.exists ? doc.data().role : "è¨ªå®¢";
      document.getElementById('my-role').innerText = myRole;
      
      setupRoleSelect(myRole);
      loadReviewData();
    }
  });

  function setupRoleSelect(role) {
      const s = document.getElementById('reviewRoleSelect'); s.innerHTML = "";
      if(role === 'ç®¡ç†è€…') s.innerHTML += `<option value="client">ç”²æ–¹</option><option value="boss">è€é—†</option><option value="leader">é ˜ç­</option><option value="agent">ä»£ç†äºº</option>`;
      else if(role === 'ç”²æ–¹') s.innerHTML += `<option value="client">ç”²æ–¹</option>`;
      else if(role === 'å¤–åŒ…è€é—†') s.innerHTML += `<option value="boss">è€é—†</option>`;
      else if(role === 'å¤–åŒ…é ˜ç­') s.innerHTML += `<option value="leader">é ˜ç­</option><option value="agent">ä»£ç†äºº</option>`;
      else s.innerHTML = `<option value="">ç„¡æ¬Šé™</option>`;
  }

  // A. å¯©æ ¸åŠŸèƒ½
  async function loadReviewData() {
    const role = document.getElementById('reviewRoleSelect').value;
    const tL = document.querySelector("#leaveTable tbody");
    const tO = document.querySelector("#otTable tbody");
    tL.innerHTML = "<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>";
    tO.innerHTML = "<tr><td colspan='5'>è¼‰å…¥ä¸­...</td></tr>";

    if(!role) { tL.innerHTML=""; tO.innerHTML=""; return; }

    // æŠ“å–æ‰€æœ‰ç”³è«‹ (å¯å„ªåŒ–ç‚ºåªæŠ“å¾…å¯©æ ¸)
    const snapshot = await db.collection('cams_applications').orderBy('createdAt', 'desc').limit(50).get();
    tL.innerHTML = ""; tO.innerHTML = "";

    snapshot.forEach(doc => {
        let d = doc.data();
        let id = doc.id;
        
        if(d.category === 'leave') {
            let status = d.status;
            let myStatus = status[role]; // agent, leader, boss, client
            // åˆ¤æ–·æ˜¯å¦è¼ªåˆ°æˆ‘
            let canReview = false;
            if(role==='agent' && status.agent==='å¾…å¯©æ ¸') canReview=true;
            if(role==='leader' && status.agent==='åŒæ„' && status.leader==='å¾…å¯©æ ¸') canReview=true;
            if(role==='boss' && status.leader==='åŒæ„' && status.boss==='å¾…å¯©æ ¸') canReview=true;
            if(role==='client' && status.boss==='åŒæ„' && status.client==='å¾…å¯©æ ¸') canReview=true;

            // å¦‚æœæˆ‘æ˜¯ç®¡ç†è€…ï¼Œé–‹å•Ÿä¸Šå¸æ¨¡å¼ (å…¨éƒ½å¯ä»¥å¯©)
            if(myRole === 'ç®¡ç†è€…' && myStatus === 'å¾…å¯©æ ¸') canReview = true;

            let btns = canReview ? 
                `<button class="btn-approve" onclick="review('${id}', '${role}', 'åŒæ„')">åŒæ„</button> 
                 <button class="btn-reject" onclick="review('${id}', '${role}', 'é€€å›')">é€€å›</button>` : 
                `<span>${myStatus}</span>`;

            let progress = `<small>ä»£:${status.agent} é ˜:${status.leader} è€:${status.boss} ç”²:${status.client}</small>`;
            tL.innerHTML += `<tr><td>${d.name}</td><td>${d.agentName}</td><td>${d.type}</td>
                <td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td>
                <td>${progress}</td><td>${btns}</td></tr>`;
        } 
        else { // åŠ ç­
            let status = d.status;
            let myStatus = status[role]; 
            // åŠ ç­åªæœ‰ boss, client
            let canReview = false;
            if(role==='boss' && status.boss==='å¾…å¯©æ ¸') canReview=true;
            if(role==='client' && status.boss==='åŒæ„' && status.client==='å¾…å¯©æ ¸') canReview=true;
            if(myRole === 'ç®¡ç†è€…' && myStatus === 'å¾…å¯©æ ¸') canReview = true;

            if(role === 'agent' || role === 'leader') return; // åŠ ç­ä¸ç”¨é€™å…©å±¤

            let btns = canReview ? 
                `<button class="btn-approve" onclick="review('${id}', '${role}', 'åŒæ„')">åŒæ„</button> 
                 <button class="btn-reject" onclick="review('${id}', '${role}', 'é€€å›')">é€€å›</button>` : 
                `<span>${myStatus}</span>`;

            let progress = `<small>è€:${status.boss} ç”²:${status.client}</small>`;
            tO.innerHTML += `<tr><td>${d.name}</td><td>${d.type}</td>
                <td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td>
                <td>${progress}</td><td>${btns}</td></tr>`;
        }
    });
  }

  async function review(id, role, decision) {
      if(!confirm(`ç¢ºå®š ${decision}ï¼Ÿ`)) return;
      // æ›´æ–° Firestore ä¸­ status ç‰©ä»¶çš„ç‰¹å®šæ¬„ä½
      // èªæ³•: "status.agent": "åŒæ„"
      let updateField = {};
      updateField[`status.${role}`] = decision;
      
      await db.collection('cams_applications').doc(id).update(updateField);
      alert("å·²æ›´æ–°");
      loadReviewData();
  }

  // B. æ¬Šé™ç®¡ç†
  async function loadUsers() {
      if(myRole !== "ç®¡ç†è€…") { alert("æ¬Šé™ä¸è¶³"); return; }
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "<tr><td colspan='6'>è®€å–ä¸­...</td></tr>";
      
      const snap = await db.collection('cams_users').get();
      tbody.innerHTML = "";
      
      snap.forEach(doc => {
          let u = doc.data();
          tbody.innerHTML += `<tr>
            <td>${u.name}</td><td>${u.email}</td><td>${u.company}</td><td>${u.role}</td>
            <td>
                <select id="role-${doc.id}">
                    <option value="å¤–åŒ…å“¡å·¥">å¤–åŒ…å“¡å·¥</option>
                    <option value="å¤–åŒ…é ˜ç­">å¤–åŒ…é ˜ç­</option>
                    <option value="å¤–åŒ…è€é—†">å¤–åŒ…è€é—†</option>
                    <option value="ç”²æ–¹">ç”²æ–¹</option>
                    <option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                </select>
            </td>
            <td><button class="btn-update" onclick="updateRole('${doc.id}')">è®Šæ›´</button></td>
          </tr>`;
      });
  }

  async function updateRole(id) {
      let newRole = document.getElementById(`role-${id}`).value;
      await db.collection('cams_users').doc(id).update({ role: newRole });
      alert("æ¬Šé™å·²æ›´æ–°");
      loadUsers();
  }

  function switchTab(t) {
      ['review', 'users'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
      document.getElementById('tab-'+t).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
      event.target.classList.add('active');
      if(t==='users') loadUsers();
  }
</script>
</body>
</html>
