<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é›»å» ç®¡ç†å¾Œå°</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f4f6f8; margin:0; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; min-height: 80vh; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    h2 { text-align: center; color: #2c3e50; } 
    .hidden { display: none !important; }
    
    /* --- è¡¨æ ¼æ¨£å¼ --- */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; } 
    th { background: #f8f9fa; color: #555; font-weight: bold; }
    tr:hover { background-color: #f1f1f1; }
    
    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    button { cursor: pointer; transition: 0.2s; border: none; font-family: inherit; }
    .btn-approve { background: #28a745; color: white; padding: 6px 12px; border-radius: 4px; }
    .btn-reject { background: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; }
    .btn-create { background: #6f42c1; color: white; padding: 10px 20px; border-radius: 6px; font-size: 16px; }
    .btn-update { background: #17a2b8; color: white; padding: 6px 12px; border-radius: 4px; margin-right: 5px; }
    .btn-edit-info { background: #ffc107; color: #333; padding: 6px 12px; border-radius: 4px; font-weight: bold; }
    .btn-export { background: #ff9800; color: white; padding: 8px 15px; border-radius: 4px; font-weight: bold; }
    .btn-close { background: #6c757d; color: white; padding: 8px 20px; border-radius: 6px; }

    /* --- é¸å–® Tabs (æ·±è‰²é¢¨æ ¼) --- */
    .tabs { 
        display: flex; margin-bottom: 20px; background-color: #34495e; 
        border-radius: 8px 8px 0 0; overflow: hidden; 
    }
    .tab { 
        flex: 1; padding: 15px; text-align: center; cursor: pointer; 
        font-weight: bold; color: #ecf0f1; transition: 0.3s; border-bottom: 3px solid transparent; 
    }
    .tab:hover { background-color: #2c3e50; }
    .tab.active { background: #f4f6f8; color: #2c3e50; border-bottom: 3px solid #e74c3c; }

    /* --- ç¯©é¸èˆ‡æ´¾å·¥å€ --- */
    .role-select { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; text-align: center; }
    .assign-box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fff; }
    .assign-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px; }

    /* --- å ±è¡¨å€ --- */
    .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .report-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .report-title { font-weight: bold; color: #333; margin-bottom: 15px; display: block; border-left: 4px solid #1a73e8; padding-left: 10px; font-size: 16px; }
    .filter-row { display: flex; flex-direction: column; gap: 10px; }

    /* --- â˜… ç·¨è¼¯è³‡æ–™ Modal (å½ˆå‡ºè¦–çª—) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
    }
    .modal-box {
        background: white; padding: 30px; border-radius: 12px; width: 400px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-box h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .modal-row input, .modal-row select { width: 100%; box-sizing: border-box; }
    .modal-actions { text-align: right; margin-top: 20px; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ é›»å» ç®¡ç†å¾Œå°</h2>
  <div id="login-section" style="text-align:center; padding:50px;">
    <button onclick="loginGoogle()" style="padding:10px 20px; font-size:16px;">ğŸ”µ Google ç®¡ç†å“¡ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div style="text-align:right; margin-bottom:10px;">
        ç®¡ç†å“¡ï¼š<span id="my-name" style="font-weight:bold;"></span> 
        (<span id="my-role" style="color:blue;"></span>)
    </div>

    <div class="tabs">
      <div id="tab-btn-review" class="tab active" onclick="switchTab('review')">å¯©æ ¸ä½œæ¥­</div>
      <div id="tab-btn-assign" class="tab" onclick="switchTab('assign')">ç”²æ–¹æ´¾å·¥</div>
      <div id="tab-btn-report" class="tab" onclick="switchTab('report')">å ±è¡¨ä¸­å¿ƒ</div>
      <div id="tab-btn-users" class="tab" onclick="switchTab('users')">æ¬Šé™/è³‡æ–™ç®¡ç†</div>
    </div>

    <div id="tab-review">
        <div class="role-select">
            ç•¶å‰å¯©æ ¸èº«åˆ†ï¼š<select id="reviewRoleSelect" onchange="loadReviewData()"></select>
            <button class="btn-update" onclick="loadReviewData()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <h3>è«‹å‡å¯©æ ¸</h3>
        <table id="leaveTable"><thead><tr><th>å§“å</th><th>ä»£ç†äºº</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <h3 style="margin-top:30px;">åŠ ç­å¯©æ ¸</h3>
        <table id="otTable"><thead><tr><th>å§“å</th><th>äº‹ç”±</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <h3 style="margin-top:30px; color:#007bff;">è£œåˆ·å¡å¯©æ ¸</h3>
        <table id="fixTable"><thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ—¥æœŸæ™‚é–“</th><th>äº‹ç”±</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-assign" class="hidden">
        <div class="assign-box">
            <h3>ğŸ“ æ–°å¢åŠ ç­æ´¾å·¥å–®</h3>
            <div class="assign-row">
                <label>å» å•†ï¼š</label><select id="assignCompany" onchange="loadEmployees(this.value)"><option>è«‹é¸æ“‡</option></select>
                <label>å“¡å·¥ï¼š</label><select id="assignEmployee"><option>å…ˆé¸å» å•†</option></select>
            </div>
            <div class="assign-row"><label>äº‹ç”±ï¼š</label><input type="text" id="assignReason" style="flex:1" placeholder="è«‹è¼¸å…¥åŠ ç­äº‹ç”±"></div>
            <div class="assign-row"><label>é–‹å§‹ï¼š</label><input type="datetime-local" id="assignStart"><label>çµæŸï¼š</label><input type="datetime-local" id="assignEnd"></div>
            <button class="btn-create" onclick="createAssignment()">é€å‡ºæ´¾å·¥å–®</button>
        </div>
    </div>

    <div id="tab-report" class="hidden">
        <div class="report-grid">
            <div class="report-card">
                <span class="report-title">ğŸ“… æ¯æ—¥è€ƒå‹¤è¡¨</span>
                <div class="filter-row">
                    <label>å…¬å¸ï¼š <select class="rpt-comp"><option value="">å…¨éƒ¨</option></select></label>
                    <label>æœˆä»½ï¼š <input type="month" id="rptDate1"></label>
                    <button class="btn-export" onclick="exportAttendanceReport()">ğŸ“¥ åŒ¯å‡ºç´€éŒ„</button>
                </div>
            </div>
            <div class="report-card">
                <span class="report-title">ğŸ’° åŠ ç­çµ±è¨ˆè¡¨ (å·²æ ¸å‡†)</span>
                <div class="filter-row">
                    <label>å…¬å¸ï¼š <select class="rpt-comp"><option value="">å…¨éƒ¨</option></select></label>
                    <label>æœˆä»½ï¼š <input type="month" id="rptDate2"></label>
                    <button class="btn-export" onclick="exportOtReport()">ğŸ“¥ åŒ¯å‡ºæ˜ç´°</button>
                </div>
            </div>
            <div class="report-card">
                <span class="report-title">ğŸ¤’ è«‹å‡çµ±è¨ˆè¡¨ (å·²æ ¸å‡†)</span>
                <div class="filter-row">
                    <label>å…¬å¸ï¼š <select class="rpt-comp"><option value="">å…¨éƒ¨</option></select></label>
                    <label>æœˆä»½ï¼š <input type="month" id="rptDate3"></label>
                    <button class="btn-export" onclick="exportLeaveReport()">ğŸ“¥ åŒ¯å‡ºæ˜ç´°</button>
                </div>
            </div>
            <div class="report-card">
                <span class="report-title">ğŸŒ´ ç‰¹ä¼‘é¤˜é¡çµ±è¨ˆè¡¨</span>
                <div class="filter-row">
                    <label>å…¬å¸ï¼š <select class="rpt-comp"><option value="">å…¨éƒ¨</option></select></label>
                    <label>åŸºæº–æ—¥ï¼š <input type="date" id="rptDate4"></label>
                    <button class="btn-export" onclick="exportAnnualReport()">ğŸ“¥ åŒ¯å‡ºé¤˜é¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-users" class="hidden">
        <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>å¯ä¿®æ”¹å“¡å·¥è§’è‰²ã€åˆ°è·æ—¥èˆ‡ç¾¤çµ„è¨­å®š</span>
            <button class="btn-update" onclick="loadUsers()">ğŸ”„ åˆ·æ–°åå–®</button>
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å…¬å¸/éƒ¨é–€</th>
                    <th>ç›®å‰ç¾¤çµ„(ç­åˆ¥)</th>
                    <th>æ¬Šé™è§’è‰²</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

  </div> <div id="editUserModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>âœï¸ ç·¨è¼¯å“¡å·¥è³‡æ–™</h3>
        <input type="hidden" id="editUserId">
        
        <div class="modal-row">
            <label>å§“å</label>
            <input type="text" id="editName">
        </div>
        <div class="modal-row">
            <label>å…¬å¸</label>
            <input type="text" id="editCompany">
        </div>
        <div class="modal-row">
            <label>éƒ¨é–€</label>
            <input type="text" id="editDept">
        </div>
        
        <div class="modal-row">
            <label>ç¾¤çµ„ (å½±éŸ¿ä¸Šä¸‹ç­æ™‚é–“)</label>
            <select id="editShift">
                <option value="maintenance">ç¶­è­·è¡Œæ”¿ç¾¤ (08:00~16:30)</option>
                <option value="cleaning">æ¸…æ½”ç¾¤ (08:00~17:00)</option>
            </select>
        </div>

        <div class="modal-row">
            <label>åˆ°è·æ—¥ (å½±éŸ¿ç‰¹ä¼‘è¨ˆç®—)</label>
            <input type="date" id="editOnboardDate">
        </div>

        <div class="modal-actions">
            <button class="btn-close" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-create" onclick="saveUserEdit()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>
  </div>

</div>

<script>
  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null, myRole = "", myCompany = "";

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const doc = await db.collection('cams_users').doc(user.email).get();
      if(doc.exists) { 
          const d = doc.data();
          myRole = d.role; myCompany = d.company; 
          if(myRole === 'å¤–åŒ…å“¡å·¥' || myRole === 'å¤–åŒ…é ˜ç­') { alert("æ¬Šé™ä¸è¶³"); window.location.href = "index.html"; return; }
      } else { myRole = "è¨ªå®¢"; }
      
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('my-name').innerText = user.displayName;
      document.getElementById('my-role').innerText = myRole;
      
      setupRoleSelect(myRole);
      loadCompanyList();
      loadReviewData();
      
      // é è¨­æ—¥æœŸ
      const ymd = new Date().toISOString().slice(0, 7);
      ['rptDate1','rptDate2','rptDate3'].forEach(id => document.getElementById(id).value = ymd);
      document.getElementById('rptDate4').value = new Date().toISOString().slice(0, 10);
    }
  });

  // --- è¼‰å…¥å…¬å¸åˆ—è¡¨ ---
  async function loadCompanyList() {
      const snap = await db.collection('cams_users').get();
      let s = new Set(); snap.forEach(d => { if(d.data().company) s.add(d.data().company); });
      let html = "<option value=''>è«‹é¸æ“‡</option>";
      let allHtml = "<option value=''>å…¨éƒ¨å…¬å¸</option>";
      s.forEach(c => { html += `<option value="${c}">${c}</option>`; allHtml += `<option value="${c}">${c}</option>`; });
      document.getElementById('assignCompany').innerHTML = html;
      document.querySelectorAll('.rpt-comp').forEach(el => el.innerHTML = allHtml);
  }

  // --- å ±è¡¨åŒ¯å‡ºé‚è¼¯ (ç°¡åŒ–ç‰ˆï¼Œè«‹ç¢ºä¿ index.html å·²åŒ…å«å®Œæ•´é‚è¼¯) ---
  function downloadCSV(data, filename) {
      let csvContent = "\uFEFF" + data.map(e => e.join(",")).join("\n");
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }
  // é€™è£¡ä¿ç•™ç©ºæ®¼å‡½å¼ï¼Œé¿å…å ±éŒ¯ã€‚è«‹æ ¹æ“šä¹‹å‰æä¾›çš„ admin.html å ±è¡¨é‚è¼¯å¡«å……å…§å®¹ï¼Œæˆ–ç›´æ¥è¤‡è£½ä¹‹å‰çš„å ±è¡¨éƒ¨åˆ†ã€‚
  async function exportAttendanceReport() { alert("è«‹åŒ¯å…¥å®Œæ•´çš„å ±è¡¨é‚è¼¯ (åƒè€ƒä¸Šä¸€å€‹ç‰ˆæœ¬)"); }
  async function exportOtReport() { alert("è«‹åŒ¯å…¥å®Œæ•´çš„å ±è¡¨é‚è¼¯"); }
  async function exportLeaveReport() { alert("è«‹åŒ¯å…¥å®Œæ•´çš„å ±è¡¨é‚è¼¯"); }
  async function exportAnnualReport() { alert("è«‹åŒ¯å…¥å®Œæ•´çš„å ±è¡¨é‚è¼¯"); }

  // --- æ¬Šé™èˆ‡è³‡æ–™ç®¡ç† (é‡é»ä¿®æ”¹å€) ---
  
  // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
  async function loadUsers() { 
      const tbody = document.querySelector("#userTable tbody"); 
      tbody.innerHTML = "<tr><td colspan='5'>è®€å–ä¸­...</td></tr>"; 
      
      let q = db.collection('cams_users'); 
      if(myRole==='å¤–åŒ…è€é—†') q = q.where('company','==',myCompany); 
      
      const s = await q.get(); 
      tbody.innerHTML=""; 
      
      const roleOptions = (myRole==='ç®¡ç†è€…' || myRole==='ç”²æ–¹') 
        ? `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option><option value="å¤–åŒ…è€é—†">è€é—†</option><option value="ç”²æ–¹">ç”²æ–¹</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option>` 
        : `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option>`;

      s.forEach(doc => { 
          let u = doc.data();
          let shiftName = u.workShift === 'cleaning' ? 'æ¸…æ½”ç¾¤' : (u.workShift === 'maintenance' ? 'ç¶­è­·è¡Œæ”¿ç¾¤' : 'æœªè¨­å®š');
          
          let actionBtns = `
            <select id="role-${doc.id}" style="margin-right:5px; padding:4px;">${roleOptions}</select>
            <button class="btn-update" onclick="updateRole('${doc.id}')">è®Šæ›´è§’è‰²</button>
          `;
          
          // â˜… åªæœ‰ ç®¡ç†è€… æˆ– ç”²æ–¹ å¯ä»¥ç·¨è¼¯è©³ç´°è³‡æ–™
          if(myRole === 'ç®¡ç†è€…' || myRole === 'ç”²æ–¹') {
              actionBtns += `<button class="btn-edit-info" onclick="openEditModal('${doc.id}')">ç·¨è¼¯è³‡æ–™</button>`;
          }

          tbody.innerHTML += `
            <tr>
                <td>${u.name}</td>
                <td>${u.company}<br><small>${u.dept||''}</small></td>
                <td>${shiftName}</td>
                <td style="color:blue">${u.role}</td>
                <td>${actionBtns}</td>
            </tr>`; 
          
          // è¨­å®šä¸‹æ‹‰é¸å–®é è¨­å€¼
          setTimeout(() => { if(document.getElementById(`role-${doc.id}`)) document.getElementById(`role-${doc.id}`).value = u.role; }, 0);
      }); 
  }

  async function updateRole(id) { 
      await db.collection('cams_users').doc(id).update({role:document.getElementById(`role-${id}`).value}); 
      alert("æ¬Šé™æ›´æ–°æˆåŠŸ"); loadUsers(); 
  }

  // --- â˜… ç·¨è¼¯è³‡æ–™ Modal ç›¸é—œå‡½å¼ â˜… ---
  
  async function openEditModal(id) {
      // è®€å–è©²ç”¨æˆ¶è³‡æ–™
      const doc = await db.collection('cams_users').doc(id).get();
      if(!doc.exists) return;
      const u = doc.data();

      document.getElementById('editUserId').value = id;
      document.getElementById('editName').value = u.name || "";
      document.getElementById('editCompany').value = u.company || "";
      document.getElementById('editDept').value = u.dept || "";
      document.getElementById('editOnboardDate').value = u.onboardDate || "";
      document.getElementById('editShift').value = u.workShift || "maintenance"; // é è¨­ç¶­è­·ç¾¤

      // é¡¯ç¤º Modal
      document.getElementById('editUserModal').classList.remove('hidden');
  }

  function closeEditModal() {
      document.getElementById('editUserModal').classList.add('hidden');
  }

  async function saveUserEdit() {
      const id = document.getElementById('editUserId').value;
      const newData = {
          name: document.getElementById('editName').value,
          company: document.getElementById('editCompany').value,
          dept: document.getElementById('editDept').value,
          onboardDate: document.getElementById('editOnboardDate').value,
          workShift: document.getElementById('editShift').value
      };

      try {
          await db.collection('cams_users').doc(id).update(newData);
          alert("âœ… è³‡æ–™ä¿®æ”¹æˆåŠŸï¼");
          closeEditModal();
          loadUsers(); // é‡æ–°æ•´ç†åˆ—è¡¨
      } catch(e) {
          alert("âŒ å¤±æ•—: " + e.message);
      }
  }

  // --- æ´¾å·¥èˆ‡å¯©æ ¸ (ç¶­æŒåŸæ¨£) ---
  function setupRoleSelect(role) {
      const s = document.getElementById('reviewRoleSelect'); s.innerHTML = "";
      if(role === 'ç®¡ç†è€…') s.innerHTML += `<option value="client">ç”²æ–¹</option><option value="boss">è€é—†</option>`;
      else if(role === 'ç”²æ–¹') s.innerHTML += `<option value="client">ç”²æ–¹</option>`;
      else if(role === 'å¤–åŒ…è€é—†') s.innerHTML += `<option value="boss">è€é—†</option>`;
  }

  async function loadReviewData() {
    const role = document.getElementById('reviewRoleSelect').value;
    const tL = document.querySelector("#leaveTable tbody");
    const tO = document.querySelector("#otTable tbody");
    const tF = document.querySelector("#fixTable tbody");
    tL.innerHTML="<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>"; tO.innerHTML="<tr><td colspan='5'>è¼‰å…¥ä¸­...</td></tr>"; tF.innerHTML="<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>";
    
    if(!role) return;
    let query = db.collection('cams_applications').orderBy('createdAt', 'desc').limit(50);
    if (myRole === 'å¤–åŒ…è€é—†') query = query.where('company', '==', myCompany);
    
    const snap = await query.get();
    tL.innerHTML=""; tO.innerHTML=""; tF.innerHTML="";
    
    snap.forEach(doc => {
        let d = doc.data(); let id = doc.id; let st = d.status;
        const genBtns = (can) => can ? `<button class="btn-approve" onclick="review('${id}','${role}','åŒæ„')">åŒæ„</button><button class="btn-reject" onclick="review('${id}','${role}','é€€å›')">é€€å›</button>` : `<span>${st[role]}</span>`;
        
        // å¯©æ ¸é‚è¼¯ (ç¶­æŒåŸæ¨£)
        if(d.category === 'leave') {
            let can = false;
            if(role==='boss' && (st.leader==='åŒæ„' || st.leader==='ä¸éœ€') && st.boss==='å¾…å¯©æ ¸') can=true;
            if(role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') can=true;
            if(myRole==='ç®¡ç†è€…' && st[role]==='å¾…å¯©æ ¸') can=true;
            tL.innerHTML += `<tr><td>${d.name}</td><td>${d.agentName}</td><td>${d.type}</td><td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td><td><small>ä»£:${st.agent} é ˜:${st.leader} è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        } else if(d.category === 'overtime') { // ... çœç•¥åŠ ç­é¡¯ç¤ºé‚è¼¯ ...
             let can = false; if(myRole==='ç®¡ç†è€…' || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (role==='boss' && st.employee==='åŒæ„' && st.boss==='å¾…å¯©æ ¸')) can=true;
             tO.innerHTML += `<tr><td>${d.name}</td><td>${d.reason}</td><td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td><td><small>è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        } else if(d.category === 'correction') { // ... çœç•¥è£œå¡é¡¯ç¤ºé‚è¼¯ ...
             let can = false; if(myRole==='ç®¡ç†è€…' || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (role==='boss' && st.boss==='å¾…å¯©æ ¸')) can=true;
             tF.innerHTML += `<tr><td>${d.name}</td><td>${d.type}</td><td>${d.startDate.replace('T',' ')}</td><td>${d.reason}</td><td><small>è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        }
    });
  }

  async function review(id, role, decision) {
      if(!confirm(`ç¢ºå®š ${decision}ï¼Ÿ`)) return;
      const docRef = db.collection('cams_applications').doc(id);
      await db.runTransaction(async (t) => {
          const doc = await t.get(docRef);
          const d = doc.data();
          if(role==='client' && decision==='åŒæ„') {
              if(d.category==='leave' && d.type==='ç‰¹ä¼‘') {
                  const uRef = db.collection('cams_users').doc(d.email);
                  const u = await t.get(uRef);
                  t.update(uRef, { leaveUsed: (u.data().leaveUsed||0) + (d.duration||0) });
              }
              // è£œå¡æ ¸å‡†å¯«å…¥ç´€éŒ„
              if(d.category==='correction') {
                  let type = d.type.replace("è£œå¡-","");
                  t.set(db.collection('cams_records').doc(), { userId: d.userId, name: d.name, email: d.email, company: d.company, dept: d.dept, type: type, status: "è£œå¡", time: new Date(d.startDate), lat:0, lng:0 });
              }
          }
          let update={}; update[`status.${role}`] = decision;
          t.update(docRef, update);
      });
      alert("å·²æ›´æ–°"); loadReviewData();
  }

  async function createAssignment() { /* ...æ´¾å·¥é‚è¼¯ç¶­æŒåŸæ¨£... */ }
  async function loadEmployees(comp) { /* ...è¼‰å…¥å“¡å·¥é‚è¼¯ç¶­æŒåŸæ¨£... */ 
      const sel = document.getElementById('assignEmployee'); sel.innerHTML = ""; 
      const snap = await db.collection('cams_users').where('company','==',comp).get(); 
      snap.forEach(d => sel.innerHTML += `<option value="${d.data().email}">${d.data().name}</option>`); 
  }

  function setAssignDefaultTime() {
    const now = new Date();
    const ymd = now.toLocaleDateString('en-CA');
    document.getElementById('assignStart').value = ymd + "T08:00";
    document.getElementById('assignEnd').value = ymd + "T16:30";
  }

  function switchTab(t) { 
    ['review','assign','report','users'].forEach(i => {
        document.getElementById('tab-'+i).classList.add('hidden');
        document.getElementById('tab-btn-'+i).classList.remove('active'); 
    }); 
    document.getElementById('tab-'+t).classList.remove('hidden'); 
    document.getElementById('tab-btn-'+t).classList.add('active'); 

    if(t==='users') loadUsers(); 
    if(t==='assign') setAssignDefaultTime(); 
  }
</script>
</body>
</html>
