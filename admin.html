<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é›»å» ç®¡ç†å¾Œå°</title>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; margin:0; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; min-height: 85vh; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #1a73e8; font-weight: 800; margin-bottom: 25px; } 
    .hidden { display: none !important; }
    
    /* --- è¡¨æ ¼æ¨£å¼ --- */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: center; } 
    th { background: #f8fafc; color: #475569; font-weight: bold; border-bottom: 2px solid #e2e8f0; }
    tr:hover { background-color: #f8fafc; }
    
    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    button { cursor: pointer; transition: 0.2s; border: none; font-family: inherit; font-weight: bold; }
    button:active { transform: scale(0.98); }
    button:disabled { background: #ccc !important; cursor: not-allowed; }

    .btn-approve { background: #10b981; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-reject { background: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-update { background: #0ea5e9; color: white; padding: 6px 15px; border-radius: 6px; margin-right: 5px; }
    .btn-edit-info { background: #f59e0b; color: white; padding: 6px 12px; border-radius: 6px; }
    .btn-export { background: #f97316; color: white; padding: 8px 15px; border-radius: 6px; }
    .btn-close { background: #64748b; color: white; padding: 8px 20px; border-radius: 6px; }
    
    /* å¤§æŒ‰éˆ• */
    .btn-create { 
        background: linear-gradient(135deg, #6366f1, #4f46e5); 
        color: white; padding: 12px 24px; border-radius: 8px; font-size: 16px; 
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); width: 100%;
    }
    .btn-create:hover { box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3); }

    /* --- é¸å–® Tabs (æ·±è‰²é¢¨æ ¼) --- */
    .tabs { 
        display: flex; margin-bottom: 25px; background-color: #1e293b; 
        border-radius: 12px; overflow: hidden; padding: 4px;
    }
    .tab { 
        flex: 1; padding: 14px; text-align: center; cursor: pointer; 
        font-weight: bold; color: #cbd5e1; transition: 0.3s; border-radius: 8px;
    }
    .tab:hover { background-color: #334155; color: white; }
    .tab.active { background: white; color: #1e293b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* --- æ´¾å·¥å€ç¾åŒ– (é‡é»ä¿®æ”¹) --- */
    .assign-box { 
        border: 1px solid #e2e8f0; padding: 25px; border-radius: 12px; margin-bottom: 20px; background: #fff; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .assign-header { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px; border-left: 5px solid #6366f1; padding-left: 10px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-full { grid-column: span 2; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; font-size: 14px; }
    .form-group input, .form-group select { 
        width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 15px;
    }

    /* â˜…â˜…â˜… å“¡å·¥å¤šé¸æ¸…å–®æ¨£å¼ â˜…â˜…â˜… */
    .employee-selector {
        border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px; background: #f8fafc;
        max-height: 200px; overflow-y: auto;
    }
    .employee-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
    }
    .emp-checkbox {
        display: flex; align-items: center; gap: 8px; padding: 8px; 
        background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: 0.2s;
    }
    .emp-checkbox:hover { border-color: #6366f1; background: #eef2ff; }
    .emp-checkbox input { width: auto; margin: 0; }
    .select-all-btn { 
        font-size: 12px; color: #2563eb; cursor: pointer; margin-left: 10px; text-decoration: underline; 
    }

    /* --- å ±è¡¨å€ --- */
    .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .report-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .report-title { font-weight: bold; color: #333; margin-bottom: 15px; display: block; border-left: 4px solid #1a73e8; padding-left: 10px; font-size: 16px; }
    .filter-row { display: flex; flex-direction: column; gap: 10px; }

    /* --- Modal --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
    }
    .modal-box {
        background: white; padding: 30px; border-radius: 12px; width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-box h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    .modal-row input, .modal-row select { width: 100%; padding: 8px; box-sizing: border-box; border:1px solid #ccc; border-radius:4px;}
    .modal-actions { text-align: right; margin-top: 20px; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ é›»å» ç®¡ç†å¾Œå°</h2>
  <div id="login-section" style="text-align:center; padding:50px;">
    <button onclick="loginGoogle()" class="btn-create" style="width:auto;">ğŸ”µ Google ç®¡ç†å“¡ç™»å…¥</button>
  </div>

  <div id="main-section" class="hidden">
    <div style="text-align:right; margin-bottom:10px;">
        ç®¡ç†å“¡ï¼š<span id="my-name" style="font-weight:bold;"></span> 
        (<span id="my-role" style="color:#1a73e8;"></span>)
    </div>

    <div class="tabs">
      <div id="tab-btn-review" class="tab active" onclick="switchTab('review')">å¯©æ ¸ä½œæ¥­</div>
      <div id="tab-btn-assign" class="tab" onclick="switchTab('assign')">ç”²æ–¹æ´¾å·¥</div>
      <div id="tab-btn-report" class="tab" onclick="switchTab('report')">å ±è¡¨ä¸­å¿ƒ</div>
      <div id="tab-btn-users" class="tab" onclick="switchTab('users')">æ¬Šé™/è³‡æ–™ç®¡ç†</div>
    </div>

    <div id="tab-review">
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <span style="font-weight:bold;">ç•¶å‰å¯©æ ¸èº«åˆ†ï¼š</span>
                <select id="reviewRoleSelect" onchange="loadReviewData()" style="padding:6px; border-radius:4px; border:1px solid #ccc;"></select>
            </div>
            <button class="btn-update" onclick="loadReviewData()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        </div>
        
        <h3 style="border-left:4px solid #10b981; padding-left:10px;">è«‹å‡å¯©æ ¸</h3>
        <table id="leaveTable"><thead><tr><th>å§“å</th><th>ä»£ç†äºº</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        
        <h3 style="margin-top:30px; border-left:4px solid #6366f1; padding-left:10px;">åŠ ç­å¯©æ ¸</h3>
        <table id="otTable"><thead><tr><th>å§“å</th><th>äº‹ç”±</th><th>æ™‚é–“</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        
        <h3 style="margin-top:30px; border-left:4px solid #f59e0b; padding-left:10px;">è£œåˆ·å¡å¯©æ ¸</h3>
        <table id="fixTable"><thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ—¥æœŸæ™‚é–“</th><th>äº‹ç”±</th><th>é€²åº¦</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-assign" class="hidden">
        <div class="assign-box">
            <div class="assign-header">ğŸ“ æ–°å¢åŠ ç­æ´¾å·¥å–®</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>é¸æ“‡å» å•†</label>
                    <select id="assignCompany" onchange="loadEmployees(this.value)">
                        <option value="">è«‹å…ˆé¸æ“‡å…¬å¸...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>é¸æ“‡å“¡å·¥ (å¯å¤šé¸) <span class="select-all-btn" onclick="toggleSelectAll()">å…¨é¸/å–æ¶ˆ</span></label>
                    <div class="employee-selector">
                        <div id="assignEmployeeBox" class="employee-grid">
                            <div style="color:#999; text-align:center; padding:20px;">è«‹å…ˆé¸æ“‡å…¬å¸</div>
                        </div>
                    </div>
                </div>

                <div class="form-group form-full">
                    <label>åŠ ç­äº‹ç”±</label>
                    <input type="text" id="assignReason" placeholder="ä¾‹å¦‚ï¼šæ©Ÿçµ„å¹´åº¦æ­²ä¿®å”åŠ©">
                </div>

                <div class="form-group">
                    <label>é–‹å§‹æ™‚é–“</label>
                    <input type="datetime-local" id="assignStart">
                </div>
                <div class="form-group">
                    <label>çµæŸæ™‚é–“</label>
                    <input type="datetime-local" id="assignEnd">
                </div>
            </div>
            
            <button class="btn-create" onclick="createAssignment()">ğŸš€ é€å‡ºæ´¾å·¥å–® (æ‰¹æ¬¡ç™¼é€)</button>
        </div>
    </div>

    <div id="tab-report" class="hidden">
        <div class="report-grid">
            <div class="report-card">
                <span class="report-title">ğŸ“… æ¯æ—¥è€ƒå‹¤è¡¨</span>
                <div class="filter-row">
                    <label>å…¬å¸ï¼š <select class="rpt-comp"><option value="">å…¨éƒ¨</option></select></label>
                    <label>æœˆä»½ï¼š <input type="month" id="rptDate1"></label>
                    <button class="btn-export" onclick="exportAttendanceReport()">ğŸ“¥ åŒ¯å‡ºç´€éŒ„</button>
                </div>
            </div>
            <div class="report-card"><span class="report-title">ğŸ’° åŠ ç­çµ±è¨ˆè¡¨</span><div class="filter-row"><label>å…¬å¸ï¼š <select class="rpt-comp"></select></label><label>æœˆä»½ï¼š <input type="month" id="rptDate2"></label><button class="btn-export" onclick="exportOtReport()">ğŸ“¥ åŒ¯å‡ºæ˜ç´°</button></div></div>
            <div class="report-card"><span class="report-title">ğŸ¤’ è«‹å‡çµ±è¨ˆè¡¨</span><div class="filter-row"><label>å…¬å¸ï¼š <select class="rpt-comp"></select></label><label>æœˆä»½ï¼š <input type="month" id="rptDate3"></label><button class="btn-export" onclick="exportLeaveReport()">ğŸ“¥ åŒ¯å‡ºæ˜ç´°</button></div></div>
            <div class="report-card"><span class="report-title">ğŸŒ´ ç‰¹ä¼‘é¤˜é¡è¡¨</span><div class="filter-row"><label>å…¬å¸ï¼š <select class="rpt-comp"></select></label><label>åŸºæº–æ—¥ï¼š <input type="date" id="rptDate4"></label><button class="btn-export" onclick="exportAnnualReport()">ğŸ“¥ åŒ¯å‡ºé¤˜é¡</button></div></div>
        </div>
    </div>

    <div id="tab-users" class="hidden">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <div style="color:#666;">å¯ä¿®æ”¹å“¡å·¥è§’è‰²ã€åˆ°è·æ—¥èˆ‡ç¾¤çµ„è¨­å®š</div>
            <button class="btn-update" onclick="loadUsers()">ğŸ”„ åˆ·æ–°åå–®</button>
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å…¬å¸/éƒ¨é–€</th>
                    <th>ç¾¤çµ„ (ç­åˆ¥)</th>
                    <th>æ¬Šé™è§’è‰²</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

  </div> <div id="editUserModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>âœï¸ ç·¨è¼¯å“¡å·¥è³‡æ–™</h3>
        <input type="hidden" id="editUserId">
        <div class="modal-row"><label>å§“å</label><input type="text" id="editName"></div>
        <div class="modal-row"><label>å…¬å¸</label><input type="text" id="editCompany"></div>
        <div class="modal-row"><label>éƒ¨é–€</label><input type="text" id="editDept"></div>
        <div class="modal-row">
            <label>ç¾¤çµ„ (å½±éŸ¿ä¸‹ç­æ™‚é–“)</label>
            <select id="editShift">
                <option value="maintenance">ç¶­è­·è¡Œæ”¿ç¾¤ (08:00~16:30)</option>
                <option value="cleaning">æ¸…æ½”ç¾¤ (08:00~17:00)</option>
            </select>
        </div>
        <div class="modal-row"><label>åˆ°è·æ—¥</label><input type="date" id="editOnboardDate"></div>
        <div class="modal-actions">
            <button class="btn-close" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-update" onclick="saveUserEdit()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAQPANPPx5A3FtpISPcfX-kHPtG0PC6irA",
    authDomain: "jtpp-cams.firebaseapp.com",
    projectId: "jtpp-cams",
    storageBucket: "jtpp-cams.firebasestorage.app",
    messagingSenderId: "334286192470",
    appId: "1:334286192470:web:9080eb43436b3a3fdfe0f7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  let currentUser = null, myRole = "", myCompany = "";

  function loginGoogle() { auth.signInWithPopup(provider).catch(e => alert(e.message)); }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      const doc = await db.collection('cams_users').doc(user.email).get();
      if(doc.exists) { 
          const d = doc.data();
          myRole = d.role; myCompany = d.company; 
          if(myRole === 'å¤–åŒ…å“¡å·¥' || myRole === 'å¤–åŒ…é ˜ç­') { alert("æ¬Šé™ä¸è¶³"); window.location.href = "index.html"; return; }
      } else { myRole = "è¨ªå®¢"; }
      
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('my-name').innerText = user.displayName;
      document.getElementById('my-role').innerText = myRole;
      
      setupRoleSelect(myRole);
      loadCompanyList();
      loadReviewData();
      
      const ymd = new Date().toISOString().slice(0, 7);
      ['rptDate1','rptDate2','rptDate3'].forEach(id => document.getElementById(id).value = ymd);
      document.getElementById('rptDate4').value = new Date().toISOString().slice(0, 10);
    }
  });

  async function loadCompanyList() {
      const snap = await db.collection('cams_users').get();
      let s = new Set(); snap.forEach(d => { if(d.data().company) s.add(d.data().company); });
      let html = "<option value=''>è«‹é¸æ“‡</option>";
      let allHtml = "<option value=''>å…¨éƒ¨å…¬å¸</option>";
      s.forEach(c => { html += `<option value="${c}">${c}</option>`; allHtml += `<option value="${c}">${c}</option>`; });
      document.getElementById('assignCompany').innerHTML = html;
      document.querySelectorAll('.rpt-comp').forEach(el => el.innerHTML = allHtml);
  }

  // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè¼‰å…¥å“¡å·¥ç‚º Checkbox æ¸…å–® (å¤šé¸) â˜…â˜…â˜…
  async function loadEmployees(comp) {
      const container = document.getElementById('assignEmployeeBox');
      container.innerHTML = "è¼‰å…¥ä¸­...";
      
      if(!comp) { container.innerHTML = "<div style='text-align:center;padding:10px;color:#999'>è«‹å…ˆé¸æ“‡å» å•†</div>"; return; }

      const snap = await db.collection('cams_users').where('company', '==', comp).get();
      if(snap.empty) { container.innerHTML = "ç„¡å“¡å·¥è³‡æ–™"; return; }

      let html = "";
      snap.forEach(d => {
          const u = d.data();
          html += `
            <label class="emp-checkbox">
                <input type="checkbox" class="emp-select" value="${u.email}" data-name="${u.name}">
                <span>${u.name}</span>
            </label>`;
      });
      container.innerHTML = html;
  }

  function toggleSelectAll() {
      const all = document.querySelectorAll('.emp-select');
      if(all.length === 0) return;
      const firstState = all[0].checked; // æª¢æŸ¥ç¬¬ä¸€å€‹çš„ç‹€æ…‹
      all.forEach(cb => cb.checked = !firstState); // åé¸
  }

  // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ‰¹æ¬¡é€å‡ºæ´¾å·¥å–® â˜…â˜…â˜…
  async function createAssignment() {
      const reason = document.getElementById('assignReason').value;
      const start = document.getElementById('assignStart').value;
      const end = document.getElementById('assignEnd').value;
      const comp = document.getElementById('assignCompany').value;
      
      // å–å¾—æ‰€æœ‰è¢«å‹¾é¸çš„å“¡å·¥
      const checkedBoxes = document.querySelectorAll('.emp-select:checked');
      
      if(checkedBoxes.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½å“¡å·¥ï¼"); return; }
      if(!reason || !start || !end) { alert("è«‹å¡«å¯«å®Œæ•´äº‹ç”±èˆ‡æ™‚é–“"); return; }

      const btn = document.querySelector('.btn-create');
      btn.innerText = `æ­£åœ¨ç™¼é€ ${checkedBoxes.length} ç­†...`;
      btn.disabled = true;

      try {
          const promises = [];
          
          checkedBoxes.forEach(cb => {
              const email = cb.value;
              const name = cb.getAttribute('data-name');
              
              const task = db.collection('cams_applications').add({ 
                  category: 'overtime', 
                  type: 'åŠ ç­æ´¾å·¥', 
                  reason: reason, 
                  company: comp, 
                  email: email, 
                  userId: email, 
                  name: name, 
                  startDate: start, 
                  endDate: end, 
                  createdAt: new Date(), 
                  status: { employee: "å¾…ç¢ºèª", boss: "å¾…å¯©æ ¸", client: "å¾…å¯©æ ¸" } 
              });
              promises.push(task);
          });

          await Promise.all(promises);
          alert(`âœ… æˆåŠŸç™¼é€ ${checkedBoxes.length} ç­†æ´¾å·¥å–®ï¼`);
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('assignReason').value = "";
          // å–æ¶ˆå‹¾é¸
          checkedBoxes.forEach(cb => cb.checked = false);

      } catch(e) {
          alert("âŒ ç™¼é€å¤±æ•—: " + e.message);
      } finally {
          btn.innerText = "ğŸš€ é€å‡ºæ´¾å·¥å–® (æ‰¹æ¬¡ç™¼é€)";
          btn.disabled = false;
      }
  }

  function setAssignDefaultTime() {
    const now = new Date();
    // ä¿®æ­£æ™‚å€ offset
    const toLocalISO = (d) => {
        const z = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
        return z.toISOString().slice(0, 16); // å–åˆ°åˆ†é˜
    };
    
    // è¨­å®šé–‹å§‹æ™‚é–“ç‚ºä»Šå¤© 08:00
    const startD = new Date(now); startD.setHours(8,0,0,0);
    // è¨­å®šçµæŸæ™‚é–“ç‚ºä»Šå¤© 16:30
    const endD = new Date(now); endD.setHours(16,30,0,0);

    document.getElementById('assignStart').value = toLocalISO(startD);
    document.getElementById('assignEnd').value = toLocalISO(endD);
  }

  // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ ---
  async function loadUsers() { 
      const tbody = document.querySelector("#userTable tbody"); 
      tbody.innerHTML = "<tr><td colspan='5'>è®€å–ä¸­...</td></tr>"; 
      
      let q = db.collection('cams_users'); 
      if(myRole==='å¤–åŒ…è€é—†') q = q.where('company','==',myCompany); 
      
      const s = await q.get(); 
      tbody.innerHTML=""; 
      
      const roleOptions = (myRole==='ç®¡ç†è€…' || myRole==='ç”²æ–¹') 
        ? `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option><option value="å¤–åŒ…è€é—†">è€é—†</option><option value="ç”²æ–¹">ç”²æ–¹</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option>` 
        : `<option value="å¤–åŒ…å“¡å·¥">å“¡å·¥</option><option value="å¤–åŒ…é ˜ç­">é ˜ç­</option>`;

      s.forEach(doc => { 
          let u = doc.data();
          let shift = u.workShift === 'cleaning' ? 'æ¸…æ½”ç¾¤' : (u.workShift === 'maintenance' ? 'ç¶­è­·è¡Œæ”¿ç¾¤' : 'æœªè¨­å®š');
          
          let actionBtns = `
            <select id="role-${doc.id}" style="padding:4px;">${roleOptions}</select>
            <button class="btn-update" onclick="updateRole('${doc.id}')">è®Šæ›´</button>
          `;
          if(myRole === 'ç®¡ç†è€…' || myRole === 'ç”²æ–¹') {
              actionBtns += `<button class="btn-edit-info" onclick="openEditModal('${doc.id}')">ç·¨è¼¯</button>`;
          }

          tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.company}<br><small>${u.dept||''}</small></td><td>${shift}</td><td style="color:#1a73e8;font-weight:bold;">${u.role}</td><td>${actionBtns}</td></tr>`; 
          setTimeout(() => { if(document.getElementById(`role-${doc.id}`)) document.getElementById(`role-${doc.id}`).value = u.role; }, 0);
      }); 
  }

  async function updateRole(id) { 
      await db.collection('cams_users').doc(id).update({role:document.getElementById(`role-${id}`).value}); 
      alert("æ¬Šé™å·²æ›´æ–°"); loadUsers(); 
  }

  async function openEditModal(id) {
      const doc = await db.collection('cams_users').doc(id).get();
      if(!doc.exists) return;
      const u = doc.data();
      document.getElementById('editUserId').value = id;
      document.getElementById('editName').value = u.name || "";
      document.getElementById('editCompany').value = u.company || "";
      document.getElementById('editDept').value = u.dept || "";
      document.getElementById('editOnboardDate').value = u.onboardDate || "";
      document.getElementById('editShift').value = u.workShift || "maintenance";
      document.getElementById('editUserModal').classList.remove('hidden');
  }
  function closeEditModal() { document.getElementById('editUserModal').classList.add('hidden'); }
  async function saveUserEdit() {
      const id = document.getElementById('editUserId').value;
      await db.collection('cams_users').doc(id).update({
          name: document.getElementById('editName').value,
          company: document.getElementById('editCompany').value,
          dept: document.getElementById('editDept').value,
          onboardDate: document.getElementById('editOnboardDate').value,
          workShift: document.getElementById('editShift').value
      });
      alert("è³‡æ–™å·²æ›´æ–°"); closeEditModal(); loadUsers();
  }

  function setupRoleSelect(role) {
      const s = document.getElementById('reviewRoleSelect'); s.innerHTML = "";
      if(role === 'ç®¡ç†è€…') s.innerHTML += `<option value="client">ç”²æ–¹</option><option value="boss">è€é—†</option>`;
      else if(role === 'ç”²æ–¹') s.innerHTML += `<option value="client">ç”²æ–¹</option>`;
      else if(role === 'å¤–åŒ…è€é—†') s.innerHTML += `<option value="boss">è€é—†</option>`;
  }

  async function loadReviewData() {
    const role = document.getElementById('reviewRoleSelect').value;
    const tL = document.querySelector("#leaveTable tbody");
    const tO = document.querySelector("#otTable tbody");
    const tF = document.querySelector("#fixTable tbody");
    tL.innerHTML="<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>"; tO.innerHTML="<tr><td colspan='5'>è¼‰å…¥ä¸­...</td></tr>"; tF.innerHTML="<tr><td colspan='6'>è¼‰å…¥ä¸­...</td></tr>";
    
    if(!role) return;
    let query = db.collection('cams_applications').orderBy('createdAt', 'desc').limit(50);
    if (myRole === 'å¤–åŒ…è€é—†') query = query.where('company', '==', myCompany);
    
    const snap = await query.get();
    tL.innerHTML=""; tO.innerHTML=""; tF.innerHTML="";
    
    snap.forEach(doc => {
        let d = doc.data(); let id = doc.id; let st = d.status;
        const genBtns = (can) => can ? `<button class="btn-approve" onclick="review('${id}','${role}','åŒæ„')">åŒæ„</button><button class="btn-reject" onclick="review('${id}','${role}','é€€å›')">é€€å›</button>` : `<span>${st[role]}</span>`;
        if(d.category === 'leave') {
            let can = (role==='boss' && (st.leader==='åŒæ„' || st.leader==='ä¸éœ€') && st.boss==='å¾…å¯©æ ¸') || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (myRole==='ç®¡ç†è€…' && st[role]==='å¾…å¯©æ ¸');
            tL.innerHTML += `<tr><td>${d.name}</td><td>${d.agentName}</td><td>${d.type}</td><td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td><td><small>ä»£:${st.agent} é ˜:${st.leader} è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        } else if(d.category === 'overtime') {
             let can = (myRole==='ç®¡ç†è€…' || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (role==='boss' && st.employee==='åŒæ„' && st.boss==='å¾…å¯©æ ¸'));
             tO.innerHTML += `<tr><td>${d.name}</td><td>${d.reason}</td><td><small>${d.startDate.replace('T',' ')}<br>~${d.endDate.split('T')[1]}</small></td><td><small>è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        } else if(d.category === 'correction') {
             let can = (myRole==='ç®¡ç†è€…' || (role==='client' && st.boss==='åŒæ„' && st.client==='å¾…å¯©æ ¸') || (role==='boss' && st.boss==='å¾…å¯©æ ¸'));
             tF.innerHTML += `<tr><td>${d.name}</td><td>${d.type}</td><td>${d.startDate.replace('T',' ')}</td><td>${d.reason}</td><td><small>è€:${st.boss} ç”²:${st.client}</small></td><td>${genBtns(can)}</td></tr>`;
        }
    });
  }

  async function review(id, role, decision) {
      if(!confirm(`ç¢ºå®š ${decision}ï¼Ÿ`)) return;
      const docRef = db.collection('cams_applications').doc(id);
      await db.runTransaction(async (t) => {
          const doc = await t.get(docRef);
          const d = doc.data();
          if(role==='client' && decision==='åŒæ„') {
              if(d.category==='leave' && d.type==='ç‰¹ä¼‘') {
                  const uRef = db.collection('cams_users').doc(d.email);
                  const u = await t.get(uRef);
                  t.update(uRef, { leaveUsed: (u.data().leaveUsed||0) + (d.duration||0) });
              }
              if(d.category==='correction') {
                  let type = d.type.replace("è£œå¡-","");
                  t.set(db.collection('cams_records').doc(), { userId: d.userId, name: d.name, email: d.email, company: d.company, dept: d.dept, type: type, status: "è£œå¡", time: new Date(d.startDate), lat:0, lng:0 });
              }
          }
          let update={}; update[`status.${role}`] = decision;
          t.update(docRef, update);
      });
      alert("å·²æ›´æ–°"); loadReviewData();
  }

  async function exportAttendanceReport() { alert("å ±è¡¨åŒ¯å‡ºåŠŸèƒ½éœ€ä¾éœ€æ±‚å¯¦ä½œ (è«‹åƒè€ƒå®Œæ•´ç‰ˆ)"); }
  async function exportOtReport() { alert("å ±è¡¨åŒ¯å‡ºåŠŸèƒ½éœ€ä¾éœ€æ±‚å¯¦ä½œ"); }
  async function exportLeaveReport() { alert("å ±è¡¨åŒ¯å‡ºåŠŸèƒ½éœ€ä¾éœ€æ±‚å¯¦ä½œ"); }
  async function exportAnnualReport() { alert("å ±è¡¨åŒ¯å‡ºåŠŸèƒ½éœ€ä¾éœ€æ±‚å¯¦ä½œ"); }

  function switchTab(t) { 
    ['review','assign','report','users'].forEach(i => {
        document.getElementById('tab-'+i).classList.add('hidden');
        document.getElementById('tab-btn-'+i).classList.remove('active'); 
    }); 
    document.getElementById('tab-'+t).classList.remove('hidden'); 
    document.getElementById('tab-btn-'+t).classList.add('active'); 
    if(t==='users') loadUsers(); 
    if(t==='assign') setAssignDefaultTime(); 
  }
</script>
</body>
</html>
