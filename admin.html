<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #333; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f2f2f2; }
    
    .btn-approve { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    .btn-reject { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    .btn-approve:hover { background: #218838; }
    
    .hidden { display: none; }
    .role-select { margin-bottom: 20px; text-align: center; padding: 10px; background: #e9ecef; border-radius: 5px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div class="container">
  <h2>ğŸ“‹ å¾Œå°ç®¡ç†ç³»çµ±</h2>
  
  <div id="login-section" style="text-align:center;">
    <p>è«‹ç®¡ç†å“¡ç™»å…¥</p>
    <div id="g_id_onload"
         data-client_id="1066125366380-tarq5fktrgap3cp3karp2ednbl6vk6n0.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <div id="admin-panel" class="hidden">
    <div class="role-select">
        <label>æˆ‘æ˜¯ï¼š</label>
        <select id="currentRole">
            <option value="agent">ä»£ç†äºº</option>
            <option value="leader">é ˜ç­</option>
            <option value="boss">è€é—†</option>
            <option value="client" selected>ç”²æ–¹(é›»å» )</option>
        </select>
        <button onclick="loadData()">ğŸ”„ é‡æ–°æ•´ç†åˆ—è¡¨</button>
    </div>

    <h3>è«‹å‡å¯©æ ¸</h3>
    <table id="leaveTable">
        <thead>
            <tr><th>å§“å</th><th>å‡åˆ¥</th><th>æ™‚é–“</th><th>ç›®å‰ç‹€æ…‹</th><th>å¯©æ ¸</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3 style="margin-top:40px;">åŠ ç­å¯©æ ¸</h3>
    <table id="otTable">
        <thead>
            <tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>ç›®å‰ç‹€æ…‹</th><th>å¯©æ ¸</th></tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // â˜…â˜…â˜… æ›æˆä½ çš„ /exec ç¶²å€ â˜…â˜…â˜…
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyr7jZP4BARKdsGYccRYWnrIQs7kvPvyqLqw-ptiqTr5jF4j695iM9m01tsBhtV6ISj0g/exec";
  let token = null;

  function handleCredentialResponse(res) {
    token = res.credential;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('admin-panel').classList.remove('hidden');
    loadData();
  }

  function loadData() {
    fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "getAdminData", credential: token }) })
    .then(r => r.json())
    .then(res => {
        if(res.success) {
            renderTable('leaveTable', res.data.leave, 'leave');
            renderTable('otTable', res.data.overtime, 'overtime');
        } else {
            alert(res.message);
        }
    });
  }

  function renderTable(tableId, data, category) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = "";
    data.forEach(item => {
        // ç°¡å–®é¡¯ç¤ºç›®å‰å„ç´šç‹€æ…‹
        let statusText = `
           <small>ä»£:${item.agent}</small> <small>é ˜:${item.leader}</small><br>
           <small>è€:${item.boss}</small> <small style="color:blue">ç”²:${item.client}</small>
        `;
        
        // å¦‚æœç›®å‰èº«åˆ†å·²ç¶“å¯©æ ¸éï¼Œå°±é¡¯ç¤ºæ–‡å­—ï¼Œä¸ç„¶é¡¯ç¤ºæŒ‰éˆ•
        let role = document.getElementById('currentRole').value;
        let myStatus = item[role]; // å–å¾—ç›®å‰èº«åˆ†é‚£ä¸€æ¬„çš„ç‹€æ…‹ (ä¾‹å¦‚ item.client)
        
        let actionBtns = "";
        if(myStatus === 'å¾…å¯©æ ¸') {
            actionBtns = `
                <button class="btn-approve" onclick="review('${category}', ${item.id}, 'åŒæ„')">åŒæ„</button>
                <button class="btn-reject" onclick="review('${category}', ${item.id}, 'é€€å›')">é€€å›</button>
            `;
        } else {
            actionBtns = `<span>${myStatus}</span>`;
        }

        let row = `<tr>
            <td>${item.name}</td>
            <td>${item.type}</td>
            <td><small>${item.start.replace('T',' ')}<br>~<br>${item.end.replace('T',' ')}</small></td>
            <td>${statusText}</td>
            <td>${actionBtns}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
  }

  function review(category, id, decision) {
    let role = document.getElementById('currentRole').value;
    if(!confirm(`ç¢ºå®šè¦ä»¥ [${role}] èº«åˆ† [${decision}] å—ï¼Ÿ`)) return;

    fetch(GAS_URL, { 
        method: "POST", 
        body: JSON.stringify({ 
            action: "reviewRequest", 
            credential: token,
            category: category,
            id: id,
            role: role,
            decision: decision
        }) 
    })
    .then(r => r.json())
    .then(res => {
        alert(res.message);
        loadData(); // é‡æ–°æ•´ç†
    });
  }
</script>
</body>
</html>
